#!/bin/sh

. $(dirname "$0")/base.sh

usage () {
    cat 1>&2 <<EOF

Unmount a Charliecloud image at the given mount point.

Usage:

  $ $(basename $0) MOUNTPOINT

This script is intended for use by system administrators, not end users.
Arguments are not sanitized.

EOF
    exit 1
}

if [ "$#" -ne 1 -o "$1" = '--help' ]; then
    usage
fi

MOUNTPOINT="$1"

set -e

if ( umount --help | fgrep -q -- --recursive ); then
    # umount has --recursive; use that
    echo "unmounting $MOUNTPOINT with umount --recursive"
    umount --recursive "$MOUNTPOINT"
else
    # emulate umount --recursive
    # FIXME: this should be removed when no longer needed
    echo "unmounting $MOUNTPOINT with manual recursion (your umount is old)"
    for d in $(findmnt -o target --list -Rn "$MOUNTPOINT" | tac); do
        umount $d
    done
fi

# This should have no output
findmnt -R -o target,fstype,propagation "$MOUNTPOINT"
