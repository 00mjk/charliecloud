#!/bin/sh

libexec=$(cd "$(dirname "$0")" && pwd)/../libexec/charliecloud
. "${libexec}/base.sh"

set -e

# shellcheck disable=SC2034
usage=$( cat << EOF

Pull image from a Docker Hub and flatten into tarball.

Usage:

  $ $(basename "$0") IMAGE DEST

You must have sufficient privilege (via sudo) to run Docker commands.
EOF
)

parse_basic_args "$@"

if [ "$#" -lt 2 ]; then
    usage
fi

image=$1
dest=$2
tar=$(readlink -f "$dest")/$(tag_to_path "$image").tar
tar_gzipped=${tar}.gz

puller_choose () {
    if [ -z "$CH_PULLER" ]; then
        if ( command -v docker >/dev/null 2>&1 ); then
            export CH_PULLER=docker
        elif ( command -v skopeo >/dev/null 2>&1 ); then
            export CH_PULLER=skopeo
        else
            echo "docker or skopeo needed to pull image. Neither was found." 1>&2
            exit 65
        fi
    fi
    case $CH_PULLER in
        docker|skopeo)
            ;;
        *)
            echo "unknown puller: $CH_PULLER" 1>&2
            exit 1
            ;;
    esac
}

while [ $# -gt 0 ]; do
    opt=$1; shift
    case $opt in 
        -p|--pull-with) 
            export CH_PULLER=$1
        ;;
    esac
done

puller_choose

if [ "$CH_PULLER" = "docker" ]; then
    docker_ pull "$image"
    # shellcheck disable=SC2154
    "${ch_bin}/ch-builder2tar" -b docker "$image" "$dest"
elif [ "$CH_PULLER" = "skopeo" ]; then 
    temp=$(mktemp -d --tmpdir ch-pull2tar.XXXXXX)
    skopeo copy "docker://${image}" "oci:${temp}/oci:${image}"
    umoci unpack --rootless --image "${temp}/oci:${image}" "${temp}/img"
    ( cd "${temp}/img/rootfs"; tar cf "${tar}" -- *; pv_ < "$tar" | gzip_ -6 > "$tar_gzipped" )
    echo "compressing skopeo"
    rm "$tar"
    rm -rf  --one-file-system "$temp"
fi
