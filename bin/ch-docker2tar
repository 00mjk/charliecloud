#!/bin/sh

. $(dirname "$0")/base.sh

set -e
#set -x

usage () {
    cat 1>&2 <<EOF

Flattens a Docker image into a tarball suitable for further processing
into a Charliecloud chroot image.

Usage:

  $ $(basename $0) IMAGE OUTDIR

You must have sufficient privilege to run the docker commands.

EOF
    exit 1
}

if [ "$#" -ne 2 -o "$1" = "--help" ]; then
    usage
fi
IMAGE=$1
OUTDIR=$2
TAR=$OUTDIR/$(echo $IMAGE | sed 's/\//./').tar.gz

cid=$($DOCKER create --read-only $IMAGE)
$DOCKER ps -af "id=$cid"
$DOCKER export $cid | gzip -6 > $TAR
$DOCKER rm $cid > /dev/null
ls -lh $TAR

