

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Testing &mdash; Charliecloud 0.9.4 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Tutorial" href="tutorial.html" />
    <link rel="prev" title="1. Installation" href="install.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Charliecloud
          

          
            
            <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                25b5fd4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">2.1. Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#phases">2.2. Phases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build">2.2.1. Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">2.2.2. Run</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">2.2.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#scope-speed-vs-thoroughness">2.3. Scope (speed vs. thoroughness)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generally">2.3.1. Generally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-a-single-test-group">2.3.2. Running a single test group</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="command-usage.html">4. Charliecloud command reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="vm.html">5. Pre-installed virtual machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">6. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">7. Contributor’s guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>2. Testing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing">
<span id="install-test-charliecloud"></span><h1>2. Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h1>
<p>Charliecloud comes with a fairly comprehensive Bats test suite. This section
explains how the tests work and how to run them.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#getting-started" id="id1">Getting started</a></li>
<li><a class="reference internal" href="#phases" id="id2">Phases</a><ul>
<li><a class="reference internal" href="#build" id="id3">Build</a></li>
<li><a class="reference internal" href="#run" id="id4">Run</a></li>
<li><a class="reference internal" href="#examples" id="id5">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scope-speed-vs-thoroughness" id="id6">Scope (speed vs. thoroughness)</a><ul>
<li><a class="reference internal" href="#generally" id="id7">Generally</a></li>
<li><a class="reference internal" href="#running-a-single-test-group" id="id8">Running a single test group</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="getting-started">
<h2><a class="toc-backref" href="#id1">2.1. Getting started</a><a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>Charliecloud’s tests are based in the directory <code class="code docutils literal notranslate"><span class="pre">test</span></code>, which is either
at the top level of the source code or installed at
<code class="code docutils literal notranslate"><span class="pre">$PREFIX/share/doc/charliecloud</span></code>. To run them, go there:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> <span class="nb">test</span>
</pre></div>
</div>
<p>The tests use a framework called <a class="reference external" href="https://github.com/sstephenson/bats">Bats</a>
(Bash Automated Testing System). To check location and version of Bats used by
the tests:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> make where-bats
<span class="go">which bats</span>
<span class="go">/usr/bin/bats</span>
<span class="go">bats --version</span>
<span class="go">Bats 0.4.0</span>
</pre></div>
</div>
<p>Just like for normal use, the Charliecloud test suite is split into build and
run phases, and there is a third phase that runs the examples’ test suites.
These phases can be tested independently on different systems.</p>
<p>Testing is coordinated by <code class="code docutils literal notranslate"><span class="pre">make</span></code>. The test targets run one or more test
suites. If any test suite has a failure, testing stops with an error message.</p>
<p>The tests need three work directories with a dozen or so GB of available
space, in order to store image tarballs, unpacked image directories, and
permission test fixtures. These are configured with environment variables; for
example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_TARDIR</span><span class="o">=</span>/var/tmp/tarballs
<span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_IMGDIR</span><span class="o">=</span>/var/tmp/images
<span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_PERMDIRS</span><span class="o">=</span><span class="s1">&#39;/var/tmp /tmp&#39;</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">CH_TEST_PERMDIRS</span></code> can be set to <code class="code docutils literal notranslate"><span class="pre">skip</span></code> in order to skip the file
permissions tests.</p>
<p>(Strictly speaking, the build phase needs only the first, and the example test
phase does not need the last one. However, for simplicity, the tests will
demand all three for all phases.)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Bats will wait until all descendant processes finish before exiting, so if
you get into a failure mode where a test suite doesn’t clean up all its
processes, Bats will hang.</p>
</div>
</div>
<div class="section" id="phases">
<h2><a class="toc-backref" href="#id2">2.2. Phases</a><a class="headerlink" href="#phases" title="Permalink to this headline">¶</a></h2>
<p>To run all three phases:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nb">test</span>
</pre></div>
</div>
<p>We recommend that a build box pass all phases so it can be used to run
containers for testing and development.</p>
<div class="section" id="build">
<h3><a class="toc-backref" href="#id3">2.2.1. Build</a><a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h3>
<p>In this phase, image building and associated functionality is tested.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> make test-build
<span class="go">bats build.bats build_auto.bats build_post.bats</span>
<span class="go"> ✓ create tarball directory if needed</span>
<span class="go"> ✓ documentations build</span>
<span class="go"> ✓ executables seem sane</span>
<span class="go">[...]</span>
<span class="go"> ✓ ch-build obspy</span>
<span class="go"> ✓ ch-docker2tar obspy</span>
<span class="go"> ✓ docker pull dockerpull</span>
<span class="go"> ✓ ch-docker2tar dockerpull</span>
<span class="go"> ✓ nothing unexpected in tarball directory</span>

<span class="go">41 tests, 0 failures</span>
</pre></div>
</div>
<p>Note that this phase is much faster with a hot Docker cache.</p>
<p>To refresh the images, you sometimes need to clear the Docker cache. You can
do this with <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean-docker</span></code>. This requires sudo privileges and
deletes all Docker containers and images, whether or not they are related to
the Charliecloud test suite.</p>
</div>
<div class="section" id="run">
<h3><a class="toc-backref" href="#id4">2.2.2. Run</a><a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>The run tests require the contents of <code class="code docutils literal notranslate"><span class="pre">$CH_TEST_TARDIR</span></code> produced by a
successful build test. Copy this directory to the run system.</p>
<p>Additionally, the user running the tests needs to be a member of at least 2
groups.</p>
<p>File permission enforcement is tested against specially constructed fixture
directories. These should include every meaningful mounted filesystem, and
they cannot be shared between different users. To create them:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="k">for</span> d in <span class="nv">$CH_TEST_PERMDIRS</span><span class="p">;</span> <span class="k">do</span> sudo ./make-perms-test <span class="nv">$d</span> <span class="nv">$USER</span> nobody<span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
<p>To skip testing file permissions (e.g., if you don’t have root), set
<code class="code docutils literal notranslate"><span class="pre">$CH_TEST_PERMDIRS</span></code> to <code class="code docutils literal notranslate"><span class="pre">skip</span></code>.</p>
<p>To run these tests:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> make test-run
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h3><a class="toc-backref" href="#id5">2.2.3. Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>Some of the examples include test suites of their own. Charliecloud runs those
test suites, using a Slurm allocation if one is available or a single node
(localhost) if not.</p>
<p>These require that the run tests have been completed successfully.</p>
<p>Note that single tests from the Charliecloud perspective can include entire
test suites from the example’s perspective, so be patient.</p>
<p>To run these tests:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> make test-test
</pre></div>
</div>
</div>
</div>
<div class="section" id="scope-speed-vs-thoroughness">
<h2><a class="toc-backref" href="#id6">2.3. Scope (speed vs. thoroughness)</a><a class="headerlink" href="#scope-speed-vs-thoroughness" title="Permalink to this headline">¶</a></h2>
<div class="section" id="generally">
<h3><a class="toc-backref" href="#id7">2.3.1. Generally</a><a class="headerlink" href="#generally" title="Permalink to this headline">¶</a></h3>
<p>The test suite can be abbreviated or extended by setting the environment
variable <code class="code docutils literal notranslate"><span class="pre">CH_TEST_SCOPE</span></code>. The valid values are:</p>
<dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">quick</span></code></dt>
<dd><p class="first">This tests the most important subset of Charliecloud functionality. With a
hot Docker cache, <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> should finish in under 30 seconds. It’s
handy for development.</p>
<p class="last"><strong>Note:</strong> The <code class="code docutils literal notranslate"><span class="pre">quick</span></code> scope uses the results of a prior successful
completion of the <code class="code docutils literal notranslate"><span class="pre">standard</span></code> scope.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">standard</span></code></dt>
<dd><p class="first">This adds testing of the remaining Charliecloud functionality and a
selection of the more important examples. It should finish in 5–10 minutes.</p>
<p class="last">This is the default if <code class="code docutils literal notranslate"><span class="pre">CH_TEST_SCOPE</span></code> is unset.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">full</span></code></dt>
<dd>Run all available tests. It can take 30–60 minutes or more.</dd>
</dl>
<p>For example, to run the build tests in quick mode, say:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nv">CH_TEST_SCOPE</span><span class="o">=</span>quick make test-build
</pre></div>
</div>
</div>
<div class="section" id="running-a-single-test-group">
<h3><a class="toc-backref" href="#id8">2.3.2. Running a single test group</a><a class="headerlink" href="#running-a-single-test-group" title="Permalink to this headline">¶</a></h3>
<p>For focused testing, you can run a single <code class="code docutils literal notranslate"><span class="pre">.bats</span></code> file directly with
Bats. These are found at the following locations:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">test</span>
<span class="go">test/run</span>
<span class="go">examples/*/*/test.bats</span>
</pre></div>
</div>
<p>First, check which <code class="code docutils literal notranslate"><span class="pre">bats</span></code> executable the test suite is using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> make where-bats
<span class="go">which bats</span>
<span class="go">/usr/local/src/charliecloud/test/bats/bin/bats</span>
<span class="go">bats --version</span>
<span class="go">Bats 0.4.0</span>
</pre></div>
</div>
<p>Then, use that <code class="code docutils literal notranslate"><span class="pre">bats</span></code> to run the file you’re interested in. For example,
you can test the <code class="code docutils literal notranslate"><span class="pre">mpihello</span></code> example with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> examples/mpi/mpihello
<span class="gp">$</span> /usr/local/src/charliecloud/test/bats/bin/bats test.bats
<span class="go"> ✓ mpihello/serial</span>
<span class="go"> ✓ mpihello/guest starts ranks</span>
<span class="go"> ✓ mpihello/host starts ranks</span>

<span class="go">3 tests, 0 failures</span>
</pre></div>
</div>
<p>You will typically need to first make the image available in the appropriate
location, either with successful <code class="code docutils literal notranslate"><span class="pre">build</span></code> and <code class="code docutils literal notranslate"><span class="pre">run</span></code> tests or
manually building and unpacking it.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial.html" class="btn btn-neutral float-right" title="3. Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="1. Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014–2018, Los Alamos National Security, LLC

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>