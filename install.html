

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Installing Charliecloud &mdash; Charliecloud 0.1.5 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Charliecloud 0.1.5 documentation" href="index.html"/>
        <link rel="next" title="2. Tutorial" href="tutorial.html"/>
        <link rel="prev" title="Charliecloud Documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> Charliecloud
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">1. Installing Charliecloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installing-on-linux">1.1. Installing on Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous-supporting-software">1.1.1. Miscellaneous supporting software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#charliecloud-itself">1.1.2. Charliecloud itself</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kvm-hypervisor">1.1.3. KVM hypervisor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cpu-support">1.1.3.1. CPU support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bios-support">1.1.3.2. BIOS support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dev-kvm-permissions">1.1.3.3. <code class="code docutils literal"><span class="pre">/dev/kvm</span></code> permissions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#qemu">1.1.4. QEMU</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#your-first-virtual-cluster">2.1. Your first virtual cluster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#getting-help">2.1.1. Getting help</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-the-virtual-network">2.1.2. Starting the virtual network</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-virtual-cluster">2.1.3. Starting a virtual cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#logging-in">2.1.4. Logging in</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#filesystems">2.1.5. Filesystems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#root-filesystem">2.1.5.1. Root filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-tmp">2.1.5.2. <code class="code docutils literal"><span class="pre">/ch/tmp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-meta">2.1.5.3. <code class="code docutils literal"><span class="pre">/ch/meta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-opt">2.1.5.4. <code class="code docutils literal"><span class="pre">/ch/opt</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#contents-of-the-job-directory">2.1.6. Contents of the job directory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#meta">2.1.6.1. <code class="code docutils literal"><span class="pre">meta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#run">2.1.6.2. <code class="code docutils literal"><span class="pre">run</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#out">2.1.6.3. <code class="code docutils literal"><span class="pre">out</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#network-topology">2.1.7. Network topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#ssh">2.1.8. SSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#shut-the-cluster-down">2.1.9. Shut the cluster down</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#your-first-virtual-job">2.2. Your first virtual job</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-cluster-with-less-clutter">2.2.1. Starting a cluster with less clutter</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#users-groups-and-permissions-under-filesystem-passthrough">2.2.2. Users, groups, and permissions under filesystem passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#running-mpihello-in-interactive-mode">2.2.3. Running <code class="code docutils literal"><span class="pre">mpihello</span></code> in interactive mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#running-mpihello-in-batch-mode">2.2.4. Running <code class="code docutils literal"><span class="pre">mpihello</span></code> in batch mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#installing-your-own-software">2.3. Installing your own software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-vm-with-persistent-root-filesystem">2.3.1. Starting a VM with persistent root filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#installing-software">2.3.2. Installing software</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">3. Networking</a><ul>
<li class="toctree-l2"><a class="reference internal" href="networking.html#network-addresses">3.1. Network addresses</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#ip-addresses">3.1.1. IP addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#mac-addresses">3.1.2. MAC addresses</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#topology">3.2. Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#workstation-mode">3.3. Workstation mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#requirements">3.3.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#topology-implementation">3.3.2. Topology implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#security">3.3.3. Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking.html#mac-and-ip-spoofing">3.3.3.1. MAC and IP spoofing</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#inbound-network-access">3.3.3.2. Inbound network access</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#risks">3.3.3.3. Risks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#cluster-mode">3.4. Cluster mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id1">3.4.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id2">3.4.2. Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id3">3.4.3. Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking.html#id4">3.4.3.1. MAC and IP spoofing</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#guest-isolation">3.4.3.2. Guest isolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#id5">3.4.3.3. Risks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#cluster-mode-faq">3.4.4. Cluster mode FAQ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#resources">3.5. Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fs-passthrough.html">4. Filesystem passthrough</a><ul>
<li class="toctree-l2"><a class="reference internal" href="fs-passthrough.html#uncoordinated-uids-and-gids">4.1. Uncoordinated UIDs and GIDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="fs-passthrough.html#potential-solutions">4.2. Potential solutions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#security-model-mapped">4.2.1. <code class="code docutils literal"><span class="pre">security_model=mapped</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#run-jobs-as-root">4.2.2. Run jobs as root</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#turn-off-guest-permission-checks-on-passthrough-filesystem">4.2.3. Turn off guest permission checks on passthrough filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#mount-with-uid-foo-gid-bar">4.2.4. Mount with <code class="code docutils literal"><span class="pre">uid=foo</span></code>, <code class="code docutils literal"><span class="pre">gid=bar</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#bindfs">4.2.5. bindfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#fsuid-and-fsgid">4.2.6. <code class="code docutils literal"><span class="pre">fsuid</span></code> and <code class="code docutils literal"><span class="pre">fsgid</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#import-users-and-groups-from-host">4.2.7. Import users and groups from host</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#change-uid-before-running-job">4.2.8. Change UID before running job</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#add-host-groups-before-running-job">4.2.9. Add host groups before running job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fs-passthrough.html#solution-implemented-in-charliecloud">4.3. Solution implemented in Charliecloud</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="image-setup.html">5. Image configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#booting-an-installer-overview">5.1. Booting an installer overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#during-install">5.2. During install</a></li>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#after-install">5.3. After install</a><ul>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#console-and-friends">5.3.1. Console and friends</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#filesystem">5.3.2. Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#network">5.3.3. Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#users-and-groups">5.3.4. Users and groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#misc">5.3.5. Misc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#notes-on-systemd-based-distros">5.4. Notes on <code class="code docutils literal"><span class="pre">systemd</span></code>-based distros</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">6. Testing Charliecloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="testing.html#non-interactive-testing">6.1. Non-interactive testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html#interactive-testing">6.2. Interactive testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="script-help.html">7. Script help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#newimage">7.1. newimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#oneguest">7.2. oneguest</a></li>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#vcluster">7.3. vcluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">8. Frequently asked questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="faq.html#error-and-warning-messages">8.1. Error and warning messages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#p-could-not-find-request-transport-virtio">8.1.1. 9p: Could not find request transport: virtio</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#p-no-channels-available">8.1.2. 9p: no channels available</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#job-script-hard-link-failed-copying-instead">8.1.3. job script hard link failed, copying instead</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#mount-unknown-filesystem-type-9p">8.1.4. mount: unknown filesystem type &#8216;9p&#8217;</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#o-direct-unsupported">8.1.5. O_DIRECT unsupported</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#serial8250-too-much-work-for-irq4">8.1.6. serial8250: too much work for irq4</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vde-switch-could-not-remove-ctl-dir">8.1.7. vde_switch: Could not remove ctl dir</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vlan-0-is-not-connected-to-host-network">8.1.8. vlan 0 is not connected to host network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#something-doesn-t-work">8.2. Something doesn&#8217;t work</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#i-can-t-ping-the-outside-world-but-it-s-reachable-by-other-network-stuff">8.2.1. I can&#8217;t ping the outside world, but it&#8217;s reachable by other network stuff</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#intermittent-connectivity-problems-between-guests">8.2.2. Intermittent connectivity problems between guests</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#testing-failed-because-orted-is-listening-to-some-port">8.2.3. Testing failed because orted is listening to some port</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vga-console-won-t-relinquish-mouse-grab">8.2.4. VGA console won&#8217;t relinquish mouse grab</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vga-console-does-not-show-the-whole-screen">8.2.5. VGA console does not show the whole screen</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#configuration">8.3. Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#how-can-i-tell-if-i-m-using-the-faster-virtio-drivers">8.3.1. How can I tell if I&#8217;m using the faster virtio drivers?</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#how-can-i-persist-the-root-filesystem-without-vcluster-commit">8.3.2. How can I persist the root filesystem without <code class="code docutils literal"><span class="pre">vcluster</span> <span class="pre">--commit</span></code>?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">9. API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#the-job-directory">9.1. The job directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#filesystems-provided-to-the-guest">9.2. Filesystems provided to the guest</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api.html#metadata">9.2.1. Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#charliecloud-resources">9.2.2. Charliecloud resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#persistent-storage">9.2.3. Persistent storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#temporary-storage">9.2.4. Temporary storage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="history.html">10. Version history</a><ul>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-5-2015-jun-16">10.1. v0.1.5, 2015-Jun-16</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-4-2015-jun-04">10.2. v0.1.4, 2015-Jun-04</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-3-2015-apr-30">10.3. v0.1.3, 2015-Apr-30</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-2-2015-feb-09">10.4. v0.1.2, 2015-Feb-09</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-1-2014-dec-01">10.5. v0.1.1, 2014-Dec-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-0-2014-sep-30">10.6. v0.1.0, 2014-Sep-30</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Charliecloud</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>1. Installing Charliecloud</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="installing-charliecloud">
<h1>1. Installing Charliecloud<a class="headerlink" href="#installing-charliecloud" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#installing-on-linux" id="id1">Installing on Linux</a><ul>
<li><a class="reference internal" href="#miscellaneous-supporting-software" id="id2">Miscellaneous supporting software</a></li>
<li><a class="reference internal" href="#charliecloud-itself" id="id3">Charliecloud itself</a></li>
<li><a class="reference internal" href="#kvm-hypervisor" id="id4">KVM hypervisor</a></li>
<li><a class="reference internal" href="#qemu" id="id5">QEMU</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Charliecloud supports Linux hosts. OS X and Windows hosts are not currently
supported because filesystem passthrough support is missing. For the same
reason, OS X and Windows guests are unsupported. We hope to fix this
deficiency in the future (patches are welcome!).</p>
</div>
<div class="section" id="installing-on-linux">
<h2><a class="toc-backref" href="#id1">1.1. Installing on Linux</a><a class="headerlink" href="#installing-on-linux" title="Permalink to this headline">¶</a></h2>
<p>This file explains how to install Charliecloud and run a small virtual cluster
on your x86-64 Linux machine. You can run Charliecloud over X11, so this
machine need not be your desktop or laptop.</p>
<p>Charliecloud is designed to have a fairly small number of dependencies, but
unfortunately, the major ones (QEMU itself and VDE networking) require
building from source.</p>
<p>The below assumes you put tarballs in <code class="code docutils literal"><span class="pre">/usr/local/src</span></code> and wish to install
into <code class="code docutils literal"><span class="pre">/usr/local</span></code>.</p>
<p>These instructions use Bash syntax.</p>
<div class="section" id="miscellaneous-supporting-software">
<h3><a class="toc-backref" href="#id2">1.1.1. Miscellaneous supporting software</a><a class="headerlink" href="#miscellaneous-supporting-software" title="Permalink to this headline">¶</a></h3>
<p>You need:</p>
<ul class="simple">
<li>A reasonably recent version of Git.</li>
<li>GNU Stow (optional but highly recommended, as QEMU wants to mess with
permissions of shared directories).</li>
<li>Python 2.7.</li>
<li>Python packages <code class="code docutils literal"><span class="pre">Sphinx</span></code> and <code class="code docutils literal"><span class="pre">sphinx-rtd-theme</span></code> (only if you
wish to build the documentation).</li>
</ul>
<p>You also need the build dependencies of QEMU and VDE. At a high level, these
can be obtained by repeatedly attempting to build and installing what&#8217;s
missing.</p>
<p>For Ubuntu Vivid:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> sudo apt-get build-dep qemu
</pre></div>
</div>
</div>
<div class="section" id="charliecloud-itself">
<h3><a class="toc-backref" href="#id3">1.1.2. Charliecloud itself</a><a class="headerlink" href="#charliecloud-itself" title="Permalink to this headline">¶</a></h3>
<p>We install Charliecloud early, even though it cannot run until the
prerequisites are met, in order to access included files needed for installing
those prerequisites.</p>
<p>This assumes you are putting Charliecloud in <code class="code docutils literal"><span class="pre">~/charliecloud</span></code>. You may
want to put <code class="code docutils literal"><span class="pre">~/charliecloud/bin</span></code> on your <code class="code docutils literal"><span class="pre">$PATH</span></code>.</p>
<p>Install as follows:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~
<span class="gp">$</span> git clone git@git.lanl.gov:reidpr/charliecloud.git
<span class="gp">$</span> <span class="nb">cd </span>charliecloud
<span class="gp">$</span> make doc                <span class="c"># optional</span>
<span class="gp">$</span> bin/vcluster --version
<span class="go">0.1.4</span>
</pre></div>
</div>
</div>
<div class="section" id="kvm-hypervisor">
<h3><a class="toc-backref" href="#id4">1.1.3. KVM hypervisor</a><a class="headerlink" href="#kvm-hypervisor" title="Permalink to this headline">¶</a></h3>
<p>Virtual machine performance is much better with the KVM hypervisor (as opposed
to software emulation), which is built into the stock Linux kernel. All
kernels and x86 CPUs which are even vaguely modern support KVM, so it is
simply a matter of enabling KVM if it isn&#8217;t already.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While Charliecloud currently requires KVM, it would be a very small patch
to make the KVM command line switches passed to QEMU optional (hint, hint).</p>
</div>
<div class="section" id="cpu-support">
<h4>1.1.3.1. CPU support<a class="headerlink" href="#cpu-support" title="Permalink to this headline">¶</a></h4>
<p>To test if your CPU supports hardware virtualization (and thus KVM):</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> egrep -c <span class="s1">&#39;(vmx|svm)&#39;</span> /proc/cpuinfo
</pre></div>
</div>
<p><code class="code docutils literal"><span class="pre">0</span></code> means no, a positive integer means yes.</p>
</div>
<div class="section" id="bios-support">
<h4>1.1.3.2. BIOS support<a class="headerlink" href="#bios-support" title="Permalink to this headline">¶</a></h4>
<p>Hardware virtualization may also need to be enabled in the BIOS. Detecting
this setting and changing is dependent on your OS and hardware; you are best
off consulting Google for details.</p>
<p>Modern Debian-derived distributions include a command <code class="code docutils literal"><span class="pre">kvm-ok</span></code> in the
package <code class="code docutils literal"><span class="pre">cpu-checker</span></code> which makes this easy. If you get something like
this, you&#8217;re golden:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> kvm-ok
<span class="go">INFO: /dev/kvm exists</span>
<span class="go">KVM acceleration can be used</span>
</pre></div>
</div>
<p>If something like this, you need to tweak your BIOS:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> kvm-ok
<span class="go">INFO: /dev/kvm does not exist</span>
<span class="go">HINT:   sudo modprobe kvm_intel</span>
<span class="go">INFO: Your CPU supports KVM extensions</span>
<span class="go">INFO: KVM (vmx) is disabled by your BIOS</span>
<span class="go">HINT: Enter your BIOS setup and enable Virtualization Technology (VT),</span>
<span class="go">      and then hard poweroff/poweron your system</span>
<span class="go">KVM acceleration can NOT be used</span>
</pre></div>
</div>
</div>
<div class="section" id="dev-kvm-permissions">
<h4>1.1.3.3. <code class="code docutils literal"><span class="pre">/dev/kvm</span></code> permissions<a class="headerlink" href="#dev-kvm-permissions" title="Permalink to this headline">¶</a></h4>
<p>You need read/write access to <code class="code docutils literal"><span class="pre">/dev/kvm</span></code>. There are at least two ways
this is accomplished. Which you get depends on your distribution.</p>
<p>The traditional way is to put all KVM users in group <code class="code docutils literal"><span class="pre">kvm</span></code> and make the
device group R/W for that user:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> ls -l /dev/kvm
<span class="go">crw-rw---- 1 root kvm 10, 232 Nov  7 10:36 /dev/kvm</span>
</pre></div>
</div>
<p>The newfangled <code class="code docutils literal"><span class="pre">systemd</span></code> way is to make the device owned
<code class="code docutils literal"><span class="pre">root:root</span></code> and dynamically add users to the file&#8217;s ACL when they log in
to the console (that is, anyone sitting at the computer can use KVM). Note the
trailing plus on the permissions, which implies the presence of an ACL:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> ls -l /dev/kvm
<span class="go">crw-rw----+ 1 root root 10, 232 Nov  7 10:36 /dev/kvm</span>
<span class="gp">$</span> getfacl /dev/kvm
<span class="go">getfacl: Removing leading &#39;/&#39; from absolute path names</span>
<span class="go">​# file: dev/kvm</span>
<span class="go">​# owner: root</span>
<span class="go">​# group: root</span>
<span class="go">user::rw-</span>
<span class="go">user:lightdm:rw-</span>
<span class="go">group::---</span>
<span class="go">mask::rw-</span>
<span class="go">other::---</span>
</pre></div>
</div>
<p>In the above, users <code class="code docutils literal"><span class="pre">root</span></code> and <code class="code docutils literal"><span class="pre">lightdm</span></code> can use KVM.</p>
<p>This causes problems if you want to run Charliecloud over the network, since
you are not sitting at the console.</p>
<p>You can fix the ACL manually after every boot with <code class="code docutils literal"><span class="pre">setfacl</span></code>, or you can
add a <code class="code docutils literal"><span class="pre">udev</span></code> rule to also grant access to users in group <code class="code docutils literal"><span class="pre">kvm</span></code>.
This can be accomplished as follows (note that you must paste the file
content):</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> sudo sh -c <span class="s1">&#39;cat &gt; /etc/udev/rules.d/99-fix-kvm.rules&#39;</span>
<span class="go">SUBSYSTEM==&quot;misc&quot;, KERNEL==&quot;kvm&quot;, GROUP=&quot;kvm&quot;</span>
<span class="go">^D</span>
<span class="gp">$</span> sudo udevadm trigger --action<span class="o">=</span>add --sysname-match<span class="o">=</span>kvm
<span class="gp">$</span> ls -l /dev/kvm
<span class="go">crw-rw----+ 1 root kvm 10, 232 Nov 24 13:57 /dev/kvm</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This leaves the ACLs in place, so you can use KVM <em>either</em> if you are in
the <code class="code docutils literal"><span class="pre">kvm</span></code> group or sitting at the console.</p>
</div>
</div>
</div>
<div class="section" id="qemu">
<h3><a class="toc-backref" href="#id5">1.1.4. QEMU</a><a class="headerlink" href="#qemu" title="Permalink to this headline">¶</a></h3>
<p>We build QEMU from source for two reasons. First, distribution versions tend
to be stale. Second, VDE networking support is often not compiled in (e.g.,
<a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/qemu-kvm/+bug/776650">in Ubuntu</a>).</p>
<p>Download QEMU from the <a class="reference external" href="http://wiki.qemu.org/Download">official site</a>. You
probably want to choose the most recent stable version, which is 2.1.2 as of
this writing (November 1914).</p>
<p>Build and install as follows:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> tar xjf qemu-2.1.2.tar.bz2
<span class="gp">$</span> <span class="nb">cd </span>qemu-2.1.2
<span class="gp">$</span> ./configure --prefix<span class="o">=</span>/usr/local/stow/qemu-2.1.2 <span class="se">\</span>
<span class="go">              --target-list=i386-softmmu,x86_64-softmmu \</span>
<span class="go">              --enable-kvm \</span>
<span class="go">              --enable-uuid \</span>
<span class="go">              --enable-virtfs</span>
<span class="gp">$</span> make
<span class="gp">$</span> make install
<span class="gp">$</span> stow -d /usr/local/stow -S qemu-2.1.2
<span class="gp">$</span> qemu-system-x86_64 --version
<span class="go">QEMU emulator version 2.1.2, Copyright (c) 2003-2008 Fabrice Bellard</span>
</pre></div>
</div>
<p>Note that <code class="code docutils literal"><span class="pre">configure</span></code> will pick up available libraries automatically, so
some of the above is redundant. However, we list it to document what
Charliecloud needs. <code class="code docutils literal"><span class="pre">--target-list</span></code> is short simply to improve compile
speed; you can add more/all targets if you want to other guest architectures
(note that KVM is not available for most targets).</p>
<p><em>Now, move on to the next section to learn how to run your first virtual
cluster.</em></p>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial.html" class="btn btn-neutral float-right" title="2. Tutorial" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Charliecloud Documentation" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014–2015, Los Alamos National Security, LLC.
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>