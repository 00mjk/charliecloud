

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5. Image configuration &mdash; Charliecloud 0.1.5 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Charliecloud 0.1.5 documentation" href="index.html"/>
        <link rel="next" title="6. Testing Charliecloud" href="testing.html"/>
        <link rel="prev" title="4. Filesystem passthrough" href="fs-passthrough.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> Charliecloud
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing Charliecloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="install.html#installing-on-linux">1.1. Installing on Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="install.html#miscellaneous-supporting-software">1.1.1. Miscellaneous supporting software</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#charliecloud-itself">1.1.2. Charliecloud itself</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#kvm-hypervisor">1.1.3. KVM hypervisor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="install.html#cpu-support">1.1.3.1. CPU support</a></li>
<li class="toctree-l4"><a class="reference internal" href="install.html#bios-support">1.1.3.2. BIOS support</a></li>
<li class="toctree-l4"><a class="reference internal" href="install.html#dev-kvm-permissions">1.1.3.3. <code class="code docutils literal"><span class="pre">/dev/kvm</span></code> permissions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="install.html#qemu">1.1.4. QEMU</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#your-first-virtual-cluster">2.1. Your first virtual cluster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#getting-help">2.1.1. Getting help</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-the-virtual-network">2.1.2. Starting the virtual network</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-virtual-cluster">2.1.3. Starting a virtual cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#logging-in">2.1.4. Logging in</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#filesystems">2.1.5. Filesystems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#root-filesystem">2.1.5.1. Root filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-tmp">2.1.5.2. <code class="code docutils literal"><span class="pre">/ch/tmp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-meta">2.1.5.3. <code class="code docutils literal"><span class="pre">/ch/meta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-opt">2.1.5.4. <code class="code docutils literal"><span class="pre">/ch/opt</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#contents-of-the-job-directory">2.1.6. Contents of the job directory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#meta">2.1.6.1. <code class="code docutils literal"><span class="pre">meta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#run">2.1.6.2. <code class="code docutils literal"><span class="pre">run</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#out">2.1.6.3. <code class="code docutils literal"><span class="pre">out</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#network-topology">2.1.7. Network topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#ssh">2.1.8. SSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#shut-the-cluster-down">2.1.9. Shut the cluster down</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#your-first-virtual-job">2.2. Your first virtual job</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-cluster-with-less-clutter">2.2.1. Starting a cluster with less clutter</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#users-groups-and-permissions-under-filesystem-passthrough">2.2.2. Users, groups, and permissions under filesystem passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#running-mpihello-in-interactive-mode">2.2.3. Running <code class="code docutils literal"><span class="pre">mpihello</span></code> in interactive mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#running-mpihello-in-batch-mode">2.2.4. Running <code class="code docutils literal"><span class="pre">mpihello</span></code> in batch mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#installing-your-own-software">2.3. Installing your own software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-vm-with-persistent-root-filesystem">2.3.1. Starting a VM with persistent root filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#installing-software">2.3.2. Installing software</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">3. Networking</a><ul>
<li class="toctree-l2"><a class="reference internal" href="networking.html#network-addresses">3.1. Network addresses</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#ip-addresses">3.1.1. IP addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#mac-addresses">3.1.2. MAC addresses</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#topology">3.2. Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#workstation-mode">3.3. Workstation mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#requirements">3.3.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#topology-implementation">3.3.2. Topology implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#security">3.3.3. Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking.html#mac-and-ip-spoofing">3.3.3.1. MAC and IP spoofing</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#inbound-network-access">3.3.3.2. Inbound network access</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#risks">3.3.3.3. Risks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#cluster-mode">3.4. Cluster mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id1">3.4.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id2">3.4.2. Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id3">3.4.3. Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking.html#id4">3.4.3.1. MAC and IP spoofing</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#guest-isolation">3.4.3.2. Guest isolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#id5">3.4.3.3. Risks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#cluster-mode-faq">3.4.4. Cluster mode FAQ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#resources">3.5. Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fs-passthrough.html">4. Filesystem passthrough</a><ul>
<li class="toctree-l2"><a class="reference internal" href="fs-passthrough.html#uncoordinated-uids-and-gids">4.1. Uncoordinated UIDs and GIDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="fs-passthrough.html#potential-solutions">4.2. Potential solutions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#security-model-mapped">4.2.1. <code class="code docutils literal"><span class="pre">security_model=mapped</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#run-jobs-as-root">4.2.2. Run jobs as root</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#turn-off-guest-permission-checks-on-passthrough-filesystem">4.2.3. Turn off guest permission checks on passthrough filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#mount-with-uid-foo-gid-bar">4.2.4. Mount with <code class="code docutils literal"><span class="pre">uid=foo</span></code>, <code class="code docutils literal"><span class="pre">gid=bar</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#bindfs">4.2.5. bindfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#fsuid-and-fsgid">4.2.6. <code class="code docutils literal"><span class="pre">fsuid</span></code> and <code class="code docutils literal"><span class="pre">fsgid</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#import-users-and-groups-from-host">4.2.7. Import users and groups from host</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#change-uid-before-running-job">4.2.8. Change UID before running job</a></li>
<li class="toctree-l3"><a class="reference internal" href="fs-passthrough.html#add-host-groups-before-running-job">4.2.9. Add host groups before running job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fs-passthrough.html#solution-implemented-in-charliecloud">4.3. Solution implemented in Charliecloud</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">5. Image configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#booting-an-installer-overview">5.1. Booting an installer overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#during-install">5.2. During install</a></li>
<li class="toctree-l2"><a class="reference internal" href="#after-install">5.3. After install</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#console-and-friends">5.3.1. Console and friends</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filesystem">5.3.2. Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#network">5.3.3. Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#users-and-groups">5.3.4. Users and groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="#misc">5.3.5. Misc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#notes-on-systemd-based-distros">5.4. Notes on <code class="code docutils literal"><span class="pre">systemd</span></code>-based distros</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">6. Testing Charliecloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="testing.html#non-interactive-testing">6.1. Non-interactive testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html#interactive-testing">6.2. Interactive testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="script-help.html">7. Script help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#newimage">7.1. newimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#oneguest">7.2. oneguest</a></li>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#vcluster">7.3. vcluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">8. Frequently asked questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="faq.html#error-and-warning-messages">8.1. Error and warning messages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#p-could-not-find-request-transport-virtio">8.1.1. 9p: Could not find request transport: virtio</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#p-no-channels-available">8.1.2. 9p: no channels available</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#job-script-hard-link-failed-copying-instead">8.1.3. job script hard link failed, copying instead</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#mount-unknown-filesystem-type-9p">8.1.4. mount: unknown filesystem type &#8216;9p&#8217;</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#o-direct-unsupported">8.1.5. O_DIRECT unsupported</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#serial8250-too-much-work-for-irq4">8.1.6. serial8250: too much work for irq4</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vde-switch-could-not-remove-ctl-dir">8.1.7. vde_switch: Could not remove ctl dir</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vlan-0-is-not-connected-to-host-network">8.1.8. vlan 0 is not connected to host network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#something-doesn-t-work">8.2. Something doesn&#8217;t work</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#i-can-t-ping-the-outside-world-but-it-s-reachable-by-other-network-stuff">8.2.1. I can&#8217;t ping the outside world, but it&#8217;s reachable by other network stuff</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#intermittent-connectivity-problems-between-guests">8.2.2. Intermittent connectivity problems between guests</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#testing-failed-because-orted-is-listening-to-some-port">8.2.3. Testing failed because orted is listening to some port</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vga-console-won-t-relinquish-mouse-grab">8.2.4. VGA console won&#8217;t relinquish mouse grab</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vga-console-does-not-show-the-whole-screen">8.2.5. VGA console does not show the whole screen</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#configuration">8.3. Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#how-can-i-tell-if-i-m-using-the-faster-virtio-drivers">8.3.1. How can I tell if I&#8217;m using the faster virtio drivers?</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#how-can-i-persist-the-root-filesystem-without-vcluster-commit">8.3.2. How can I persist the root filesystem without <code class="code docutils literal"><span class="pre">vcluster</span> <span class="pre">--commit</span></code>?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">9. API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#the-job-directory">9.1. The job directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#filesystems-provided-to-the-guest">9.2. Filesystems provided to the guest</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api.html#metadata">9.2.1. Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#charliecloud-resources">9.2.2. Charliecloud resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#persistent-storage">9.2.3. Persistent storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#temporary-storage">9.2.4. Temporary storage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="history.html">10. Version history</a><ul>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-5-2015-jun-16">10.1. v0.1.5, 2015-Jun-16</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-4-2015-jun-04">10.2. v0.1.4, 2015-Jun-04</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-3-2015-apr-30">10.3. v0.1.3, 2015-Apr-30</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-2-2015-feb-09">10.4. v0.1.2, 2015-Feb-09</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-1-2014-dec-01">10.5. v0.1.1, 2014-Dec-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-0-2014-sep-30">10.6. v0.1.0, 2014-Sep-30</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Charliecloud</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>5. Image configuration</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="image-configuration">
<h1>5. Image configuration<a class="headerlink" href="#image-configuration" title="Permalink to this headline">¶</a></h1>
<p>The following checklist is a good starting point for creating a virtual
machine image. Note that this is not recommended for typical users; almost
always, modifying a provided base image is less work.</p>
<p>Detailed instructions are not provided; instead, the list contains pointers to
the Debian Jessie reference image.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#booting-an-installer-overview" id="id1">Booting an installer overview</a></li>
<li><a class="reference internal" href="#during-install" id="id2">During install</a></li>
<li><a class="reference internal" href="#after-install" id="id3">After install</a><ul>
<li><a class="reference internal" href="#console-and-friends" id="id4">Console and friends</a></li>
<li><a class="reference internal" href="#filesystem" id="id5">Filesystem</a></li>
<li><a class="reference internal" href="#network" id="id6">Network</a></li>
<li><a class="reference internal" href="#users-and-groups" id="id7">Users and groups</a></li>
<li><a class="reference internal" href="#misc" id="id8">Misc</a></li>
</ul>
</li>
<li><a class="reference internal" href="#notes-on-systemd-based-distros" id="id9">Notes on <code class="code docutils literal"><span class="pre">systemd</span></code>-based distros</a></li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unfortunately, the reference image is not provided with Charliecloud itself
at this time. We are working to rectify this deficiency.</p>
</div>
<div class="section" id="booting-an-installer-overview">
<h2><a class="toc-backref" href="#id1">5.1. Booting an installer overview</a><a class="headerlink" href="#booting-an-installer-overview" title="Permalink to this headline">¶</a></h2>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> newimage centos-6.5_base.qcow2
<span class="gp">$</span> oneguest --monitor --vga --boot centos-6.5-x86_64-DVD1.iso centos-6.5_base.qcow2
<span class="gp">$</span> oneguest --monitor --vga -d /tmp centos-6.5_base.qcow2
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://www.linux-kvm.org/page/Change_cdrom">Monitor voodoo</a> is required
to insert or change CD/DVD media. If you don&#8217;t need to do this, you can
omit <code class="code docutils literal"><span class="pre">--monitor</span></code>.</p>
</div>
</div>
<div class="section" id="during-install">
<h2><a class="toc-backref" href="#id2">5.2. During install</a><a class="headerlink" href="#during-install" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Set the label <code class="code docutils literal"><span class="pre">root</span></code> on the root filesystem, if you can.</li>
<li>Name the initial user, which will be the primary job user, <code class="code docutils literal"><span class="pre">charlie</span></code>.</li>
<li>No swap space (our scripts deal with this later).</li>
</ul>
</div>
<div class="section" id="after-install">
<h2><a class="toc-backref" href="#id3">5.3. After install</a><a class="headerlink" href="#after-install" title="Permalink to this headline">¶</a></h2>
<div class="section" id="console-and-friends">
<h3><a class="toc-backref" href="#id4">5.3.1. Console and friends</a><a class="headerlink" href="#console-and-friends" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Attach the console to both the display and the first serial port. See the
<a class="reference external" href="https://www.kernel.org/doc/Documentation/serial-console.txt">kernel documentation</a> and edit
<code class="code docutils literal"><span class="pre">/etc/default/grub</span></code> appropriately, then run <code class="code docutils literal"><span class="pre">update-grub</span></code>.</p>
<p>You may also wish to turn off <code class="code docutils literal"><span class="pre">FANCYTTY</span></code>, which can clutter the
console log with ANSI escape sequences. Do so in
<code class="code docutils literal"><span class="pre">/etc/lsb-base-logging.sh</span></code>, though there seem to be still a few overly
enthusiastic ANSI escapers.</p>
</li>
<li><p class="first">Set up the console to stay on the ROM font (the traditional DOS look).
Optional, but I prefer the aesthetics. Edit
<code class="code docutils literal"><span class="pre">/etc/default/console-setup</span></code> and <code class="code docutils literal"><span class="pre">/etc/default/grub</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="filesystem">
<h3><a class="toc-backref" href="#id5">5.3.2. Filesystem</a><a class="headerlink" href="#filesystem" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Set up environment variables for interactive shells (e.g.
<code class="code docutils literal"><span class="pre">/etc/profile.d/charlie_proxy.sh</span></code>). Note that this only sets advisory
environment variables in certain contexts, so it doesn&#8217;t work for all apps.
This includes:<ul>
<li>HTTP/HTTPS proxy. (Not needed for <code class="code docutils literal"><span class="pre">apt</span></code> to work.)</li>
<li>Charliecloud environment variables. (See issue #35.)</li>
</ul>
</li>
<li>Make <code class="code docutils literal"><span class="pre">/ch</span></code> and subdirectories.</li>
<li>Install the init script <code class="code docutils literal"><span class="pre">/etc/rc.local</span></code>.</li>
<li>Set up <code class="code docutils literal"><span class="pre">/etc/fstab</span></code> to mount the filesystems. Don&#8217;t forget
<code class="code docutils literal"><span class="pre">nofail</span></code> on things that might not be present at boot time.</li>
</ul>
</div>
<div class="section" id="network">
<h3><a class="toc-backref" href="#id6">5.3.3. Network</a><a class="headerlink" href="#network" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Disable persistent network device naming. This causes trouble because MAC
addresses change between boots. If the network does not work, this is a
likely culprit, especially if it does work on guest 0 but not other guests.<ul>
<li>Debian Wheezy: Create an empty
<code class="code docutils literal"><span class="pre">/etc/udev/rules.d/75-persistent-net-generator.rules</span></code> and delete
<code class="code docutils literal"><span class="pre">/etc/udev/rules.d/70-persistent-net.rules</span></code> (see
<code class="code docutils literal"><span class="pre">/usr/share/doc/udev/README.Debian.gz</span></code>).</li>
<li>Linux distributions with the new <a class="reference external" href="http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">&#8220;Predictable Network Interface Names&#8221;</a>:
<strong>FIXME</strong></li>
</ul>
</li>
<li>Configure networking:<ul>
<li><code class="code docutils literal"><span class="pre">/etc/network/interfaces</span></code></li>
<li><code class="code docutils literal"><span class="pre">/etc/hosts</span></code> symlinked to <code class="code docutils literal"><span class="pre">/ch/meta/hosts</span></code></li>
<li><code class="code docutils literal"><span class="pre">/etc/resolv.conf</span></code> symlinked to <code class="code docutils literal"><span class="pre">/ch/meta/resolv.conf</span></code></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="users-and-groups">
<h3><a class="toc-backref" href="#id7">5.3.4. Users and groups</a><a class="headerlink" href="#users-and-groups" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Change default umask to 002 in <code class="code docutils literal"><span class="pre">/etc/login.defs</span></code>. Also update
<code class="code docutils literal"><span class="pre">/etc/pam.d/common-session</span></code> because of a <a class="reference external" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=646692">Debian bug</a>. (See
<a class="reference internal" href="fs-passthrough.html"><em>Filesystem passthrough</em></a> for why.)</p>
</li>
<li><p class="first">Change the primary job user <code class="code docutils literal"><span class="pre">charlie</span></code>&#8216;s UID to 65530 and
user-private group <code class="code docutils literal"><span class="pre">charlie</span></code>&#8216;s GID to 65530. Update all files owned
by him in the virtual system:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> usermod -u <span class="m">65530</span> charlie
<span class="gp">&gt;</span> groupmod -g <span class="m">65530</span> charlie
<span class="gp">&gt;</span> usermod -g <span class="m">65530</span> charlie    <span class="c"># maybe?</span>
<span class="gp">&gt;</span> find / -xdev -group <span class="m">1000</span> -exec chgrp -vh <span class="m">65530</span> <span class="o">{}</span> <span class="se">\;</span>
</pre></div>
</div>
</li>
<li><p class="first">Make serial ports R/W for job user. On Debian-derived systems, simply add
the user to the <code class="code docutils literal"><span class="pre">dialout</span></code> group.</p>
</li>
<li><p class="first">Set up passwords &amp; authentication:</p>
<ul class="simple">
<li>Configure SSH:<ul>
<li>allow keys (<code class="code docutils literal"><span class="pre">PubkeyAuthentication</span> <span class="pre">yes</span></code>); this is the default</li>
<li>forbid passwords (<code class="code docutils literal"><span class="pre">PasswordAuthentication</span> <span class="pre">no</span></code>)</li>
<li>forbid root login (<code class="code docutils literal"><span class="pre">PermitRootLogin</span> <span class="pre">no</span></code>)</li>
</ul>
</li>
<li>Set root&#8217;s password to something strong.</li>
<li>Edit <code class="code docutils literal"><span class="pre">/etc/sudoers</span></code>:<ul>
<li>Add <code class="code docutils literal"><span class="pre">charlie</span></code> (e.g., by adding him to group <code class="code docutils literal"><span class="pre">sudo</span></code>)</li>
<li>Set <code class="code docutils literal"><span class="pre">NOPASSWD</span></code> on the relevant line(s)</li>
<li>Pass through the HTTP proxy variables</li>
</ul>
</li>
<li>Set <code class="code docutils literal"><span class="pre">charlie</span></code> to have no password (<code class="code docutils literal"><span class="pre">passwd</span> <span class="pre">-d</span></code>).</li>
</ul>
<p>The basic philosophy is: once inside, access control is minimal; access
controls via the console are minimal; SSH is reasonably locked down.</p>
</li>
<li><p class="first">Set up SSH keys for <code class="code docutils literal"><span class="pre">charlie</span></code>. The pair is passwordless, to permit
unattended login from other members of the virtual cluster, so use with
care.</p>
<ul class="simple">
<li><code class="code docutils literal"><span class="pre">ssh-keygen</span></code>; enter an empty password.</li>
<li>Copy <code class="code docutils literal"><span class="pre">id_rsa.pub</span></code> to <code class="code docutils literal"><span class="pre">authorized_keys</span></code>.</li>
<li>Edit <code class="code docutils literal"><span class="pre">authorized_keys</span></code> to restrict the key to virtual cluster IPs.</li>
<li>Edit <code class="code docutils literal"><span class="pre">config</span></code> to not check host keys within the virtual cluster.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="misc">
<h3><a class="toc-backref" href="#id8">5.3.5. Misc</a><a class="headerlink" href="#misc" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Remove unnecessary servers, for example mail (<code class="code docutils literal"><span class="pre">exim4</span></code> on Debian), NTP,
NFS, RPC, etc.</li>
<li>Configure MPI (e.g., files in <code class="code docutils literal"><span class="pre">/etc/openmpi</span></code>).</li>
</ul>
</div>
</div>
<div class="section" id="notes-on-systemd-based-distros">
<h2><a class="toc-backref" href="#id9">5.4. Notes on <code class="code docutils literal"><span class="pre">systemd</span></code>-based distros</a><a class="headerlink" href="#notes-on-systemd-based-distros" title="Permalink to this headline">¶</a></h2>
<p>Here are some quick, unhelpful notes on setup for <code class="code docutils literal"><span class="pre">systemd</span></code>-based
distributions (e.g., Debian Jessie).</p>
<ul class="simple">
<li><code class="code docutils literal"><span class="pre">/ch/tmp</span></code> needs <code class="code docutils literal"><span class="pre">noauto</span></code>, not <code class="code docutils literal"><span class="pre">nofail</span></code>, in <code class="code docutils literal"><span class="pre">fstab</span></code>.</li>
<li><code class="code docutils literal"><span class="pre">journald.conf</span></code> to send output to console only (<code class="code docutils literal"><span class="pre">Storage=none</span></code>
and <code class="code docutils literal"><span class="pre">ForwardToSyslog=yes</span></code>?)</li>
<li><code class="code docutils literal"><span class="pre">systemd.conf</span></code> <code class="code docutils literal"><span class="pre">ShowStatus=no</span></code> to remove fancy boot messages and
their ANSI codes from the serial console.</li>
<li><code class="code docutils literal"><span class="pre">/etc/systemd/system/charliecloud.service</span></code></li>
<li>Set <code class="code docutils literal"><span class="pre">umask</span> <span class="pre">0007</span></code> in <code class="code docutils literal"><span class="pre">.bashrc</span></code>. <code class="code docutils literal"><span class="pre">login.defs</span></code> setting is not
applied consistently (only interactive logins?).</li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="6. Testing Charliecloud" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fs-passthrough.html" class="btn btn-neutral" title="4. Filesystem passthrough" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014–2015, Los Alamos National Security, LLC.
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>