

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>6. Frequently asked questions (FAQ) &mdash; Charliecloud 0.2.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Charliecloud 0.2.5 documentation" href="index.html"/>
        <link rel="prev" title="5. VirtualBox appliance" href="virtualbox.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Charliecloud
          

          
            
            <img src="_static/logo-sidebar.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                7294994
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">2. Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="command-usage.html">4. Charliecloud command reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="virtualbox.html">5. VirtualBox appliance</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Frequently asked questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#where-did-the-name-charliecloud-come-from">6.1. Where did the name Charliecloud come from?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-do-you-spell-charliecloud">6.2. How do you spell Charliecloud?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#my-app-needs-to-write-to-var-log-run-etc">6.3. My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tarball-build-fails-with-no-command-specified">6.4. Tarball build fails with “No command specified”</a></li>
<li class="toctree-l2"><a class="reference internal" href="#uid-0-lets-me-read-files-i-can-t-otherwise">6.5. <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-is-bin-being-added-to-my-path">6.6. Why is <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> being added to my <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ch-run-fails-with-can-t-re-mount-image-read-only">6.7. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a></li>
<li class="toctree-l2"><a class="reference internal" href="#which-specific-sudo-commands-are-needed">6.8. Which specific <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> commands are needed?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#openmpi-charliecloud-jobs-don-t-work">6.9. OpenMPI Charliecloud jobs don’t work</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mpirun-can-t-launch-jobs">6.9.1. <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#my-ranks-can-t-talk-to-one-another-and-i-m-told-darth-vader-has-something-to-do-with-it">6.9.2. My ranks can’t talk to one another and I’m told Darth Vader has something to do with it</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-do-i-run-x11-apps">6.10. How do I run X11 apps?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>6. Frequently asked questions (FAQ)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="frequently-asked-questions-faq">
<h1>6. Frequently asked questions (FAQ)<a class="headerlink" href="#frequently-asked-questions-faq" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#where-did-the-name-charliecloud-come-from" id="id1">Where did the name Charliecloud come from?</a></li>
<li><a class="reference internal" href="#how-do-you-spell-charliecloud" id="id2">How do you spell Charliecloud?</a></li>
<li><a class="reference internal" href="#my-app-needs-to-write-to-var-log-run-etc" id="id3">My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a></li>
<li><a class="reference internal" href="#tarball-build-fails-with-no-command-specified" id="id4">Tarball build fails with “No command specified”</a></li>
<li><a class="reference internal" href="#uid-0-lets-me-read-files-i-can-t-otherwise" id="id5"><code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a></li>
<li><a class="reference internal" href="#why-is-bin-being-added-to-my-path" id="id6">Why is <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> being added to my <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>?</a></li>
<li><a class="reference internal" href="#ch-run-fails-with-can-t-re-mount-image-read-only" id="id7"><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a></li>
<li><a class="reference internal" href="#which-specific-sudo-commands-are-needed" id="id8">Which specific <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> commands are needed?</a></li>
<li><a class="reference internal" href="#openmpi-charliecloud-jobs-don-t-work" id="id9">OpenMPI Charliecloud jobs don’t work</a><ul>
<li><a class="reference internal" href="#mpirun-can-t-launch-jobs" id="id10"><code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a></li>
<li><a class="reference internal" href="#my-ranks-can-t-talk-to-one-another-and-i-m-told-darth-vader-has-something-to-do-with-it" id="id11">My ranks can’t talk to one another and I’m told Darth Vader has something to do with it</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-do-i-run-x11-apps" id="id12">How do I run X11 apps?</a></li>
</ul>
</div>
<div class="section" id="where-did-the-name-charliecloud-come-from">
<h2><a class="toc-backref" href="#id1">6.1. Where did the name Charliecloud come from?</a><a class="headerlink" href="#where-did-the-name-charliecloud-come-from" title="Permalink to this headline">¶</a></h2>
<p><em>Charlie</em> — Charles F. McMillan was director of Los Alamos National Laboratory
from June 2011 until December 2017, i.e., at the time Charliecloud was started
in early 2014. He is universally referred to as “Charlie” here.</p>
<p><em>cloud</em> — Charliecloud provides cloud-like flexibility for HPC systems.</p>
</div>
<div class="section" id="how-do-you-spell-charliecloud">
<h2><a class="toc-backref" href="#id2">6.2. How do you spell Charliecloud?</a><a class="headerlink" href="#how-do-you-spell-charliecloud" title="Permalink to this headline">¶</a></h2>
<p>We try to be consistent with <em>Charliecloud</em> — one word, no camel case. That
is, <em>Charlie Cloud</em> and <em>CharlieCloud</em> are both incorrect.</p>
</div>
<div class="section" id="my-app-needs-to-write-to-var-log-run-etc">
<h2><a class="toc-backref" href="#id3">6.3. My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a><a class="headerlink" href="#my-app-needs-to-write-to-var-log-run-etc" title="Permalink to this headline">¶</a></h2>
<p>Because the image is mounted read-only by default, log files, caches, and
other stuff cannot be written anywhere in the image. You have three options:</p>
<ol class="arabic simple">
<li>Configure the application to use a different directory. <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is
often a good choice, because it’s shared with the host and fast.</li>
<li>Use <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> commands in your Dockerfile to create symlinks that point
somewhere writeable, e.g. <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>, or <code class="code docutils literal notranslate"><span class="pre">/mnt/0</span></code> with
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--bind</span></code>.</li>
<li>Run the image read-write with <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span></code>. Be careful that multiple
containers do not try to write to the same image files.</li>
</ol>
</div>
<div class="section" id="tarball-build-fails-with-no-command-specified">
<h2><a class="toc-backref" href="#id4">6.4. Tarball build fails with “No command specified”</a><a class="headerlink" href="#tarball-build-fails-with-no-command-specified" title="Permalink to this headline">¶</a></h2>
<p>The full error from <code class="code docutils literal notranslate"><span class="pre">ch-docker2tar</span></code> or <code class="code docutils literal notranslate"><span class="pre">ch-build2dir</span></code> is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker: Error response from daemon: No command specified.</span>
</pre></div>
</div>
<p>You will also see it with various plain Docker commands.</p>
<p>This happens when there is no default command specified in the Dockerfile or
any of its ancestors. Some base images specify one (e.g., Debian) and others
don’t (e.g., Alpine). Docker requires this even for commands that don’t seem
like they should need it, such as <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">create</span></code> (which is what trips
up Charliecloud).</p>
<p>The solution is to add a default command to your Dockerfile, such as
<code class="code docutils literal notranslate"><span class="pre">CMD</span> <span class="pre">[&quot;true&quot;]</span></code>.</p>
</div>
<div class="section" id="uid-0-lets-me-read-files-i-can-t-otherwise">
<h2><a class="toc-backref" href="#id5">6.5. <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a><a class="headerlink" href="#uid-0-lets-me-read-files-i-can-t-otherwise" title="Permalink to this headline">¶</a></h2>
<p>Some permission bits can give a surprising result with a container UID of 0.
For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> whoami
<span class="go">reidpr</span>
<span class="gp">$</span> <span class="nb">echo</span> surprise &gt; ~/cantreadme
<span class="gp">$</span> chmod <span class="m">000</span> ~/cantreadme
<span class="gp">$</span> ls -l ~/cantreadme
<span class="go">---------- 1 reidpr reidpr 9 Oct  3 15:03 /home/reidpr/cantreadme</span>
<span class="gp">$</span> cat ~/cantreadme
<span class="go">cat: /home/reidpr/cantreadme: Permission denied</span>
<span class="gp">$</span> ch-run /var/tmp/hello cat ~/cantreadme
<span class="go">cat: /home/reidpr/cantreadme: Permission denied</span>
<span class="gp">$</span> ch-run --uid <span class="m">0</span> /var/tmp/hello cat ~/cantreadme
<span class="go">surprise</span>
</pre></div>
</div>
<p>At first glance, it seems that we’ve found an escalation – we were able to
read a file inside a container that we could not read on the host! That seems
bad.</p>
<p>However, what is really going on here is more prosaic but complicated:</p>
<ol class="arabic simple">
<li>After <code class="code docutils literal notranslate"><span class="pre">unshare(CLONE_NEWUSER)</span></code>, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> gains all capabilities
inside the namespace. (Outside, capabilities are unchanged.)</li>
<li>This include <code class="code docutils literal notranslate"><span class="pre">CAP_DAC_OVERRIDE</span></code>, which enables a process to
read/write/execute a file or directory mostly regardless of its permission
bits. (This is why root isn’t limited by permissions.)</li>
<li>Within the container, <code class="code docutils literal notranslate"><span class="pre">exec(2)</span></code> capability rules are followed.
Normally, this basically means that all capabilities are dropped when
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> replaces itself with the user command. However, if EUID is
0, which it is inside the namespace given <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code>, then the
subprocess keeps all its capabilities. (This makes sense: if root creates a
new process, it stays root.)</li>
<li><code class="code docutils literal notranslate"><span class="pre">CAP_DAC_OVERRIDE</span></code> within a user namespace is honored for a file or
directory only if its UID and GID are both mapped. In this case,
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> maps <code class="code docutils literal notranslate"><span class="pre">reidpr</span></code> to container <code class="code docutils literal notranslate"><span class="pre">root</span></code> and group
<code class="code docutils literal notranslate"><span class="pre">reidpr</span></code> to itself.</li>
<li>Thus, files and directories owned by the host EUID and EGID (here
<code class="code docutils literal notranslate"><span class="pre">reidpr:reidpr</span></code>) are available for all access with <code class="code docutils literal notranslate"><span class="pre">ch-run</span>
<span class="pre">--uid</span> <span class="pre">0</span></code>.</li>
</ol>
<p>This isn’t a problem. The quirk applies only to files owned by the invoking
user, because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> is unprivileged outside the namespace, and thus
he or she could simply <code class="code docutils literal notranslate"><span class="pre">chmod</span></code> the file to read it. Access inside and
outside the container remains equivalent.</p>
<p>References:</p>
<ul class="simple">
<li><a class="reference external" href="http://man7.org/linux/man-pages/man7/capabilities.7.html">http://man7.org/linux/man-pages/man7/capabilities.7.html</a></li>
<li><a class="reference external" href="http://lxr.free-electrons.com/source/kernel/capability.c?v=4.2#L442">http://lxr.free-electrons.com/source/kernel/capability.c?v=4.2#L442</a></li>
<li><a class="reference external" href="http://lxr.free-electrons.com/source/fs/namei.c?v=4.2#L328">http://lxr.free-electrons.com/source/fs/namei.c?v=4.2#L328</a></li>
</ul>
</div>
<div class="section" id="why-is-bin-being-added-to-my-path">
<h2><a class="toc-backref" href="#id6">6.6. Why is <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> being added to my <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>?</a><a class="headerlink" href="#why-is-bin-being-added-to-my-path" title="Permalink to this headline">¶</a></h2>
<p>Newer Linux distributions replace some root-level directories, such as
<code class="code docutils literal notranslate"><span class="pre">/bin</span></code>, with symlinks to their counterparts in <code class="code docutils literal notranslate"><span class="pre">/usr</span></code>.</p>
<p>Some of these distributions (e.g., Fedora 24) have also dropped <code class="code docutils literal notranslate"><span class="pre">/bin</span></code>
from the default <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>. This is a problem when the guest OS does <em>not</em>
have a merged <code class="code docutils literal notranslate"><span class="pre">/usr</span></code> (e.g., Debian 8 “Jessie”).</p>
<p>While Charliecloud’s general philosophy is not to manipulate environment
variables, in this case, guests can be severely broken if <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> is not
in <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>. Thus, we add it if it’s not there.</p>
<p>Further reading:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/TheCaseForTheUsrMerge/">The case for the /usr Merge</a></li>
<li><a class="reference external" href="https://fedoraproject.org/wiki/Features/UsrMove">Fedora</a></li>
<li><a class="reference external" href="https://wiki.debian.org/UsrMerge">Debian</a></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="ch-run-fails-with-can-t-re-mount-image-read-only">
<h2><a class="toc-backref" href="#id7">6.7. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a><a class="headerlink" href="#ch-run-fails-with-can-t-re-mount-image-read-only" title="Permalink to this headline">¶</a></h2>
<p>Normally, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> re-mounts the image directory read-only within the
container. This fails if the image resides on certain filesystems, such as NFS
(see <a class="reference external" href="https://github.com/hpc/charliecloud/issues/9">issue #9</a>). There are
two solutions:</p>
<ol class="arabic simple">
<li>Unpack the image into a different filesystem, such as <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> or
local disk. Consult your local admins for a recommendation. Note that
<code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> is a lot faster than Lustre.</li>
<li>Use the <code class="code docutils literal notranslate"><span class="pre">-w</span></code> switch to leave the image mounted read-write. Note that
this has may have an impact on reproducibility (because the application can
change the image between runs) and/or stability (if there are multiple
application processes and one writes a file in the image that another is
reading or writing).</li>
</ol>
</div>
<div class="section" id="which-specific-sudo-commands-are-needed">
<h2><a class="toc-backref" href="#id8">6.8. Which specific <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> commands are needed?</a><a class="headerlink" href="#which-specific-sudo-commands-are-needed" title="Permalink to this headline">¶</a></h2>
<p>For running images, <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> is not needed at all.</p>
<p>For building images, it depends on what you would like to support. For
example, do you want to let users build images with Docker? Do you want to let
them run the build tests?</p>
<p>We do not maintain specific lists, but you can search the source code and
documentation for uses of <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> and <code class="code docutils literal notranslate"><span class="pre">$DOCKER</span></code> and evaluate them
on a case-by-case basis. (The latter includes <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> if needed to invoke
<code class="code docutils literal notranslate"><span class="pre">docker</span></code> in your environment.) For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> find . <span class="se">\(</span>   -type f -executable <span class="se">\</span>
           -o -name Makefile <span class="se">\</span>
           -o -name <span class="s1">&#39;*.bats&#39;</span> <span class="se">\</span>
           -o -name <span class="s1">&#39;*.rst&#39;</span> <span class="se">\</span>
           -o -name <span class="s1">&#39;*.sh&#39;</span> <span class="se">\)</span> <span class="se">\</span>
         -exec egrep -H <span class="s1">&#39;(sudo|\$DOCKER)&#39;</span> <span class="o">{}</span> <span class="se">\;</span>
</pre></div>
</div>
</div>
<div class="section" id="openmpi-charliecloud-jobs-don-t-work">
<h2><a class="toc-backref" href="#id9">6.9. OpenMPI Charliecloud jobs don’t work</a><a class="headerlink" href="#openmpi-charliecloud-jobs-don-t-work" title="Permalink to this headline">¶</a></h2>
<p>MPI can be finicky. This section documents some of the problems we’ve seen.</p>
<div class="section" id="mpirun-can-t-launch-jobs">
<h3><a class="toc-backref" href="#id10">6.9.1. <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a><a class="headerlink" href="#mpirun-can-t-launch-jobs" title="Permalink to this headline">¶</a></h3>
<p>For example, you might see:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mpirun -np <span class="m">1</span> ch-run /var/tmp/mpihello -- /hello/hello
<span class="go">App launch reported: 2 (out of 2) daemons - 0 (out of 1) procs</span>
<span class="go">[cn001:27101] PMIX ERROR: BAD-PARAM in file src/dstore/pmix_esh.c at line 996</span>
</pre></div>
</div>
<p>We’re not yet sure why this happens — it may be a mismatch between the OpenMPI
builds inside and outside the container — but in our experience launching with
<code class="code docutils literal notranslate"><span class="pre">srun</span></code> often works when <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> doesn’t, so try that.</p>
</div>
<div class="section" id="my-ranks-can-t-talk-to-one-another-and-i-m-told-darth-vader-has-something-to-do-with-it">
<h3><a class="toc-backref" href="#id11">6.9.2. My ranks can’t talk to one another and I’m told Darth Vader has something to do with it</a><a class="headerlink" href="#my-ranks-can-t-talk-to-one-another-and-i-m-told-darth-vader-has-something-to-do-with-it" title="Permalink to this headline">¶</a></h3>
<p>OpenMPI has the notion of a <em>byte transport layer</em> (BTL), which is a module
that defines how messages are passed from one rank to another. There are many
different BTLs.</p>
<p>One is called <code class="code docutils literal notranslate"><span class="pre">vader</span></code>, and in OpenMPI 2.0 it enabled single-copy data
transfers between ranks on the same node. Previously by default, and in the
older <code class="code docutils literal notranslate"><span class="pre">sm</span></code> BTL, such messages had to be copied once into shared memory
and a second time into the destination process. Single-copy enables the
message to be copied directly from one rank to another. This gives significant
performance improvements in <a class="reference external" href="https://blogs.cisco.com/performance/the-vader-shared-memory-transport-in-open-mpi-now-featuring-3-flavors-of-zero-copy">benchmarks</a>,
though of course the real-world impact depends on the application.</p>
<p>One manifestation of this is in the LAMMPS molecular dynamics application:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> srun --cpus-per-task <span class="m">1</span> ch-run /var/tmp/lammps_mpi -- <span class="se">\</span>
  lmp_mpi -log none -in /lammps/examples/melt/in.melt
<span class="go">[cn002:21512] Read -1, expected 6144, errno = 1</span>
<span class="go">[cn001:23947] Read -1, expected 6144, errno = 1</span>
<span class="go">[cn002:21517] Read -1, expected 9792, errno = 1</span>
<span class="go">[... repeat thousands of times ...]</span>
</pre></div>
</div>
<p>With <code class="code docutils literal notranslate"><span class="pre">strace</span></code>, one can isolate the problem to the system call
<code class="code docutils literal notranslate"><span class="pre">process_vm_readv(2)</span></code> (and perhaps also <code class="code docutils literal notranslate"><span class="pre">process_vm_writev(2)</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">process_vm_readv(...) = -1 EPERM (Operation not permitted)</span>
<span class="go">write(33, &quot;[cn001:27673] Read -1, expected 6&quot;..., 48) = 48</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://man7.org/linux/man-pages/man2/process_vm_readv.2.html">man page</a>
reveals that these system calls require that the process have permission to
<code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code> one another, but sibling user namespaces <a class="reference external" href="http://man7.org/linux/man-pages/man2/ptrace.2.html">do not</a>. (You <em>can</em>
<code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code> into a child namespace, which is why <code class="code docutils literal notranslate"><span class="pre">gdb</span></code> doesn’t
require anything special in Charliecloud.)</p>
<p>This problem is not specific to containers; for example, many settings of
kernels with <a class="reference external" href="https://www.kernel.org/doc/Documentation/security/Yama.txt">YAMA</a> enabled will
similarly disallow this access.</p>
<p>Thus, <code class="code docutils literal notranslate"><span class="pre">vader</span></code> CMA does not currently work in Charliecloud by default. So
what can you do?</p>
<ul>
<li><p class="first">The easiest thing is to simply turn off single-copy. For most applications,
we suspect the performance impact will be minimal, but you should of course
evaluate that yourself. To do so, either set an environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export OMPI_MCA_btl_vader_single_copy_mechanism=none</span>
</pre></div>
</div>
<p>or add an argument to <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mpirun --mca btl_vader_single_copy_mechanism none ...
</pre></div>
</div>
</li>
<li><p class="first">The kernel module <a class="reference external" href="https://github.com/hjelmn/xpmem/tree/master/kernel">XPMEM</a> enables a different
single-copy approach. We have not yet tried this, and the module needs to be
evaluated for user namespace safety, but it’s quite a bit faster than CMA on
benchmarks.</p>
</li>
<li><p class="first">Wait. We are in communication with the OpenMPI developers on this, and they
may implement a fallback mechanism to keep your application working rather
than failing. This would, however, have the same performance impact as the
first approach.</p>
</li>
<li><p class="first">Heroics. With sufficient shell voodoo, one could get all the ranks into the
same user namespace, at which point the problem goes away.</p>
</li>
</ul>
<p>We are tracking this problem in <a class="reference external" href="https://github.com/hpc/charliecloud/issues/128">issue #128</a>. It is possible that we can
do something in Charliecloud to make it work, but we don’t know yet.</p>
</div>
</div>
<div class="section" id="how-do-i-run-x11-apps">
<h2><a class="toc-backref" href="#id12">6.10. How do I run X11 apps?</a><a class="headerlink" href="#how-do-i-run-x11-apps" title="Permalink to this headline">¶</a></h2>
<p>X11 applications should “just work”. For example, try this Dockerfile:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> debian:stretch</span>
<span class="k">RUN</span>    apt-get update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get install -y xterm
</pre></div>
</div>
<p>Build it and unpack it to <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code>. Then:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run /scratch/ch/xterm -- xterm
</pre></div>
</div>
<p>should pop an xterm.</p>
<p>If your X11 application doesn’t work, please file an issue so we can
figure out why.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="virtualbox.html" class="btn btn-neutral" title="5. VirtualBox appliance" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014–2018, Los Alamos National Security, LLC.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>