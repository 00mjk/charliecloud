

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Charliecloud command reference &mdash; Charliecloud 0.19~pre+fixsearch.60023a8 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Frequently asked questions (FAQ)" href="faq.html" />
    <link rel="prev" title="2. Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Charliecloud
          

          
            
            <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.19~pre+fixsearch.60023a8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Charliecloud command reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ch-build">3.1. ch-build</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#synopsis">3.1.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#description">3.1.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bugs">3.1.3. Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">3.1.4. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-build2dir">3.2. ch-build2dir</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">3.2.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.2.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.2.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-builder2tar">3.3. ch-builder2tar</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">3.3.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">3.3.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">3.3.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-checkns">3.4. ch-checkns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.4.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3.4.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">3.4.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-dir2squash">3.5. ch-dir2squash</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">3.5.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.5.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">3.5.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-builder2squash">3.6. ch-builder2squash</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">3.6.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">3.6.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">3.6.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-fromhost">3.7. ch-fromhost</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">3.7.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">3.7.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#options">3.7.3. Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#to-specify-which-files-to-inject">3.7.3.1. To specify which files to inject</a></li>
<li class="toctree-l4"><a class="reference internal" href="#to-specify-the-destination-within-the-image">3.7.3.2. To specify the destination within the image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#additional-arguments">3.7.3.3. Additional arguments</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cray-mpi-dependencies-and-quirks">3.7.4. <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> dependencies and quirks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notes">3.7.5. Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">3.7.6. Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">3.7.7. Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acknowledgements">3.7.8. Acknowledgements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-grow">3.8. ch-grow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id19">3.8.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">3.8.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conformance">3.8.3. Conformance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#quirks-of-a-fully-unprivileged-build">3.8.3.1. Quirks of a fully unprivileged build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#context-directory">3.8.3.2. Context directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication">3.8.3.3. Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#environment-variables">3.8.3.4. Environment variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy">3.8.3.5. <code class="code docutils literal notranslate"><span class="pre">COPY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#features-we-do-not-plan-to-support">3.8.3.6. Features we do not plan to support</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-mount">3.9. ch-mount</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id21">3.9.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">3.9.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id23">3.9.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-pull2dir">3.10. ch-pull2dir</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id24">3.10.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25">3.10.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id26">3.10.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-pull2tar">3.11. ch-pull2tar</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id27">3.11.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id28">3.11.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id29">3.11.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-run">3.12. ch-run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id30">3.12.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id31">3.12.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#host-files-and-directories-available-in-container-via-bind-mounts">3.12.3. Host files and directories available in container via bind mounts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-processes-in-the-same-container-with-join">3.12.4. Multiple processes in the same container with <code class="code docutils literal notranslate"><span class="pre">--join</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id32">3.12.5. Environment variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#default-behavior">3.12.5.1. Default behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-variables-with-set-env">3.12.5.2. Setting variables with <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#removing-variables-with-unset-env">3.12.5.3. Removing variables with <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id33">3.12.6. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-run-oci">3.13. ch-run-oci</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id34">3.13.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id35">3.13.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operations">3.13.3. Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create">3.13.3.1. <code class="code docutils literal notranslate"><span class="pre">create</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete">3.13.3.2. <code class="code docutils literal notranslate"><span class="pre">delete</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#kill">3.13.3.3. <code class="code docutils literal notranslate"><span class="pre">kill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#start">3.13.3.4. <code class="code docutils literal notranslate"><span class="pre">start</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#state">3.13.3.5. <code class="code docutils literal notranslate"><span class="pre">state</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#unsupported-oci-features">3.13.4. Unsupported OCI features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">3.13.5. Environment variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-ssh">3.14. ch-ssh</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id37">3.14.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id38">3.14.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id39">3.14.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-tar2dir">3.15. ch-tar2dir</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id40">3.15.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id41">3.15.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id42">3.15.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-test">3.16. ch-test</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id44">3.16.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id45">3.16.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exit-status">3.16.3. Exit status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id46">3.16.4. Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id47">3.16.5. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-tug">3.17. ch-tug</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id48">3.17.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id49">3.17.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id50">3.17.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-umount">3.18. ch-umount</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id51">3.18.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id52">3.18.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id53">3.18.3. Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">4. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">5. Contributor’s guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>3. Charliecloud command reference</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="charliecloud-command-reference">
<h1>3. Charliecloud command reference<a class="headerlink" href="#charliecloud-command-reference" title="Permalink to this headline">¶</a></h1>
<p>This section is a comprehensive description of the usage and arguments of the
Charliecloud commands. Its content is identical to the commands’ man pages.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#ch-build" id="id54">ch-build</a></li>
<li><a class="reference internal" href="#ch-build2dir" id="id55">ch-build2dir</a></li>
<li><a class="reference internal" href="#ch-builder2tar" id="id56">ch-builder2tar</a></li>
<li><a class="reference internal" href="#ch-checkns" id="id57">ch-checkns</a></li>
<li><a class="reference internal" href="#ch-dir2squash" id="id58">ch-dir2squash</a></li>
<li><a class="reference internal" href="#ch-builder2squash" id="id59">ch-builder2squash</a></li>
<li><a class="reference internal" href="#ch-fromhost" id="id60">ch-fromhost</a></li>
<li><a class="reference internal" href="#ch-grow" id="id61">ch-grow</a></li>
<li><a class="reference internal" href="#ch-mount" id="id62">ch-mount</a></li>
<li><a class="reference internal" href="#ch-pull2dir" id="id63">ch-pull2dir</a></li>
<li><a class="reference internal" href="#ch-pull2tar" id="id64">ch-pull2tar</a></li>
<li><a class="reference internal" href="#ch-run" id="id65">ch-run</a></li>
<li><a class="reference internal" href="#ch-run-oci" id="id66">ch-run-oci</a></li>
<li><a class="reference internal" href="#ch-ssh" id="id67">ch-ssh</a></li>
<li><a class="reference internal" href="#ch-tar2dir" id="id68">ch-tar2dir</a></li>
<li><a class="reference internal" href="#ch-test" id="id69">ch-test</a></li>
<li><a class="reference internal" href="#ch-tug" id="id70">ch-tug</a></li>
<li><a class="reference internal" href="#ch-umount" id="id71">ch-umount</a></li>
</ul>
</div>
<div class="section" id="ch-build">
<h2><a class="toc-backref" href="#id54">3.1. ch-build</a><a class="headerlink" href="#ch-build" title="Permalink to this headline">¶</a></h2>
<p>Build an image and place it in the builder’s back-end storage.</p>
<div class="section" id="synopsis">
<h3>3.1.1. Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build <span class="o">[</span>-b BUILDER<span class="o">]</span> <span class="o">[</span>--builder-info<span class="o">]</span> -t TAG <span class="o">[</span>ARGS ...<span class="o">]</span> CONTEXT
</pre></div>
</div>
</div>
<div class="section" id="description">
<h3>3.1.2. Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<p>Build an image named <code class="code docutils literal notranslate"><span class="pre">TAG</span></code> described by a Dockerfile. Place the result
into the builder’s back-end storage.</p>
<p>Using this script is <em>not</em> required for a working Charliecloud image. You can
also use any builder that can produce a Linux filesystem tree directly,
whether or not it is in the list below. However, this script hides the
vagaries of making the supported builders work smoothly with Charliecloud and
adds some conveniences (e.g., pass HTTP proxy environment variables to the
build environment if the builder doesn’t do this by default).</p>
<p>Supported builders, unprivileged:</p>
<blockquote>
<div><ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">buildah</span></code>: Buildah in “rootless” mode with no setuid helpers, using
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> (via <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code>) for <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions. This
requires Buildah v1.10.1+; see the install instructions.</li>
<li><code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code>: Our internal builder.</li>
</ul>
</div></blockquote>
<p>Supported builders, privileged:</p>
<blockquote>
<div><ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">buildah-runc</span></code>: Buildah in “rootless” mode with setuid
helpers, using the default <code class="code docutils literal notranslate"><span class="pre">runc</span></code> for <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions.</li>
<li><code class="code docutils literal notranslate"><span class="pre">buildah-setuid</span></code>: Buildah in “rootless” mode with setuid helpers,
using <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> (via <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code>) for <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instructions.</li>
<li><code class="code docutils literal notranslate"><span class="pre">docker</span></code>: Docker.</li>
</ul>
</div></blockquote>
<p>Specifying the builder, in descending order of priority:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--builder</span> <span class="pre">BUILDER</span></code></dt>
<dd>Command line option.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$CH_BUILDER</span></code></dt>
<dd>Environment variable</dd>
<dt>Default</dt>
<dd><code class="code docutils literal notranslate"><span class="pre">docker</span></code> if Docker is installed; otherwise, <code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code>.</dd>
</dl>
</div></blockquote>
<p>Other arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--builder-info</span></code></dt>
<dd>Print the builder to be used and its version, then exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">DOCKERFILE</span></code></dt>
<dd>Dockerfile to use (default: <code class="code docutils literal notranslate"><span class="pre">$CONTEXT/Dockerfile</span></code>)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span> <span class="pre">TAG</span></code></dt>
<dd>Name (tag) of Docker image to build.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>Print help and exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>Print version and exit.</dd>
</dl>
</div></blockquote>
<p>Additional arguments are accepted and passed unchanged to the underlying
builder.</p>
</div>
<div class="section" id="bugs">
<h3>3.1.3. Bugs<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h3>
<p>The tag suffix <code class="code docutils literal notranslate"><span class="pre">:latest</span></code> is somewhat misleading, as by default neither
<code class="code docutils literal notranslate"><span class="pre">ch-build</span></code> nor bare builders will notice if the base <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> image
has been updated. Use <code class="code docutils literal notranslate"><span class="pre">--pull</span></code> to make sure you have the latest base
image.</p>
</div>
<div class="section" id="examples">
<h3>3.1.4. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>Create an image tagged <code class="code docutils literal notranslate"><span class="pre">foo</span></code> and specified by the file
<code class="code docutils literal notranslate"><span class="pre">Dockerfile</span></code> located in the context directory. Use <code class="code docutils literal notranslate"><span class="pre">/bar</span></code> as the
Docker context directory. Use the default builder.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build -t foo /bar
</pre></div>
</div>
<p>Equivalent to above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build -t foo --file<span class="o">=</span>/bar/Dockerfile /bar
</pre></div>
</div>
<p>Instead, use <code class="code docutils literal notranslate"><span class="pre">/bar/Dockerfile.baz</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build -t foo --file<span class="o">=</span>/bar/Dockerfile.baz /bar
</pre></div>
</div>
<p>Equivalent to the first example, but use <code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> even if Docker is
installed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build -b ch-grow -t foo /bar
</pre></div>
</div>
<p>Equivalent to above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_BUILDER</span><span class="o">=</span>ch-grow
<span class="gp">$</span> ch-build -t foo /bar
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-build2dir">
<h2><a class="toc-backref" href="#id55">3.2. ch-build2dir</a><a class="headerlink" href="#ch-build2dir" title="Permalink to this headline">¶</a></h2>
<p>Build a Charliecloud image from Dockerfile and unpack it into a directory.</p>
<div class="section" id="id1">
<h3>3.2.1. Synopsis<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build2dir -t TAG <span class="o">[</span>ARGS ...<span class="o">]</span> CONTEXT OUTDIR
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>3.2.2. Description<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Build a Docker image named <code class="code docutils literal notranslate"><span class="pre">TAG</span></code> described by a Dockerfile (default
<code class="code docutils literal notranslate"><span class="pre">$CONTEXT/Dockerfile</span></code>) and unpack it into <code class="code docutils literal notranslate"><span class="pre">OUTDIR/TAG</span></code>. This is a
wrapper for <code class="code docutils literal notranslate"><span class="pre">ch-build</span></code>, <code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code>, and <code class="code docutils literal notranslate"><span class="pre">ch-tar2dir</span></code>;
see also those man pages.</p>
<p>Arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">ARGS</span></code></dt>
<dd>additional arguments passed to <code class="code docutils literal notranslate"><span class="pre">ch-build</span></code></dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CONTEXT</span></code></dt>
<dd>Docker context directory</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">OUTDIR</span></code></dt>
<dd>directory in which to place image directory (named <code class="code docutils literal notranslate"><span class="pre">TAG</span></code>) and
temporary tarball</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span> <span class="pre">TAG</span></code></dt>
<dd>name (tag) of Docker image to build</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id3">
<h3>3.2.3. Examples<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>To build using <code class="code docutils literal notranslate"><span class="pre">./Dockerfile</span></code> and create image directory
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/foo</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build2dir -t foo . /var/tmp
</pre></div>
</div>
<p>Same as above, but build with a different Dockerfile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-build2dir -t foo -f ./Dockerfile.foo . /var/tmp
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-builder2tar">
<h2><a class="toc-backref" href="#id56">3.3. ch-builder2tar</a><a class="headerlink" href="#ch-builder2tar" title="Permalink to this headline">¶</a></h2>
<p>Flatten a builder image into a Charliecloud image tarball.</p>
<div class="section" id="id4">
<h3>3.3.1. Synopsis<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-builder2tar <span class="o">[</span>-b BUILDER<span class="o">]</span> <span class="o">[</span>--nocompress<span class="o">]</span> IMAGE OUTDIR
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>3.3.2. Description<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Flatten the builder image tagged <code class="code docutils literal notranslate"><span class="pre">IMAGE</span></code> into a Charliecloud tarball in
directory <code class="code docutils literal notranslate"><span class="pre">OUTDIR</span></code>.</p>
<p>The builder-specified environment (e.g., <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> statements) is placed in
a file in the tarball at <code class="code docutils literal notranslate"><span class="pre">$IMAGE/ch/environment</span></code>, in a form suitable for
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--set-env</span></code>.</p>
<p>See <code class="code docutils literal notranslate"><span class="pre">ch-build(1)</span></code> for details on specifying the builder.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--builder</span> <span class="pre">BUILDER</span></code></dt>
<dd>Use specified builder; if not given, use <code class="code docutils literal notranslate"><span class="pre">$CH_BUILDER</span></code> or default.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--nocompress</span></code></dt>
<dd>Do not compress tarball.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>Print help and exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>Print version and exit.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="example">
<h3>3.3.3. Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-builder2tar hello /var/tmp
<span class="go">57M /var/tmp/hello.tar.gz</span>
<span class="gp">$</span> ls -lh /var/tmp
<span class="go">-rw-r-----  1 reidpr reidpr  57M Feb 13 16:14 hello.tar.gz</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-checkns">
<h2><a class="toc-backref" href="#id57">3.4. ch-checkns</a><a class="headerlink" href="#ch-checkns" title="Permalink to this headline">¶</a></h2>
<p>Check <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> prerequisites, e.g., namespaces and <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>.</p>
<div class="section" id="id6">
<h3>3.4.1. Synopsis<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-checkns
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>3.4.2. Description<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Check <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> prerequisites, e.g., namespaces and <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>.</p>
</div>
<div class="section" id="id8">
<h3>3.4.3. Example<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-checkns
<span class="go">ok</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-dir2squash">
<h2><a class="toc-backref" href="#id58">3.5. ch-dir2squash</a><a class="headerlink" href="#ch-dir2squash" title="Permalink to this headline">¶</a></h2>
<p>Create a SquashFS file from an image directory.</p>
<div class="section" id="id9">
<h3>3.5.1. Synopsis<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-dir2squash IMGDIR OUTDIR <span class="o">[</span>ARGS ...<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>3.5.2. Description<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Create Charliecloud SquashFS file from image directory <code class="code docutils literal notranslate"><span class="pre">IMGDIR</span></code> under
directory <code class="code docutils literal notranslate"><span class="pre">OUTDIR</span></code>, named as last component of <code class="code docutils literal notranslate"><span class="pre">IMGDIR</span></code> plus
suffix <code class="code docutils literal notranslate"><span class="pre">.sqfs</span></code>.</p>
<p>Optional <code class="code docutils literal notranslate"><span class="pre">ARGS</span></code> will passed to <code class="code docutils literal notranslate"><span class="pre">mksquashfs</span></code> unchanged.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id11">
<h3>3.5.3. Example<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-dir2squash /var/tmp/debian /var/tmp
<span class="go">Parallel mksquashfs: Using 6 processors</span>
<span class="go">Creating 4.0 filesystem on /var/tmp/debian.sqfs, block size 131072.</span>
<span class="go">[...]</span>
<span class="go">-rw-r--r--  1 charlie charlie 41M Apr 23 14:41 /var/tmp/debian.sqfs</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-builder2squash">
<h2><a class="toc-backref" href="#id59">3.6. ch-builder2squash</a><a class="headerlink" href="#ch-builder2squash" title="Permalink to this headline">¶</a></h2>
<p>Flatten a builder image into a Charliecloud SquashFS file.</p>
<div class="section" id="id12">
<h3>3.6.1. Synopsis<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-builder2squash <span class="o">[</span>-b BUILDER<span class="o">]</span> IMAGE OUTDIR <span class="o">[</span>ARGS ...<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>3.6.2. Description<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>Flattens the builder image tagged <code class="code docutils literal notranslate"><span class="pre">IMAGE</span></code> into a SquashFS file in
<code class="code docutils literal notranslate"><span class="pre">OUTDIR</span></code>.</p>
<p>Wrapper for <code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span> <span class="pre">--nocompress</span></code> and <code class="code docutils literal notranslate"><span class="pre">ch-tar2sqfs</span></code>.
Intermediate files and directories are removed.</p>
<p>Sudo privileges are required to run <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">export</span></code>.</p>
<p>Optional <code class="code docutils literal notranslate"><span class="pre">ARGS</span></code> passed to <code class="code docutils literal notranslate"><span class="pre">mksquashfs</span></code> unchanged.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id14">
<h3>3.6.3. Example<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> docker image list <span class="p">|</span> fgrep debian
<span class="go">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span>
<span class="go">debian       stretch   2d337f242f07   3 weeks ago  101MB</span>
<span class="gp">$</span> ch-builder2squash debian /var/tmp
<span class="go">Parallel mksquashfs: Using 6 processors</span>
<span class="go">Creating 4.0 filesystem on /var/tmp/debian.sqfs, block size 131072.</span>
<span class="go">[...]</span>
<span class="go">squashed /var/tmp/debian.sqfs OK</span>
<span class="gp">$</span> ls -lh /var/tmp/debian*
<span class="go">-rw-r--r-- 1 charlie charlie 41M Apr 23 14:37 debian.sqfs</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-fromhost">
<h2><a class="toc-backref" href="#id60">3.7. ch-fromhost</a><a class="headerlink" href="#ch-fromhost" title="Permalink to this headline">¶</a></h2>
<p>Inject files from the host into an image directory.</p>
<div class="section" id="id15">
<h3>3.7.1. Synopsis<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost <span class="o">[</span>OPTION ...<span class="o">]</span> <span class="o">[</span>FILE_OPTION ...<span class="o">]</span> IMGDIR
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h3>3.7.2. Description<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This command is experimental. Features may be incomplete and/or buggy.
Please report any issues you find, so we can fix them!</p>
</div>
<p>Inject files from the host into the Charliecloud image directory
<code class="code docutils literal notranslate"><span class="pre">IMGDIR</span></code>.</p>
<p>The purpose of this command is to provide host-specific files, such as GPU
libraries, to a container. It should be run after <code class="code docutils literal notranslate"><span class="pre">ch-tar2dir</span></code> and
before <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. After invocation, the image is no longer portable to
other hosts.</p>
<p>Injection is not atomic; if an error occurs partway through injection, the
image is left in an undefined state. Injection is currently implemented using
a simple file copy, but that may change in the future.</p>
<p>By default, file paths that contain the strings <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> or <code class="code docutils literal notranslate"><span class="pre">/sbin</span></code>
are assumed to be executables and placed in <code class="code docutils literal notranslate"><span class="pre">/usr/bin</span></code> within the
container. File paths that contain the strings <code class="code docutils literal notranslate"><span class="pre">/lib</span></code> or <code class="code docutils literal notranslate"><span class="pre">.so</span></code> are
assumed to be shared libraries and are placed in the first-priority directory
reported by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> (see <code class="code docutils literal notranslate"><span class="pre">--lib-path</span></code> below). Other files are
placed in the directory specified by <code class="code docutils literal notranslate"><span class="pre">--dest</span></code>.</p>
<p>If any shared libraries are injected, run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> inside the
container (using <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span></code>) after injection.</p>
</div>
<div class="section" id="options">
<h3>3.7.3. Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h3>
<div class="section" id="to-specify-which-files-to-inject">
<h4>3.7.3.1. To specify which files to inject<a class="headerlink" href="#to-specify-which-files-to-inject" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-c</span></code>, <code class="code docutils literal notranslate"><span class="pre">--cmd</span> <span class="pre">CMD</span></code></dt>
<dd>Inject files listed in the standard output of command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">FILE</span></code></dt>
<dd>Inject files listed in the file <code class="code docutils literal notranslate"><span class="pre">FILE</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-p</span></code>, <code class="code docutils literal notranslate"><span class="pre">--path</span> <span class="pre">PATH</span></code></dt>
<dd>Inject the file at <code class="code docutils literal notranslate"><span class="pre">PATH</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code></dt>
<dd>Cray-enable MPICH/OpenMPI installed inside the image. See important details
below.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code></dt>
<dd>Use <code class="code docutils literal notranslate"><span class="pre">nvidia-container-cli</span> <span class="pre">list</span></code> (from <code class="code docutils literal notranslate"><span class="pre">libnvidia-container</span></code>)
to find executables and libraries to inject.</dd>
</dl>
</div></blockquote>
<p>These can be repeated, and at least one must be specified.</p>
</div>
<div class="section" id="to-specify-the-destination-within-the-image">
<h4>3.7.3.2. To specify the destination within the image<a class="headerlink" href="#to-specify-the-destination-within-the-image" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-d</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dest</span> <span class="pre">DST</span></code></dt>
<dd>Place files specified later in directory <code class="code docutils literal notranslate"><span class="pre">IMGDIR/DST</span></code>, overriding the
inferred destination, if any. If a file’s destination cannot be inferred
and <code class="code docutils literal notranslate"><span class="pre">--dest</span></code> has not been specified, exit with an error. This can be
repeated to place files in varying destinations.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="additional-arguments">
<h4>3.7.3.3. Additional arguments<a class="headerlink" href="#additional-arguments" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--lib-path</span></code></dt>
<dd>Print the guest destination path for shared libraries inferred as
described above.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-ldconfig</span></code></dt>
<dd>Don’t run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> even if we appear to have injected shared
libraries.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>Print help and exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt>
<dd>List the injected files.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>Print version and exit.</dd>
</dl>
</div></blockquote>
</div>
</div>
<div class="section" id="cray-mpi-dependencies-and-quirks">
<h3>3.7.4. <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> dependencies and quirks<a class="headerlink" href="#cray-mpi-dependencies-and-quirks" title="Permalink to this headline">¶</a></h3>
<p>The implementation of <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> is messy, foul smelling, and brittle.
It replaces or overrides the MPICH or OpenMPI libraries installed in the
container. Users should be aware of the following.</p>
<ol class="arabic simple">
<li>Containers must have the following software installed:<ol class="loweralpha">
<li>Corresponding open source MPI implementation. (<a class="reference external" href="https://www.mpich.org/">MPICH</a> and <a class="reference external" href="https://www.open-mpi.org/">OpenMPI</a>.)</li>
<li><a class="reference external" href="https://github.com/hpc/patchelf">PatchELF with our patches</a>.
Use the <code class="code docutils literal notranslate"><span class="pre">shrink-soname</span></code> branch. (MPICH only.)</li>
<li><code class="code docutils literal notranslate"><span class="pre">libgfortran.so.3</span></code>, because Cray’s <code class="code docutils literal notranslate"><span class="pre">libmpi.so.12</span></code>
links to it. (MPICH only.)</li>
</ol>
</li>
<li>Applications must be dynamically linked to <code class="code docutils literal notranslate"><span class="pre">libmpi.so.12</span></code> (not e.g.
<code class="code docutils literal notranslate"><span class="pre">libmpich.so.12</span></code>).<ol class="loweralpha">
<li>How to configure MPICH to accomplish this is not yet clear to us;
<code class="code docutils literal notranslate"><span class="pre">test/Dockerfile.mpich</span></code> does it, while the Debian packages do not.
(MPICH only.)</li>
</ol>
</li>
<li>An ABI compatible module for the given MPI implementation must be loaded
when <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code> is invoked.<ol class="loweralpha">
<li>Load the <code class="code docutils literal notranslate"><span class="pre">cray-mpich-abi</span></code> module. (MPICH only.)</li>
<li>We recommend loading the module of a version as close to what
is installed in the image as possible. This OpenMPI install needs to be
built such that libmpi contains all needed plugins (as opposed to them
being standalone shared libraries). See <a class="reference external" href="https://www.open-mpi.org/faq/?category=building">OpenMPI’s documentation</a> for how to do this.
(OpenMPI only.)</li>
</ol>
</li>
<li>Tested only for C programs compiled with GCC, and it probably won’t work
otherwise. If you’d like to use another compiler or another programming
language, please get in touch so we can implement the necessary support.</li>
</ol>
<p>Please file a bug if we missed anything above or if you know how to make the
code better.</p>
</div>
<div class="section" id="notes">
<h3>3.7.5. Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h3>
<p>Symbolic links are dereferenced, i.e., the files pointed to are injected, not
the links themselves.</p>
<p>As a corollary, do not include symlinks to shared libraries. These will be
re-created by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>.</p>
<p>There are two alternate approaches for nVidia GPU libraries:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Link <code class="code docutils literal notranslate"><span class="pre">libnvidia-containers</span></code> into <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> and call the
library functions directly. However, this would mean that Charliecloud
would either (a) need to be compiled differently on machines with and
without nVidia GPUs or (b) have <code class="code docutils literal notranslate"><span class="pre">libnvidia-containers</span></code> available
even on machines without nVidia GPUs. Neither of these is consistent with
Charliecloud’s philosophies of simplicity and minimal dependencies.</li>
<li>Use <code class="code docutils literal notranslate"><span class="pre">nvidia-container-cli</span> <span class="pre">configure</span></code> to do the injecting. This
would require that containers have a half-started state, where the
namespaces are active and everything is mounted but <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>
has not been performed. This is not feasible because Charliecloud has no
notion of a half-started container.</li>
</ol>
</div></blockquote>
<p>Further, while these alternate approaches would simplify or eliminate this
script for nVidia GPUs, they would not solve the problem for other situations.</p>
</div>
<div class="section" id="id17">
<h3>3.7.6. Bugs<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>File paths may not contain colons or newlines.</p>
</div>
<div class="section" id="id18">
<h3>3.7.7. Examples<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>Place shared library <code class="code docutils literal notranslate"><span class="pre">/usr/lib64/libfoo.so</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/usr/lib/libfoo.so</span></code> (assuming <code class="code docutils literal notranslate"><span class="pre">/usr/lib</span></code> is the first directory
searched by the dynamic loader in the image), within the image
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/baz</span></code> and executable <code class="code docutils literal notranslate"><span class="pre">/bin/bar</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/usr/bin/bar</span></code>. Then, create appropriate symlinks to <code class="code docutils literal notranslate"><span class="pre">libfoo</span></code> and
update the <code class="code docutils literal notranslate"><span class="pre">ld.so</span></code> cache.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat qux.txt
<span class="go">/bin/bar</span>
<span class="go">/usr/lib64/libfoo.so</span>
<span class="gp">$</span> ch-fromhost --file qux.txt /var/tmp/baz
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --cmd <span class="s1">&#39;cat qux.txt&#39;</span> /var/tmp/baz
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --path /bin/bar --path /usr/lib64/libfoo.so /var/tmp/baz
</pre></div>
</div>
<p>Same as above, but place the files into <code class="code docutils literal notranslate"><span class="pre">/corge</span></code> instead (and the shared
library will not be found by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --dest /corge --file qux.txt /var/tmp/baz
</pre></div>
</div>
<p>Same as above, and also place file <code class="code docutils literal notranslate"><span class="pre">/etc/quux</span></code> at <code class="code docutils literal notranslate"><span class="pre">/etc/quux</span></code>
within the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --file qux.txt --dest /etc --path /etc/quux /var/tmp/baz
</pre></div>
</div>
<p>Inject the executables and libraries recommended by nVidia into the image, and
then run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --nvidia /var/tmp/baz
</pre></div>
</div>
<p>Inject the Cray-enabled MPI libraries into the image, and then run
<code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --cray-mpi /var/tmp/baz
</pre></div>
</div>
</div>
<div class="section" id="acknowledgements">
<h3>3.7.8. Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h3>
<p>This command was inspired by the similar <a class="reference external" href="http://www.nersc.gov/research-and-development/user-defined-images/">Shifter</a> feature
that allows Shifter containers to use the Cray Aries network. We particularly
appreciate the help provided by Shane Canon and Doug Jacobsen during our
implementation of <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code>.</p>
<p>We appreciate the advice of Ryan Olson at nVidia on implementing
<code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code>.</p>
</div>
</div>
<div class="section" id="ch-grow">
<h2><a class="toc-backref" href="#id61">3.8. ch-grow</a><a class="headerlink" href="#ch-grow" title="Permalink to this headline">¶</a></h2>
<p>Build an image from a Dockerfile; completely unprivileged.</p>
<div class="section" id="id19">
<h3>3.8.1. Synopsis<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-grow <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="o">[</span>-t TAG<span class="o">]</span> <span class="o">[</span>-f DOCKERFILE<span class="o">]</span> CONTEXT
</pre></div>
</div>
</div>
<div class="section" id="id20">
<h3>3.8.2. Description<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>Build an image named <code class="code docutils literal notranslate"><span class="pre">TAG</span></code> as specified in <code class="code docutils literal notranslate"><span class="pre">DOCKERFILE</span></code>; use
<code class="code docutils literal notranslate"><span class="pre">ch-run(1)</span></code> to execute <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions. This builder is
completely unprivileged, with no setuid/setgid/setcap helpers.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> maintains state and temporary images using normal files and
directories. This storage directory can reside on any filesystem, and its
location is configurable. In descending order of priority:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--storage</span> <span class="pre">DIR</span></code></dt>
<dd>Command line option.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$CH_GROW_STORAGE</span></code></dt>
<dd>Environment variable.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER/ch-grow</span></code></dt>
<dd>Default.</dd>
</dl>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Images are stored unpacked, so place your storage directory on a filesystem
that can handle the metadata traffic for large numbers of small files. For
example, the Charliecloud test suite uses approximately 400,000 files and
directories.</p>
</div>
<p>Other arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">CONTEXT</span></code></dt>
<dd>Context directory; this is the root of <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> and <code class="code docutils literal notranslate"><span class="pre">ADD</span></code>
instructions in the Dockerfile.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">KEY[=VALUE]</span></code></dt>
<dd>Set build-time variable <code class="code docutils literal notranslate"><span class="pre">KEY</span></code> defined by <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction
to <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code>. If <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code> not specified, use the value of
environment variable <code class="code docutils literal notranslate"><span class="pre">KEY</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dependencies</span></code></dt>
<dd>Report any dependency problems and exit. If all is well, there is no
output and the exit code is zero; in case of problems, the exit code is
non-zero.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">DOCKERFILE</span></code></dt>
<dd>Use <code class="code docutils literal notranslate"><span class="pre">DOCKERFILE</span></code> instead of <code class="code docutils literal notranslate"><span class="pre">CONTEXT/Dockerfile</span></code>. Specify a
single hyphen (<code class="code docutils literal notranslate"><span class="pre">-</span></code>) to use standard input; note that in this case,
the context directory is still provided, which matches <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span>
<span class="pre">-f</span> <span class="pre">-</span></code> behavior.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>Print help and exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-n</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt>
<dd>Do not actually execute any Dockerfile instructions.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-cache</span></code></dt>
<dd>Ignored (<code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> does not yet support layer caching).</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--parse-only</span></code></dt>
<dd>Stop after parsing the Dockerfile.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--print-storage</span></code></dt>
<dd>Print the storage directory path and exit. Must be after
<code class="code docutils literal notranslate"><span class="pre">--storage</span></code>, if any, for correct results.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span></code>, <code class="code docutils literal notranslate"><span class="pre">-tag</span> <span class="pre">TAG</span></code></dt>
<dd>Name of image to create. Append <code class="code docutils literal notranslate"><span class="pre">:latest</span></code> if no colon present.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt>
<dd>Print extra chatter; can be repeated.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>Print version number and exit.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="conformance">
<h3>3.8.3. Conformance<a class="headerlink" href="#conformance" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> is an independent implementation and shares no code with other
Dockerfile interpreters. It uses a formal Dockerfile parsing grammar developed
from the <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference documentation</a> and miscellaneous other
sources, which you can examine in the source code.</p>
<p>We believe this indedendence is valuable for several reasons. First, it helps
the community examine Dockerfile syntax and semantics critically, think
rigorously about what is really needed, and build a more robust standard.
Second, it yields disjoint sets of bugs (note that Podman, Buildah, and Docker
all share the same Dockerfile parser). Third, because it is a much smaller
code base, it illustrates how Dockerfiles work more clearly. Finally, it
allows straightforward extensions if needed to support scientific computing.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> tries hard to be compatible with Docker and other
interpreters, though as an independent implementation, it is not
bug-compatible.</p>
<p>This section describes differences from the Dockerfile reference that we
expect to be approximately permanent. For an overview of features we have not
yet implemented and our plans, see our <a class="reference external" href="https://github.com/hpc/charliecloud/projects/1">road map</a> on GitHub. Plain old bugs
are in our <a class="reference external" href="https://github.com/hpc/charliecloud/issues">GitHub issues</a>.</p>
<p>None of these are set in stone. We are very interested in feedback on our
assessments and open questions. This helps us prioritize new features and
revise our thinking about what is needed for HPC containers.</p>
<div class="section" id="quirks-of-a-fully-unprivileged-build">
<h4>3.8.3.1. Quirks of a fully unprivileged build<a class="headerlink" href="#quirks-of-a-fully-unprivileged-build" title="Permalink to this headline">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> is <em>fully</em> unprivileged. It runs all instructions as the
normal user who invokes it, does not use any setuid or setcap helper programs,
and does not use <code class="code docutils literal notranslate"><span class="pre">/etc/subuid</span></code> or <code class="code docutils literal notranslate"><span class="pre">/etc/subgid</span></code>, in contrast to
the “rootless” mode of some competing builders.</p>
<p><code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions are executed with <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--uid=0</span> <span class="pre">--gid=0</span></code>,
i.e., host EUID and EGID both mapped to zero inside the container, and only
one UID (zero) and GID (zero) are available inside the container. Also,
<code class="code docutils literal notranslate"><span class="pre">/etc/passwd</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/group</span></code> are bind-mounted from temporary
files outside the container and can’t be written. (Strictly speaking, the
files themselves are read-write, but because they are bind-mounted, the common
pattern of writing a new file and moving it on top of the existing one fails.)</p>
<p>This has two consequences: the shell and its children appear to be running as
root but only some privileged system calls are available, and manipulating
users and groups will fail. This confuses some programs, which fail with
“permission denied” and related errors; for example, <code class="code docutils literal notranslate"><span class="pre">chgrp(1)</span></code> often
appears in Debian package post-install scripts. We have worked around some of
these problems, but many remain. Another manual workaround is to install
<code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code> in the Dockerfile and prepend <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code> to problem
commands.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Most of these issues affect <em>any</em> fully unprivileged container build, not
just <code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code>. We are working to better characterize the problems
and add automatic workarounds.</p>
</div>
</div>
<div class="section" id="context-directory">
<h4>3.8.3.2. Context directory<a class="headerlink" href="#context-directory" title="Permalink to this headline">¶</a></h4>
<p>The context directory is bind-mounted into the build, rather than copied like
Docker. Thus, the size of the context is immaterial, and the build reads
directly from storage like any other local process would. However, you still
can’t access anything outside the context directory.</p>
</div>
<div class="section" id="authentication">
<h4>3.8.3.3. Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> can authenticate using one-time passwords, e.g. those provided
by a security token. Unlike <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">login</span></code>, it does not assume passwords
are persistent.</p>
</div>
<div class="section" id="environment-variables">
<h4>3.8.3.4. Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h4>
<p>Variable substitution happens for <em>all</em> instructions, not just the ones listed
in the Dockerfile reference.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ARG</span></code> and <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> cause cache misses upon <em>definition</em>, in contrast
with Docker where these variables miss upon <em>use</em>, except for certain
cache-excluded variables that never cause misses, listed below.</p>
<p>Like Docker, <code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> pre-defines the following proxy variables, which
do not require an <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction. However, they are available if the
same-named environment variable is defined; <code class="code docutils literal notranslate"><span class="pre">--build-arg</span></code> is not
required. Changes to these variables do not cause a cache miss.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>HTTP_PROXY
http_proxy
HTTPS_PROXY
https_proxy
FTP_PROXY
ftp_proxy
NO_PROXY
no_proxy
</pre></div>
</div>
<p>The following variables are also pre-defined:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">PATH</span><span class="o">=</span>/ch/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
<span class="nv">TAR_OPTIONS</span><span class="o">=</span>--no-same-owner
</pre></div>
</div>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> and <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> have different syntax despite very
similar semantics.</p>
</div>
<div class="section" id="copy">
<h4>3.8.3.5. <code class="code docutils literal notranslate"><span class="pre">COPY</span></code><a class="headerlink" href="#copy" title="Permalink to this headline">¶</a></h4>
<p>Especially for people used to UNIX <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code>, the semantics of the
Dockerfile <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instruction can be confusing.</p>
<p>Most notably, when a source of the copy is a directory, the <em>contents</em> of that
directory, not the directory itself, are copied. This is documented, but it’s
a real gotcha because that’s not what <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> does, and it means that
many things you can do in one <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> command require multiple
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instructions.</p>
<p>Also, the reference documentation is incomplete. In our experience, Docker
also behaves as follows; <code class="code docutils literal notranslate"><span class="pre">ch-grow</span></code> does the same in an attempt to be
bug-compatible for the <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instructions.</p>
<ol class="arabic simple">
<li>You can use absolute paths in the source; the root is the context
directory.</li>
<li>Destination directories are created if they don’t exist in the following
situations:<ol class="arabic">
<li>If the destination path ends in slash. (Documented.)</li>
<li>If the number of sources is greater than 1, either by wildcard or
explicitly, regardless of whether the destination ends in slash. (Not
documented.)</li>
<li>If there is a single source and it is a directory. (Not documented.)</li>
</ol>
</li>
<li>Symbolic links are particularly messy (this is not documented):<ol class="arabic">
<li>If named in sources either explicitly or by wildcard, symlinks are
dereferenced, i.e., the result is a copy of the symlink target, not the
symlink itself. Keep in mind that directory contents are copied, not
directories.</li>
<li>If within a directory named in sources, symlinks are copied as symlinks.</li>
</ol>
</li>
</ol>
<p>We expect the following differences to be permanent:</p>
<ul class="simple">
<li>Wildcards use Python glob semantics, not the Go semantics.</li>
<li><code class="code docutils literal notranslate"><span class="pre">COPY</span> <span class="pre">--chown</span></code> is ignored, because it doesn’t make sense in an
unprivileged build.</li>
</ul>
</div>
<div class="section" id="features-we-do-not-plan-to-support">
<h4>3.8.3.6. Features we do not plan to support<a class="headerlink" href="#features-we-do-not-plan-to-support" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Parser directives are not supported. We have not identified a need for any
of them.</li>
<li><code class="code docutils literal notranslate"><span class="pre">EXPOSE</span></code>: Charliecloud does not use the network namespace, so
containerized processes can simply listen on a host port like other
unprivileged processes.</li>
<li><code class="code docutils literal notranslate"><span class="pre">HEALTHCHECK</span></code>: This instruction’s main use case is monitoring server
processes rather than applications. Also, implementing it requires a
container supervisor daemon, which we have no plans to add.</li>
<li><code class="code docutils literal notranslate"><span class="pre">MAINTAINER</span></code> is deprecated.</li>
<li><code class="code docutils literal notranslate"><span class="pre">STOPSIGNAL</span></code> requires a container supervisor daemon process, which we
have no plans to add.</li>
<li><code class="code docutils literal notranslate"><span class="pre">USER</span></code> does not make sense for unprivileged builds.</li>
<li><code class="code docutils literal notranslate"><span class="pre">VOLUME</span></code>: This instruction is not currently supported. Charliecloud
has good support for bind mounts; we anticipate that it will continue to
focus on that and will not introduce the volume management features that
Docker has.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="ch-mount">
<h2><a class="toc-backref" href="#id62">3.9. ch-mount</a><a class="headerlink" href="#ch-mount" title="Permalink to this headline">¶</a></h2>
<p>Mount a SquashFS image file using FUSE.</p>
<div class="section" id="id21">
<h3>3.9.1. Synopsis<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-mount SQFS PARENTDIR
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h3>3.9.2. Description<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<p>Create new empty directory named <code class="code docutils literal notranslate"><span class="pre">SQFS</span></code> with suffix (e.g.,
<code class="code docutils literal notranslate"><span class="pre">.sqfs</span></code>) removed, then mount <code class="code docutils literal notranslate"><span class="pre">SQFS</span></code> on this new directory. This
new directory must not already exist.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id23">
<h3>3.9.3. Example<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-mount /var/tmp/debian.sqfs /var/tmp
<span class="gp">$</span> ls /var/tmp/debian
<span class="go">bin   dev  home  lib64  mnt  proc  run   srv  tmp  var</span>
<span class="go">boot  etc  lib   media  opt  root  sbin  sys  usr  WEIRD_AL_YANKOVIC</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-pull2dir">
<h2><a class="toc-backref" href="#id63">3.10. ch-pull2dir</a><a class="headerlink" href="#ch-pull2dir" title="Permalink to this headline">¶</a></h2>
<p>Pull image from a Docker Hub and unpack into directory.</p>
<div class="section" id="id24">
<h3>3.10.1. Synopsis<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-pull2dir IMAGE<span class="o">[</span>:TAG<span class="o">]</span> DIR
</pre></div>
</div>
</div>
<div class="section" id="id25">
<h3>3.10.2. Description<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>Pull Docker image named <code class="code docutils literal notranslate"><span class="pre">IMAGE[:TAG]</span></code> from Docker Hub and extract it
into a subdirectory of <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>. A temporary tarball is stored in
<code class="code docutils literal notranslate"><span class="pre">DIR</span></code>.</p>
<p>Sudo privileges are required to run the <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code> command.</p>
<p>This runs the following command sequence: <code class="code docutils literal notranslate"><span class="pre">ch-pull2tar</span></code>,
<code class="code docutils literal notranslate"><span class="pre">ch-tar2dir</span></code>. See warning in the documentation for <code class="code docutils literal notranslate"><span class="pre">ch-tar2dir</span></code>.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id26">
<h3>3.10.3. Examples<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-pull2dir alpine /var/tmp
<span class="go">Using default tag: latest</span>
<span class="go">latest: Pulling from library/alpine</span>
<span class="go">Digest: sha256:621c2f39f8133acb8e64023a94dbdf0d5ca81896102b9e57c0dc184cadaf5528</span>
<span class="go">Status: Image is up to date for alpine:latest</span>
<span class="go">-rw-r--r--. 1 charlie charlie 2.1M Oct  5 19:52 /var/tmp/alpine.tar.gz</span>
<span class="go">creating new image /var/tmp/alpine</span>
<span class="go">/var/tmp/alpine unpacked ok</span>
<span class="go">removed &#39;/var/tmp/alpine.tar.gz&#39;</span>
</pre></div>
</div>
<p>Same as above, except optional <code class="code docutils literal notranslate"><span class="pre">TAG</span></code> is specified:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-pull2dir alpine:3.6 /var/tmp
<span class="go">3.6: Pulling from library/alpine</span>
<span class="go">Digest: sha256:cc24af836d1377e092ecb4e8f0a4324c3b1aa2b5295c2239edcc7bbc86a9cbc6</span>
<span class="go">Status: Image is up to date for alpine:3.6</span>
<span class="go">-rw-r--r--. 1 charlie charlie 2.1M Oct  5 19:54 /var/tmp/alpine:3.6.tar.gz</span>
<span class="go">creating new image /var/tmp/alpine:3.6</span>
<span class="go">/var/tmp/alpine:3.6 unpacked ok</span>
<span class="go">removed &#39;/var/tmp/alpine:3.6.tar.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-pull2tar">
<h2><a class="toc-backref" href="#id64">3.11. ch-pull2tar</a><a class="headerlink" href="#ch-pull2tar" title="Permalink to this headline">¶</a></h2>
<p>Pull image from a Docker Hub and flatten into tarball.</p>
<div class="section" id="id27">
<h3>3.11.1. Synopsis<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-pull2tar IMAGE<span class="o">[</span>:TAG<span class="o">]</span> OUTDIR
</pre></div>
</div>
</div>
<div class="section" id="id28">
<h3>3.11.2. Description<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>Pull a Docker image named <code class="code docutils literal notranslate"><span class="pre">IMAGE[:TAG]</span></code> from Docker Hub and flatten it
into a Charliecloud tarball in directory <code class="code docutils literal notranslate"><span class="pre">OUTDIR</span></code>.</p>
<p>This runs the following command sequence: <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code>,
<code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code> but provides less flexibility than the individual
commands.</p>
<p>Sudo privileges are required for <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code>.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id29">
<h3>3.11.3. Examples<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-pull2tar alpine /var/tmp
<span class="go">Using default tag: latest</span>
<span class="go">latest: Pulling from library/alpine</span>
<span class="go">Digest: sha256:621c2f39f8133acb8e64023a94dbdf0d5ca81896102b9e57c0dc184cadaf5528</span>
<span class="go">Status: Image is up to date for alpine:latest</span>
<span class="go">-rw-r--r--. 1 charlie charlie 2.1M Oct  5 19:52 /var/tmp/alpine.tar.gz</span>
</pre></div>
</div>
<p>Same as above, except optional <code class="code docutils literal notranslate"><span class="pre">TAG</span></code> is specified:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-pull2tar alpine:3.6
<span class="go">3.6: Pulling from library/alpine</span>
<span class="go">Digest: sha256:cc24af836d1377e092ecb4e8f0a4324c3b1aa2b5295c2239edcc7bbc86a9cbc6</span>
<span class="go">Status: Image is up to date for alpine:3.6</span>
<span class="go">-rw-r--r--. 1 charlie charlie 2.1M Oct  5 19:54 /var/tmp/alpine:3.6.tar.gz</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-run">
<span id="man-ch-run"></span><h2><a class="toc-backref" href="#id65">3.12. ch-run</a><a class="headerlink" href="#ch-run" title="Permalink to this headline">¶</a></h2>
<p>Run a command in a Charliecloud container.</p>
<div class="section" id="id30">
<h3>3.12.1. Synopsis<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run <span class="o">[</span>OPTION...<span class="o">]</span> NEWROOT CMD <span class="o">[</span>ARG...<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id31">
<h3>3.12.2. Description<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p>Run command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code> in a Charliecloud container using the flattened and
unpacked image directory located at <code class="code docutils literal notranslate"><span class="pre">NEWROOT</span></code>.</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--bind=SRC[:DST]</span></code></dt>
<dd>mount <code class="code docutils literal notranslate"><span class="pre">SRC</span></code> at guest <code class="code docutils literal notranslate"><span class="pre">DST</span></code> (default <code class="code docutils literal notranslate"><span class="pre">/mnt/0</span></code>,
<code class="code docutils literal notranslate"><span class="pre">/mnt/1</span></code>, etc.)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-c</span></code>, <code class="code docutils literal notranslate"><span class="pre">--cd=DIR</span></code></dt>
<dd>initial working directory in container</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--ch-ssh</span></code></dt>
<dd>bind <code class="code docutils literal notranslate"><span class="pre">ch-ssh(1)</span></code> into container at <code class="code docutils literal notranslate"><span class="pre">/usr/bin/ch-ssh</span></code></dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-g</span></code>, <code class="code docutils literal notranslate"><span class="pre">--gid=GID</span></code></dt>
<dd>run as group <code class="code docutils literal notranslate"><span class="pre">GID</span></code> within container</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-j</span></code>, <code class="code docutils literal notranslate"><span class="pre">--join</span></code></dt>
<dd>use the same container (namespaces) as peer <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-pid=PID</span></code></dt>
<dd>join the namespaces of an existing process</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-ct=N</span></code></dt>
<dd>number of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peers (implies <code class="code docutils literal notranslate"><span class="pre">--join</span></code>; default: see below)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-tag=TAG</span></code></dt>
<dd>label for <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peer group (implies <code class="code docutils literal notranslate"><span class="pre">--join</span></code>; default: see
below)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-home</span></code></dt>
<dd>do not bind-mount your home directory (by default, your home directory is
mounted at <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code> in the container)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span></code>, <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code></dt>
<dd>use container-private <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> (by default, <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is shared with
the host)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--set-env=FILE</span></code></dt>
<dd>set environment variables as specified in host path <code class="code docutils literal notranslate"><span class="pre">FILE</span></code></dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-u</span></code>, <code class="code docutils literal notranslate"><span class="pre">--uid=UID</span></code></dt>
<dd>run as user <code class="code docutils literal notranslate"><span class="pre">UID</span></code> within container</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--unset-env=GLOB</span></code></dt>
<dd>unset environment variables whose names match <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code></dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt>
<dd>be more verbose (debug if repeated)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-w</span></code>, <code class="code docutils literal notranslate"><span class="pre">--write</span></code></dt>
<dd>mount image read-write (by default, the image is mounted read-only)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-?</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--usage</span></code></dt>
<dd>print a short usage message and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-V</span></code>, <code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="host-files-and-directories-available-in-container-via-bind-mounts">
<h3>3.12.3. Host files and directories available in container via bind mounts<a class="headerlink" href="#host-files-and-directories-available-in-container-via-bind-mounts" title="Permalink to this headline">¶</a></h3>
<p>In addition to any directories specified by the user with <code class="code docutils literal notranslate"><span class="pre">--bind</span></code>,
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> has standard host files and directories that are bind-mounted
in as well.</p>
<p>The following host files and directories are bind-mounted at the same location
in the container. These cannot be disabled.</p>
<blockquote>
<div><ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">/dev</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">/etc/passwd</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">/etc/group</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">/etc/hosts</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">/proc</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">/sys</span></code></li>
</ul>
</div></blockquote>
<p>Three additional bind mounts can be disabled by the user:</p>
<blockquote>
<div><ul class="simple">
<li>Your home directory (i.e., <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code>) is mounted at guest
<code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code> by default. This is accomplished by mounting a new
<code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> at <code class="code docutils literal notranslate"><span class="pre">/home</span></code>, which hides any image content under that
path. If <code class="code docutils literal notranslate"><span class="pre">--no-home</span></code> is specified, neither of these things happens
and the image’s <code class="code docutils literal notranslate"><span class="pre">/home</span></code> is exposed unaltered.</li>
<li><code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is shared with the host by default. If <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code>
is specified, a new <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> is mounted on the guest’s <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>
instead.</li>
<li>If file <code class="code docutils literal notranslate"><span class="pre">/usr/bin/ch-ssh</span></code> is present in the image, it is
over-mounted with the <code class="code docutils literal notranslate"><span class="pre">ch-ssh</span></code> binary in the same directory as
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="multiple-processes-in-the-same-container-with-join">
<h3>3.12.4. Multiple processes in the same container with <code class="code docutils literal notranslate"><span class="pre">--join</span></code><a class="headerlink" href="#multiple-processes-in-the-same-container-with-join" title="Permalink to this headline">¶</a></h3>
<p>By default, different <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations use different user and mount
namespaces (i.e., different containers). While this has no impact on sharing
most resources between invocations, there are a few important exceptions.
These include:</p>
<ol class="arabic simple">
<li><code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code>, used by debuggers and related tools. One can attach a
debugger to processes in descendant namespaces, but not sibling namespaces.
The practical effect of this is that (without <code class="code docutils literal notranslate"><span class="pre">--join</span></code>), you can’t
run a command with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> and then attach to it with a debugger
also run with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</li>
<li><em>Cross-memory attach</em> (CMA) is used by cooperating processes to communicate
by simply reading and writing one another’s memory. This is also not
permitted between sibling namespaces. This affects various MPI
implementations that use CMA to pass messages between ranks on the same
node, because it’s faster than traditional shared memory.</li>
</ol>
<p><code class="code docutils literal notranslate"><span class="pre">--join</span></code> is designed to address this by placing related <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
commands (the “peer group”) in the same container. This is done by one of the
peers creating the namespaces with <code class="code docutils literal notranslate"><span class="pre">unshare(2)</span></code> and the others joining
with <code class="code docutils literal notranslate"><span class="pre">setns(2)</span></code>.</p>
<p>To do so, we need to know the number of peers and a name for the group. These
are specified by additional arguments that can (hopefully) be left at default
values in most cases:</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">--join-ct</span></code> sets the number of peers. The default is the value of the
first of the following environment variables that is defined:
<code class="code docutils literal notranslate"><span class="pre">OMPI_COMM_WORLD_LOCAL_SIZE</span></code>, <code class="code docutils literal notranslate"><span class="pre">SLURM_STEP_TASKS_PER_NODE</span></code>,
<code class="code docutils literal notranslate"><span class="pre">SLURM_CPUS_ON_NODE</span></code>.</li>
<li><code class="code docutils literal notranslate"><span class="pre">--join-tag</span></code> sets the tag that names the peer group. The default is
environment variable <code class="code docutils literal notranslate"><span class="pre">SLURM_STEP_ID</span></code>, if defined; otherwise, the PID
of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s parent. Tags can be re-used for peer groups that start
at different times, i.e., once all peer <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> have replaced
themselves with the user command, the tag can be re-used.</li>
</ul>
<p>Caveats:</p>
<ul class="simple">
<li>One cannot currently add peers after the fact, for example, if one decides
to start a debugger after the fact. (This is only required for code with
bugs and is thus an unusual use case.)</li>
<li><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> instances race. The winner of this race sets up the
namespaces, and the other peers use the winner to find the namespaces to
join. Therefore, if the user command of the winner exits, any remaining
peers will not be able to join the namespaces, even if they are still
active. There is currently no general way to specify which <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
should be the winner.</li>
<li>If <code class="code docutils literal notranslate"><span class="pre">--join-ct</span></code> is too high, the winning <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s user command
exits before all peers join, or <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> itself crashes, IPC resources
such as semaphores and shared memory segments will be leaked. These appear
as files in <code class="code docutils literal notranslate"><span class="pre">/dev/shm/</span></code> and can be removed with <code class="code docutils literal notranslate"><span class="pre">rm(1)</span></code>.</li>
<li>Many of the arguments given to the race losers, such as the image path and
<code class="code docutils literal notranslate"><span class="pre">--bind</span></code>, will be ignored in favor of what was given to the winner.</li>
</ul>
</div>
<div class="section" id="id32">
<h3>3.12.5. Environment variables<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> leaves environment variables unchanged, i.e. the host
environment is passed through unaltered, except:</p>
<ul class="simple">
<li>limited tweaks to avoid significant guest breakage;</li>
<li>user-set variables via <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>; and</li>
<li>user-unset variables via <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code>.</li>
</ul>
<p>This section describes these features.</p>
<p>The default tweaks happen first, and then <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code> and
<code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code> in the order specified on the command line. The latter two
can be repeated arbitrarily many times, e.g. to add/remove multiple variable
sets or add only some variables in a file.</p>
<div class="section" id="default-behavior">
<h4>3.12.5.1. Default behavior<a class="headerlink" href="#default-behavior" title="Permalink to this headline">¶</a></h4>
<p>By default, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> makes the following environment variable changes:</p>
<ul>
<li><p class="first"><code class="code docutils literal notranslate"><span class="pre">$HOME</span></code>: If the path to your home directory is not <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>
on the host, then an inherited <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> will be incorrect inside the
guest. This confuses some software, such as Spack.</p>
<p>Thus, we change <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> to <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>, unless
<code class="code docutils literal notranslate"><span class="pre">--no-home</span></code> is specified, in which case it is left unchanged.</p>
</li>
<li><p class="first"><code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>: Newer Linux distributions replace some root-level
directories, such as <code class="code docutils literal notranslate"><span class="pre">/bin</span></code>, with symlinks to their counterparts in
<code class="code docutils literal notranslate"><span class="pre">/usr</span></code>.</p>
<p>Some of these distributions (e.g., Fedora 24) have also dropped <code class="code docutils literal notranslate"><span class="pre">/bin</span></code>
from the default <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>. This is a problem when the guest OS does
<em>not</em> have a merged <code class="code docutils literal notranslate"><span class="pre">/usr</span></code> (e.g., Debian 8 “Jessie”). Thus, we add
<code class="code docutils literal notranslate"><span class="pre">/bin</span></code> to <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code> if it’s not already present.</p>
<p>Further reading:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/TheCaseForTheUsrMerge/">The case for the /usr Merge</a></li>
<li><a class="reference external" href="https://fedoraproject.org/wiki/Features/UsrMove">Fedora</a></li>
<li><a class="reference external" href="https://wiki.debian.org/UsrMerge">Debian</a></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="setting-variables-with-set-env">
<h4>3.12.5.2. Setting variables with <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code><a class="headerlink" href="#setting-variables-with-set-env" title="Permalink to this headline">¶</a></h4>
<p>The purpose of <code class="code docutils literal notranslate"><span class="pre">--set-env=FILE</span></code> is to set environment variables that
cannot be inherited from the host shell, e.g. Dockerfile <code class="code docutils literal notranslate"><span class="pre">ENV</span></code>
directives or other build-time configuration. <code class="code docutils literal notranslate"><span class="pre">FILE</span></code> is a host path to
provide the greatest flexibility; guest paths can be specified by prepending
the image path.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-builder2tar(1)</span></code> lists variables specified at build time in
Dockerfiles in the image in file <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code>. To set these
variables: <code class="code docutils literal notranslate"><span class="pre">--set-env=$IMG/ch/environment</span></code>.</p>
<p>Variable values in <code class="code docutils literal notranslate"><span class="pre">FILE</span></code> replace any already set. If a variable is
repeated, the last value wins.</p>
<p>The syntax of <code class="code docutils literal notranslate"><span class="pre">FILE</span></code> is key-value pairs separated by the first equals
character (<code class="code docutils literal notranslate"><span class="pre">=</span></code>, ASCII 61), one per line, with optional single straight
quotes (<code class="code docutils literal notranslate"><span class="pre">'</span></code>, ASCII 39) around the value. Empty lines are ignored.
Newlines (ASCII 10) are not permitted in either key or value. No variable
expansion, comments, etc. are provided. The value may be empty, but not the
key. (This syntax is designed to accept the output of <code class="code docutils literal notranslate"><span class="pre">printenv</span></code> and be
easily produced by other simple mechanisms.) Examples of valid lines:</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Line</th>
<th class="head">Key</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FOO=bar</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">bar</span></code></td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal notranslate"><span class="pre">FOO=bar=baz</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">bar=baz</span></code></td>
</tr>
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FLAGS=-march=foo</span> <span class="pre">-mtune=bar</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FLAGS</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">-march=foo</span> <span class="pre">-mtune=bar</span></code></td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal notranslate"><span class="pre">FLAGS='-march=foo</span> <span class="pre">-mtune=bar'</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FLAGS</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">-march=foo</span> <span class="pre">-mtune=bar</span></code></td>
</tr>
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FOO=</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td>(empty string)</td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal notranslate"><span class="pre">FOO=''</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td>(empty string)</td>
</tr>
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FOO=''''</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">''</span></code> (two single quotes)</td>
</tr>
</tbody>
</table>
<p>Example invalid lines:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Line</th>
<th class="head">Problem</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FOO</span> <span class="pre">bar</span></code></td>
<td>no separator</td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal notranslate"><span class="pre">=bar</span></code></td>
<td>key cannot be empty</td>
</tr>
</tbody>
</table>
<p>Example valid lines that are probably not what you want:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Line</th>
<th class="head">Key</th>
<th class="head">Value</th>
<th class="head">Problem</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FOO=&quot;bar&quot;</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">&quot;bar&quot;</span></code></td>
<td>double quotes aren’t stripped</td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal notranslate"><span class="pre">FOO=bar</span> <span class="pre">#</span> <span class="pre">baz</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">bar</span> <span class="pre">#</span> <span class="pre">baz</span></code></td>
<td>comments not supported</td>
</tr>
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">PATH=$PATH:/opt/bin</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">PATH</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">$PATH:/opt/bin</span></code></td>
<td>variables not expanded</td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">FOO=bar</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">bar</span></code></td>
<td>leading space in key</td>
</tr>
<tr class="row-even"><td><code class="code docutils literal notranslate"><span class="pre">FOO=</span> <span class="pre">bar</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></td>
<td><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">bar</span></code></td>
<td>leading space in value</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="removing-variables-with-unset-env">
<h4>3.12.5.3. Removing variables with <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code><a class="headerlink" href="#removing-variables-with-unset-env" title="Permalink to this headline">¶</a></h4>
<p>The purpose of <code class="code docutils literal notranslate"><span class="pre">--unset-env=GLOB</span></code> is to remove unwanted environment
variables. The argument <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code> is a glob pattern (<a class="reference external" href="http://man7.org/linux/man-pages/man3/fnmatch.3.html">dialect</a> <code class="code docutils literal notranslate"><span class="pre">fnmatch(3)</span></code>
with no flags); all variables with matching names are removed from the
environment.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Because the shell also interprets glob patterns, if any wildcard characters
are in <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code>, it is important to put it in single quotes to avoid
surprises.</p>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">GLOB</span></code> must be a non-empty string.</p>
<p>Example 1: Remove the single environment variable <code class="code docutils literal notranslate"><span class="pre">FOO</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">FOO</span><span class="o">=</span>bar
<span class="gp">$</span> env <span class="p">|</span> fgrep FOO
<span class="go">FOO=bar</span>
<span class="gp">$</span> ch-run --unset-env<span class="o">=</span>FOO <span class="nv">$CH_TEST_IMGDIR</span>/chtest -- env <span class="p">|</span> fgrep FOO
<span class="gp">$</span>
</pre></div>
</div>
<p>Example 2: Hide from a container the fact that it’s running in a Slurm
allocation, by removing all variables beginning with <code class="code docutils literal notranslate"><span class="pre">SLURM</span></code>. You might
want to do this to test an MPI program with one rank and no launcher:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> salloc -N1
<span class="gp">$</span> env <span class="p">|</span> egrep <span class="s1">&#39;^SLURM&#39;</span> <span class="p">|</span> wc
<span class="go">   44      44    1092</span>
<span class="gp">$</span> ch-run <span class="nv">$CH_TEST_IMGDIR</span>/mpihello-openmpi -- /hello/hello
<span class="go">[... long error message ...]</span>
<span class="gp">$</span> ch-run --unset-env<span class="o">=</span><span class="s1">&#39;SLURM*&#39;</span> <span class="nv">$CH_TEST_IMGDIR</span>/mpihello-openmpi -- /hello/hello
<span class="go">0: MPI version:</span>
<span class="go">Open MPI v3.1.3, package: Open MPI root@c897a83f6f92 Distribution, ident: 3.1.3, repo rev: v3.1.3, Oct 29, 2018</span>
<span class="go">0: init ok cn001.localdomain, 1 ranks, userns 4026532530</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
<p>Example 3: Clear the environment completely (remove all variables):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --unset-env<span class="o">=</span><span class="s1">&#39;*&#39;</span> <span class="nv">$CH_TEST_IMGDIR</span>/chtest -- env
<span class="gp">$</span>
</pre></div>
</div>
<p>Note that some programs, such as shells, set some environment variables even
if started with no init files:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --unset-env<span class="o">=</span><span class="s1">&#39;*&#39;</span> <span class="nv">$CH_TEST_IMGDIR</span>/debian9 -- bash --noprofile --norc -c env
<span class="go">SHLVL=1</span>
<span class="go">PWD=/</span>
<span class="go">_=/usr/bin/env</span>
<span class="gp">$</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id33">
<h3>3.12.6. Examples<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h3>
<p>Run the command <code class="code docutils literal notranslate"><span class="pre">echo</span> <span class="pre">hello</span></code> inside a Charliecloud container using the
unpacked image at <code class="code docutils literal notranslate"><span class="pre">/data/foo</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run /data/foo -- <span class="nb">echo</span> hello
<span class="go">hello</span>
</pre></div>
</div>
<p>Run an MPI job that can use CMA to communicate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> srun ch-run --join /data/foo -- bar
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-run-oci">
<h2><a class="toc-backref" href="#id66">3.13. ch-run-oci</a><a class="headerlink" href="#ch-run-oci" title="Permalink to this headline">¶</a></h2>
<p>OCI wrapper for <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p>
<div class="section" id="id34">
<h3>3.13.1. Synopsis<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci OPERATION <span class="o">[</span>ARG ...<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id35">
<h3>3.13.2. Description<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This command is experimental. Features may be incomplete and/or buggy. The
quality of code is not yet up to the usual Charliecloud standards, and
error handling is poor. Please report any issues you find, so we can fix
them!</p>
</div>
<p>Open Containers Initiative (OCI) wrapper for <code class="code docutils literal notranslate"><span class="pre">ch-run(1)</span></code>. You probably
don’t want to run this command directly; it is intended to interface with
other software that expects an OCI runtime. The current goal is to support
completely unprivileged image building (e.g. <code class="code docutils literal notranslate"><span class="pre">buildah</span>
<span class="pre">--runtime=ch-run-oci</span></code>) rather than general OCI container running.</p>
<p><em>Support of the OCI runtime specification is only partial.</em> This is for two
reasons. First, it’s an experimental and incomplete feature. More importantly,
the philosophy and goals of OCI differ significantly from those of
Charliecloud. Key differences include:</p>
<blockquote>
<div><ul class="simple">
<li>OCI is designed to run services, while Charliecloud is designed to run
scientific applications.</li>
<li>OCI containers are persistent things with a complex lifecycle, while
Charliecloud containers are simply UNIX processes.</li>
<li>OCI expects support for a variety of namespaces, while Charliecloud
supports user and mount, no more and no less.</li>
<li>OCI expects runtimes to maintain a supervisor process in addition to
user processes; Charliecloud has no need for this.</li>
<li>OCI expects runtimes to maintain state throughout the container lifecycle
in a location independent from the caller.</li>
</ul>
</div></blockquote>
<p>For these reasons, <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code> is a bit of a kludge, and much of what
it does is provide scaffolding to satisfy OCI requirements.</p>
<p>Which OCI features are and are not supported is provided in the rest of this
man page, and technical analysis and discussion are in the Contributor’s
Guide.</p>
<p>This command supports OCI version 1.0.0 only and fails with an error if other
versions are offered.</p>
</div>
<div class="section" id="operations">
<h3>3.13.3. Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h3>
<p>All OCI operations are accepted, but some are no-ops or merely scaffolding to
satisfy the caller. For comparison, see also:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md">OCI runtime and lifecycle spec</a></li>
<li>The <a class="reference external" href="https://github.com/opencontainers/runc/tree/master/man">runc man pages</a></li>
</ul>
<div class="section" id="create">
<h4>3.13.3.1. <code class="code docutils literal notranslate"><span class="pre">create</span></code><a class="headerlink" href="#create" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci create --bundle DIR --pid-file FILE <span class="o">[</span>--no-new-keyring<span class="o">]</span> CONTAINER_ID
</pre></div>
</div>
<p>Create a container. Charliecloud does not have separate create and start
phases, so this operation only sets up OCI-related scaffolding.</p>
<p>Arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--bundle</span> <span class="pre">DIR</span></code></dt>
<dd>Directory containing the OCI bundle. This must be <code class="code docutils literal notranslate"><span class="pre">/tmp/buildahYYY</span></code>,
where <code class="code docutils literal notranslate"><span class="pre">YYY</span></code> matches <code class="code docutils literal notranslate"><span class="pre">CONTAINER_ID</span></code> below.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pid-file</span> <span class="pre">FILE</span></code></dt>
<dd>Filename to write the “container” process PID to. Note that for
Charliecloud, the process given is fake; see above. This must be
<code class="code docutils literal notranslate"><span class="pre">DIR/pid</span></code>, where <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> is given by <code class="code docutils literal notranslate"><span class="pre">--bundle</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-new-keyring</span></code></dt>
<dd>Ignored. (Charliecloud does not implement session keyrings.)</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CONTAINER_ID</span></code></dt>
<dd>String to use as the container ID. This must be
<code class="code docutils literal notranslate"><span class="pre">buildah-buildahYYY</span></code>, where <code class="code docutils literal notranslate"><span class="pre">YYY</span></code> matches <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> above.</dd>
</dl>
</div></blockquote>
<p>Unsupported arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--console-socket</span> <span class="pre">PATH</span></code></dt>
<dd>UNIX socket to pass pseudoterminal file descriptor. Charliecloud does not
support pseudoterminals; fail with an error if this argument is given. For
Buildah, redirect its input from <code class="code docutils literal notranslate"><span class="pre">/dev/null</span></code> to prevent it from
requesting a pseudoterminal.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="delete">
<h4>3.13.3.2. <code class="code docutils literal notranslate"><span class="pre">delete</span></code><a class="headerlink" href="#delete" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci delete CONTAINER_ID
</pre></div>
</div>
<p>Clean up the OCI-related scaffolding for specified container.</p>
</div>
<div class="section" id="kill">
<h4>3.13.3.3. <code class="code docutils literal notranslate"><span class="pre">kill</span></code><a class="headerlink" href="#kill" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci <span class="nb">kill</span> CONTAINER_ID
</pre></div>
</div>
<p>No-op.</p>
</div>
<div class="section" id="start">
<h4>3.13.3.4. <code class="code docutils literal notranslate"><span class="pre">start</span></code><a class="headerlink" href="#start" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci start CONTAINER_ID
</pre></div>
</div>
<p>Eexecute the user command specified at create time in a Charliecloud
container.</p>
</div>
<div class="section" id="state">
<h4>3.13.3.5. <code class="code docutils literal notranslate"><span class="pre">state</span></code><a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci state CONTAINER_ID
</pre></div>
</div>
<p>Print the state of the given container on standard output as an OCI compliant
JSON document.</p>
</div>
</div>
<div class="section" id="unsupported-oci-features">
<h3>3.13.4. Unsupported OCI features<a class="headerlink" href="#unsupported-oci-features" title="Permalink to this headline">¶</a></h3>
<p>As noted above, various OCI features are not supported by Charliecloud. We
have tried to guess which features would be essential to callers;
<code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code> fails with an error if these are requested. Otherwise, the
request is simply ignored.</p>
<p>We are interested in hearing about scientific-computing use cases for
unsupported features, so we can add support for things that are needed.</p>
<p>Our goal is for this man page to be comprehensive: every OCI runtime feature
should either work or be listed as unsupported.</p>
<p>Unsupported features that are an error:</p>
<blockquote>
<div><ul class="simple">
<li>Pseudoterminals</li>
<li>Hooks (prestart, poststart, and prestop)</li>
<li>Annotations</li>
<li>Joining existing namespaces</li>
<li>Intel Resource Director Technology (RDT)</li>
</ul>
</div></blockquote>
<p>Unsupported features that are ignored:</p>
<blockquote>
<div><ul class="simple">
<li>Mounts other than the root filesystem (we do use <code class="code docutils literal notranslate"><span class="pre">--no-home</span></code>)</li>
<li>User/group mappings beyond one user mapped to EUID and one group mapped to
EGID</li>
<li>Disabling <code class="code docutils literal notranslate"><span class="pre">prctl(PR_SET_NO_NEW_PRIVS)</span></code></li>
<li>Root filesystem propagation mode</li>
<li><code class="code docutils literal notranslate"><span class="pre">sysctl</span></code> directives</li>
<li>masked and read-only paths (remaining unprivileged protects you)</li>
<li>Capabilities</li>
<li>rlimits</li>
<li>Devices (all devices are inherited from the host)</li>
<li>cgroups</li>
<li>seccomp</li>
<li>SELinux</li>
<li>AppArmor</li>
<li>Container hostname setting</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id36">
<h3>3.13.5. Environment variables<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">CH_RUN_OCI_LOGFILE</span></code></p>
<blockquote>
<div>If set, send log chatter to this file. We use a side channel because
standard error and standard output may be arbitrarily messed up by the
caller.</div></blockquote>
<p><code class="code docutils literal notranslate"><span class="pre">CH_RUN_OCI_HANG</span></code></p>
<blockquote>
<div>If set to the name of a command (e.g., <code class="code docutils literal notranslate"><span class="pre">create</span></code>), sleep indefinitely
when that command is invoked. The purpose here is to halt a build so it can
be examined and debugged.</div></blockquote>
</div>
</div>
<div class="section" id="ch-ssh">
<h2><a class="toc-backref" href="#id67">3.14. ch-ssh</a><a class="headerlink" href="#ch-ssh" title="Permalink to this headline">¶</a></h2>
<p>Run a remote command in a Charliecloud container.</p>
<div class="section" id="id37">
<h3>3.14.1. Synopsis<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nv">CH_RUN_ARGS</span><span class="o">=</span><span class="s2">&quot;NEWROOT [ARG...]&quot;</span>
<span class="gp">$</span> ch-ssh <span class="o">[</span>OPTION...<span class="o">]</span> HOST CMD <span class="o">[</span>ARG...<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id38">
<h3>3.14.2. Description<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p>Runs command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code> in a Charliecloud container on remote host
<code class="code docutils literal notranslate"><span class="pre">HOST</span></code>. Use the content of environment variable <code class="code docutils literal notranslate"><span class="pre">CH_RUN_ARGS</span></code> as
the arguments to <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> on the remote host.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Words in <code class="code docutils literal notranslate"><span class="pre">CH_RUN_ARGS</span></code> are delimited by spaces only; it is not shell
syntax.</p>
</div>
</div>
<div class="section" id="id39">
<h3>3.14.3. Example<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<p>On host bar.example.com, run the command <code class="code docutils literal notranslate"><span class="pre">echo</span> <span class="pre">hello</span></code> inside a
Charliecloud container using the unpacked image at <code class="code docutils literal notranslate"><span class="pre">/data/foo</span></code> with
starting directory <code class="code docutils literal notranslate"><span class="pre">/baz</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> hostname
<span class="go">foo</span>
<span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_RUN_ARGS</span><span class="o">=</span><span class="s1">&#39;--cd /baz /data/foo&#39;</span>
<span class="gp">$</span> ch-ssh bar.example.com -- hostname
<span class="go">bar</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-tar2dir">
<h2><a class="toc-backref" href="#id68">3.15. ch-tar2dir</a><a class="headerlink" href="#ch-tar2dir" title="Permalink to this headline">¶</a></h2>
<p>Unpack an image tarball into a directory.</p>
<div class="section" id="id40">
<h3>3.15.1. Synopsis<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-tar2dir TARBALL DIR
</pre></div>
</div>
</div>
<div class="section" id="id41">
<h3>3.15.2. Description<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h3>
<p>Extract the tarball <code class="code docutils literal notranslate"><span class="pre">TARBALL</span></code> into a subdirectory of <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>.
<code class="code docutils literal notranslate"><span class="pre">TARBALL</span></code> must contain a Linux filesystem image, e.g. as created by
<code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code>, and be compressed with <code class="code docutils literal notranslate"><span class="pre">gzip</span></code> or <code class="code docutils literal notranslate"><span class="pre">xz</span></code>. If
<code class="code docutils literal notranslate"><span class="pre">TARBALL</span></code> has no extension, try appending <code class="code docutils literal notranslate"><span class="pre">.tar.gz</span></code> and
<code class="code docutils literal notranslate"><span class="pre">.tar.xz</span></code>.</p>
<p>Inside <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>, a subdirectory will be created whose name corresponds to
the name of the tarball with <code class="code docutils literal notranslate"><span class="pre">.tar.gz</span></code> or other suffix removed. If such
a directory exists already and appears to be a Charliecloud container image,
it is removed and replaced. If the existing directory doesn’t appear to be a
container image, the script aborts with an error.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Placing <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> on a shared file system can cause significant metadata
load on the file system servers. This can result in poor performance for
you and all your colleagues who use the same file system. Please consult
your site admin for a suitable location.</p>
</div>
</div>
<div class="section" id="id42">
<h3>3.15.3. Example<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls -lh /var/tmp
<span class="go">total 57M</span>
<span class="go">-rw-r-----  1 reidpr reidpr  57M Feb 13 16:14 hello.tar.gz</span>
<span class="gp">$</span> ch-tar2dir /var/tmp/hello.tar.gz /var/tmp
<span class="go">creating new image /var/tmp/hello</span>
<span class="go">/var/tmp/hello unpacked ok</span>
<span class="gp">$</span> ls -lh /var/tmp
<span class="go">total 57M</span>
<span class="go">drwxr-x--- 22 reidpr reidpr 4.0K Feb 13 16:29 hello</span>
<span class="go">-rw-r-----  1 reidpr reidpr  57M Feb 13 16:14 hello.tar.gz</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-test">
<span id="id43"></span><h2><a class="toc-backref" href="#id69">3.16. ch-test</a><a class="headerlink" href="#ch-test" title="Permalink to this headline">¶</a></h2>
<p>Run some or all of the Charliecloud test suite.</p>
<div class="section" id="id44">
<h3>3.16.1. Synopsis<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-test <span class="o">[</span>PHASE<span class="o">]</span> <span class="o">[</span>--scope SCOPE<span class="o">]</span> <span class="o">[</span>ARGS<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id45">
<h3>3.16.2. Description<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<p>Charliecloud comes with a comprehensive test suite that exercises the
container workflow itself as well as a few example applications.
<code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> coordinates running the test suite.</p>
<p>While the CLI has lots of options, the defaults are reasonable, and bare
<code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> will give useful results in a few minutes on single-node,
internet-connected systems with a few GB available in <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code>.</p>
<p>The test suite requires a few GB (standard scope) or tens of GB (full scope)
of storage for test fixtures:</p>
<ul class="simple">
<li><em>Builder storage</em> (e.g., layer cache). This goes wherever the builder puts
it.</li>
<li><em>Packed images directory</em>: image tarballs or SquashFS files.</li>
<li><em>Unpacked images directory</em>. Images are unpacked into and then run from
here.</li>
<li><em>Filesystem permissions</em> directories. These are used to test that the
kernel is enforcing permissions correctly. Note that this exercises the
kernel, not Charliecloud, and can be omitted from routine Charliecloud
testing.</li>
</ul>
<p>The first three are created when needed if they don’t exist, while the
filesystem permissions fixtures must be created manually, in order to
accommodate configurations where sudo is not available via the same login path
used for running tests.</p>
<p>The packed and unpacked image directories specified for testing are volatile.
The contents of these directories are deleted before the build and run phases,
respectively.</p>
<p>In all four cases, when creating directories, only the final path component is
created. Parent directories must already exist, i.e., <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> uses the
behavior of <code class="code docutils literal notranslate"><span class="pre">mkdir</span></code> rather than <code class="code docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span></code>.</p>
<p>Some of the tests exercise parallel functionality. If <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> is run
on a single node, multiple cores will be used; if in a Slurm allocation,
multiple nodes too.</p>
<p>The subset of tests to run mostly splits along two key dimensions. The <em>phase</em>
is which parts of the workflow to run. Different parts of the workflow can be
tested on different systems by copying the necessary artifacts between them,
e.g. by building images on one system and running them on another. The <em>scope</em>
allows trading off thoroughness versus time.</p>
<p><code class="code docutils literal notranslate"><span class="pre">PHASE</span></code> must be one of the following:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">build</span></code></dt>
<dd>Image building and associated functionality, with the selected builder.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">run</span></code></dt>
<dd>Running containers and associated functionality. This requires a packed
images directory produced by a successful <code class="code docutils literal notranslate"><span class="pre">build</span></code> phase, which can
be copied from the build system if it’s not also the run system.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">examples</span></code></dt>
<dd>Example applications. Requires an unpacked images directory produced by a
successful <code class="code docutils literal notranslate"><span class="pre">run</span></code> phase.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">all</span></code></dt>
<dd>Execute phases <code class="code docutils literal notranslate"><span class="pre">build</span></code>, <code class="code docutils literal notranslate"><span class="pre">run</span></code>, and <code class="code docutils literal notranslate"><span class="pre">examples</span></code>, in that
order.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">mk-perm-dirs</span></code></dt>
<dd>Create the filesystem permissions directories. Requires
<code class="code docutils literal notranslate"><span class="pre">--perm-dirs</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">clean</span></code></dt>
<dd>Delete automatically-generated test files, and packed and unpacked image
directories.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">rm-perm-dirs</span></code></dt>
<dd>Remove the filesystem permissions directories. Requires
<code class="code docutils literal notranslate"><span class="pre">--perm-dirs</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">FILE</span></code></dt>
<dd>Run the tests in the given file only, which can be an arbitrary
<code class="code docutils literal notranslate"><span class="pre">.bats</span></code> file, except for <code class="code docutils literal notranslate"><span class="pre">test.bats</span></code> under <code class="code docutils literal notranslate"><span class="pre">examples</span></code>,
where you must specify the corresponding Dockerfile or <code class="code docutils literal notranslate"><span class="pre">Build</span></code> file
instead. This is somewhat brittle and typically used for development or
debugging. For example, it does not check whether the pre-requisites of
whatever is in the file are satisfied. Often running <code class="code docutils literal notranslate"><span class="pre">build</span></code> and
<code class="code docutils literal notranslate"><span class="pre">run</span></code> first is sufficient, but this varies.</dd>
</dl>
</div></blockquote>
<p>Scope is specified with:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--scope</span> <span class="pre">SCOPE</span></code></dt>
<dd><p class="first"><code class="code docutils literal notranslate"><span class="pre">SCOPE</span></code> must be one of the following; the default is
<code class="code docutils literal notranslate"><span class="pre">standard</span></code>.</p>
<ul class="last simple">
<li><code class="code docutils literal notranslate"><span class="pre">quick</span></code>: Most important subset of workflow. Handy for development.
Completion time: 1–2 minutes.</li>
<li><code class="code docutils literal notranslate"><span class="pre">standard</span></code>: All tested workflow functionality and a selection of
more important examples. Completion time: 5–10 minutes.</li>
<li><code class="code docutils literal notranslate"><span class="pre">full</span></code>: All available tests, including all examples. Completion
time, hot cache: 7–15 minutes; cold cache: 1–2 hours.</li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--builder</span> <span class="pre">BUILDER</span></code></dt>
<dd>Image builder to use. See ch-build(1) for how the default is selected.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt>
<dd>Print summary of what would be tested and then exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>Print usage and then exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--img-dir</span> <span class="pre">DIR</span></code></dt>
<dd>Set unpacked images directory to <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>. In a multi-node allocation,
this directory may not be shared between nodes. Default:
<code class="code docutils literal notranslate"><span class="pre">$CH_TEST_IMGDIR</span></code> if set; otherwise <code class="code docutils literal notranslate"><span class="pre">/var/tmp/img</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pack-dir</span> <span class="pre">DIR</span></code></dt>
<dd>Set packed images directory to <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>. Default:
<code class="code docutils literal notranslate"><span class="pre">$CH_TEST_TARDIR</span></code> if set; otherwise <code class="code docutils literal notranslate"><span class="pre">/var/tmp/pack</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pedantic</span> <span class="pre">(yes|no)</span></code></dt>
<dd><p class="first">Some tests require configurations that are very specific (e.g., being a
member of at least two groups) or unusual (e.g., sudo to a non-root
group). If <code class="code docutils literal notranslate"><span class="pre">yes</span></code>, then fail if the requirement is not met; if
<code class="code docutils literal notranslate"><span class="pre">no</span></code>, then skip. The default is <code class="code docutils literal notranslate"><span class="pre">yes</span></code> for CI environments or
people listed in <code class="code docutils literal notranslate"><span class="pre">README.md</span></code>, <code class="code docutils literal notranslate"><span class="pre">no</span></code> otherwise.</p>
<p class="last">If <code class="code docutils literal notranslate"><span class="pre">yes</span></code> and sudo seems to be available, implies <code class="code docutils literal notranslate"><span class="pre">--sudo</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--perm-dir</span> <span class="pre">DIR</span></code></dt>
<dd><p class="first">Add <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> to filesystem permission fixture directories; can be
specified multiple times. We recommend one such directory per mounted
filesystem type whose kernel module you do not trust; e.g., you probably
don’t need to test your <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code>es, but out-of-tree filesystems very
likely need this.</p>
<p class="last">Implies <code class="code docutils literal notranslate"><span class="pre">--sudo</span></code>. Default: <code class="code docutils literal notranslate"><span class="pre">CH_TEST_PERMDIRS</span></code> if set;
otherwise skip the filesystem permissions tests.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pack-fmt</span> <span class="pre">FMT</span></code></dt>
<dd>Use packed image format <code class="code docutils literal notranslate"><span class="pre">FMT</span></code> (<code class="code docutils literal notranslate"><span class="pre">squash</span></code> or <code class="code docutils literal notranslate"><span class="pre">tar</span></code>).</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--sudo</span></code></dt>
<dd>Enable things that require sudo, such as certain privilege escalation
tests and creating/removing the filesystem permissions fixtures. Requires
generic <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> capabilities. Note that the Docker builder uses
<code class="code docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span></code> even without this option.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--lustre</span> <span class="pre">DIR</span></code></dt>
<dd><p class="first">Use <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> for run-phase Lustre tests. Default:
<code class="code docutils literal notranslate"><span class="pre">CH_TEST_LUSTREDIR</span></code> if set; otherwise skip them.</p>
<p class="last">The tests will create, populate, and delete a new subdirectory under
<code class="code docutils literal notranslate"><span class="pre">DIR</span></code>, leaving everything else in <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> untouched.</p>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="exit-status">
<h3>3.16.3. Exit status<a class="headerlink" href="#exit-status" title="Permalink to this headline">¶</a></h3>
<p>Zero if all tests passed; non-zero if any failed. For setup and teardown
phases, zero if everything was created or deleted correctly, non-zero
otherwise.</p>
</div>
<div class="section" id="id46">
<h3>3.16.4. Bugs<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h3>
<p>Bats will wait until all descendant processes finish before exiting, so if you
get into a failure mode where a test sequence doesn’t clean up all its
processes, <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> will hang.</p>
</div>
<div class="section" id="id47">
<h3>3.16.5. Examples<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h3>
<p>Many systems can simply use the defaults. To run the <code class="code docutils literal notranslate"><span class="pre">build</span></code>,
<code class="code docutils literal notranslate"><span class="pre">run</span></code>, and <code class="code docutils literal notranslate"><span class="pre">examples</span></code> phases on a single system, without the
filesystem permissions tests:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-test
<span class="go">ch-test version 0.12</span>

<span class="go">ch-run: 0.12 /usr/local/bin/ch-run</span>
<span class="go">bats:   0.4.0 /usr/bin/bats</span>
<span class="go">tests:  /usr/local/libexec/charliecloud/test</span>

<span class="go">phase:                build run examples</span>
<span class="go">scope:                standard (default)</span>
<span class="go">builder:              docker (default)</span>
<span class="go">use generic sudo:     no (default)</span>
<span class="go">unpacked images dir:  /var/tmp/img (default)</span>
<span class="go">packed images dir:    /var/tmp/tar (default)</span>
<span class="go">fs permissions dirs:  skip (default)</span>

<span class="go">checking namespaces ...</span>
<span class="go">ok</span>

<span class="go">checking builder ...</span>
<span class="go">found: /usr/bin/docker 19.03.2</span>

<span class="go">bats build.bats build_auto.bats build_post.bats</span>
<span class="go"> ✓ documentation seems sane</span>
<span class="go"> ✓ version number seems sane</span>
<span class="go">[...]</span>
<span class="go">All tests passed.</span>
</pre></div>
</div>
<p>The next example is for a more complex setup like you might find in HPC
centers:</p>
<blockquote>
<div><ul class="simple">
<li>Non-default fixture directories.</li>
<li>Non-default scope.</li>
<li>Different build and run systems.</li>
<li>Run the filesystem permissions tests.</li>
</ul>
</div></blockquote>
<p>Output has been omitted.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">(mybox)$</span> ssh hpc-admin
<span class="gp">(hpc-admin)$</span> ch-test mk-perm-dirs --perm-dir /scratch/<span class="nv">$USER</span>/perms <span class="se">\</span>
                                  --perm-dir /home/<span class="nv">$USER</span>/perms
<span class="gp">(hpc-admin)$</span> <span class="nb">exit</span>
<span class="gp">(mybox)$</span> ch-test build --scope full
<span class="gp">(mybox)$</span> scp -r /var/tmp/pack hpc:/scratch/<span class="nv">$USER</span>/pack
<span class="gp">(mybox)$</span> ssh hpc
<span class="gp">(hpc)$</span> salloc -N2
<span class="gp">(cn001)$</span> <span class="nb">export</span> <span class="nv">CH_TEST_TARDIR</span><span class="o">=</span>/scratch/<span class="nv">$USER</span>/pack
<span class="gp">(cn001)$</span> <span class="nb">export</span> <span class="nv">CH_TEST_IMGDIR</span><span class="o">=</span>/local/tmp
<span class="gp">(cn001)$</span> <span class="nb">export</span> <span class="nv">CH_TEST_PERMDIRS</span><span class="o">=</span><span class="s2">&quot;/scratch/</span><span class="nv">$USER</span><span class="s2">/perms /home/</span><span class="nv">$USER</span><span class="s2">/perms&quot;</span>
<span class="gp">(cn001)$</span> <span class="nb">export</span> <span class="nv">CH_TEST_SCOPE</span><span class="o">=</span>full
<span class="gp">(cn001)$</span> ch-test run
<span class="gp">(cn001)$</span> ch-test examples
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-tug">
<h2><a class="toc-backref" href="#id70">3.17. ch-tug</a><a class="headerlink" href="#ch-tug" title="Permalink to this headline">¶</a></h2>
<p>Pull and flatten image from repository to local filesystem.</p>
<div class="section" id="id48">
<h3>3.17.1. Synopsis<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-tug <span class="o">[</span>OPTIONS<span class="o">]</span> IMAGE_REF
</pre></div>
</div>
</div>
<div class="section" id="id49">
<h3>3.17.2. Description<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This script is experimental. Please report the bugs you find so we can fix
them!</p>
</div>
<p>Pull the image described by <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> from a repository by HTTPS and
flatten it to a local filesystem. The resulting image directory can be used by
<code class="code docutils literal notranslate"><span class="pre">ch-run(1)</span></code> or feed into other processing.</p>
<p>This script does a fair amount of validation and fixing of the layer tarballs
before flattening in order to support unprivileged use despite image problems
we frequently see in the wild. For example, device files are ignored, and file
and directory permissions are increased to a minimum of <code class="code docutils literal notranslate"><span class="pre">rwx------</span></code> and
<code class="code docutils literal notranslate"><span class="pre">rw-------</span></code> respectively. Note, however, that symlinks pointing outside
the image are permitted, because they are not resolved until runtime within a
container.</p>
<p>Typically this script is not used directly. Most tasks instead use the
underlying code during image build with <code class="code docutils literal notranslate"><span class="pre">ch-grow(1)</span></code>.</p>
<p>Other arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>Print help and exit.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dependencies</span></code></dt>
<dd>Report any dependency problems and exit. If all is well, there is no
output and the exit code is zero; in case of problems, the exit code is
non-zero.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dl-cache</span> <span class="pre">DIR</span></code></dt>
<dd>Use <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> to store downloaded layers and metadata. If not specified
but environment variable <code class="code docutils literal notranslate"><span class="pre">CH_GROW_STORAGE</span></code> is, then use
<code class="code docutils literal notranslate"><span class="pre">$CH_GROW_STORAGE/dlcache</span></code>; the default is
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER/ch-grow/dlcache</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-cache</span></code></dt>
<dd>Always download files, even if they already exist in <code class="code docutils literal notranslate"><span class="pre">--dl-cache</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--image-subdir</span> <span class="pre">DIR</span></code></dt>
<dd>Subdirectory of <code class="code docutils literal notranslate"><span class="pre">--unpack-dir</span></code> to hold the flattened image. Can be
the empty string, in which case <code class="code docutils literal notranslate"><span class="pre">--unpack-dir</span></code> is used directly. The
default is <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> with slashes replaced by percent signs.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--parse-ref-only</span></code></dt>
<dd>Parse <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>, print a parse report, and exit successfully.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--unpack-dir</span> <span class="pre">DIR</span></code></dt>
<dd>Directory containing flattened images. If not specified but environment
variable <code class="code docutils literal notranslate"><span class="pre">CH_GROW_STORAGE</span></code> is, then use
<code class="code docutils literal notranslate"><span class="pre">$CH_GROW_STORAGE/img</span></code>; the default is
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER/ch-grow/img</span></code>.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt>
<dd>Print extra chatter; can be repeated.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>Print version number and exit.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id50">
<h3>3.17.3. Examples<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h3>
<p>Download the classic Docker “hello-world” image and flatten it into
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER/ch-grow/img/hello-world</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-tug hello-world
<span class="go">pulling image: hello-world</span>
<span class="go">manifest: downloading</span>
<span class="go">layer 1/1: 1b930d0: downloading</span>
<span class="go">layer 1/1: 1b930d0: listing</span>
<span class="go">validating tarball members</span>
<span class="go">resolving whiteouts</span>
<span class="go">flattening image</span>
<span class="go">creating new image: /var/tmp/charlie/ch-grow/img/hello-world</span>
<span class="go">layer 1/1: 1b930d0: extracting</span>
<span class="go">done</span>
<span class="gp">$</span> ls /var/tmp/<span class="nv">$USER</span>/ch-grow/img/hello-world
<span class="go">hello</span>
<span class="gp">$</span> ls /var/tmp/<span class="nv">$USER</span>/ch-grow/dlcache
<span class="go">1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced.tar.gz</span>
<span class="go">hello-world.manifest.json</span>
</pre></div>
</div>
<p>Download the image “charliecloud/whiteout:2020-01-10” and flatten it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-tug charliecloud/whiteout:2020-01-10
<span class="go">pulling image: charliecloud/whiteout:2020-01-10</span>
<span class="go">manifest: downloading</span>
<span class="go">layer 1/86: e7c96db: downloading</span>
<span class="go">layer 2/86: 4816f76: downloading</span>
<span class="go">[...]</span>
<span class="go">layer 85/86: 59b7abe: extracting</span>
<span class="go">layer 86/86: e756ca6: extracting</span>
<span class="go">done</span>
<span class="gp">$</span> ls /var/tmp/<span class="nv">$USER</span>/ch-grow/img
<span class="go">charliecloud%whiteout:2020-01-10</span>
</pre></div>
</div>
<p>Download the “hello-world” image and flatten it into <code class="code docutils literal notranslate"><span class="pre">/tmp/foo</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-tug --unpack-dir<span class="o">=</span>/tmp --image-subdir<span class="o">=</span>foo hello-world
<span class="go">[...]</span>
<span class="gp">$</span> ls /tmp/foo
<span class="go">hello</span>
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-tug --unpack-dir<span class="o">=</span>/tmp/foo --image-subdir<span class="o">=</span><span class="s1">&#39;&#39;</span> hello-world
<span class="go">[...]</span>
<span class="gp">$</span> ls /tmp/foo
<span class="go">hello</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ch-umount">
<h2><a class="toc-backref" href="#id71">3.18. ch-umount</a><a class="headerlink" href="#ch-umount" title="Permalink to this headline">¶</a></h2>
<p>Unmount a FUSE mounted squash filesystem and remove the mount point.</p>
<div class="section" id="id51">
<h3>3.18.1. Synopsis<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-umount MOUNTDIR
</pre></div>
</div>
</div>
<div class="section" id="id52">
<h3>3.18.2. Description<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h3>
<p>Unmount Charliecloud SquashFS file at target directory <code class="code docutils literal notranslate"><span class="pre">MOUNTDIR</span></code>.
Remove empty <code class="code docutils literal notranslate"><span class="pre">MOUNTDIR</span></code> after successful unmounting.</p>
<p>Additional arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt>
<dd>print help and exit</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt>
<dd>print version and exit</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id53">
<h3>3.18.3. Example<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls /var/tmp/debian
<span class="go">bin   dev  home  lib64  mnt  proc  run   srv  tmp  var</span>
<span class="go">boot  etc  lib   media  opt  root  sbin  sys  usr  WEIRD_AL_YANKOVIC</span>
<span class="gp">$</span> ch-umount /var/tmp/debian
<span class="go">unmounted and removed /var/tmp/debian</span>
<span class="gp">$</span> ls /var/tmp/debian
<span class="go">ls: cannot access /var/tmp/debian: No such file or directory</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="faq.html" class="btn btn-neutral float-right" title="4. Frequently asked questions (FAQ)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral float-left" title="2. Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2014–2020, Triad National Security, LLC

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>