# ch-test-scope: full
FROM debian9
WORKDIR /usr/local/src

# OS packages needed to build OpenMPI.
RUN apt-get install -y \
    devscripts \
    file \
    flex \
    g++ \
    gcc \
    gfortran \
    git \
    hwloc-nox \
    ibverbs-utils \
    less \
    libdb5.3-dev \
    libfabric-dev \
    libhwloc-dev \
    libibverbs-dev \
    libnuma-dev \
    libpmi2-0-dev \
    libpsm-infinipath1-dev \
    make \
    wget

# Install libpsm2, which is needed for OPA. These packages don't appear to be
# available anywhere in binary form as of 2018-05-24 [1], so compile from
# source.
#
# Note that libpsm2 is x86_64 only [2].
#
# [1]: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=862313
# [2]: https://lists.debian.org/debian-hpc/2017/12/msg00015.html
ENV PSM2_VERSION 10.3-37-1
RUN git clone --branch debian/${PSM2_VERSION} --depth 1 \
              https://salsa.debian.org/hpc-team/libpsm2.git
RUN    cd libpsm2 \
    && debuild -i -us -uc -b
RUN dpkg --install libpsm2-2_${PSM2_VERSION}_amd64.deb \
                   libpsm2-dev_${PSM2_VERSION}_amd64.deb

# Compile OpenMPI. We can't use the Debian package because we need a specific
# version and we need to build a little differently:
#
#   1. --disable-pty-support to avoid "pipe function call failed when
#      setting up I/O forwarding subsystem".
#
#   2. --with-slurm=no so mpirun in the container doesn't try use Slurm to
#       launch processes, which will fail in inscrutable ways e.g. if srun is
#       not found. (If you do want Slurm launching processes, use srun or
#       mpirun outside the container.)
#
ENV MPI_URL https://www.open-mpi.org/software/ompi/v2.1/downloads
ENV MPI_VERSION 2.1.2
RUN wget -nv ${MPI_URL}/openmpi-${MPI_VERSION}.tar.gz
RUN tar xf openmpi-${MPI_VERSION}.tar.gz
RUN    cd openmpi-${MPI_VERSION} \
    && CFLAGS=-O3 \
       CXXFLAGS=-O3 \
       ./configure --prefix=/usr \
                   --sysconfdir=/mnt/0 \
                   --disable-pty-support \
                   --with-pmi \
                   --with-pmi-libdir=/usr/lib/x86_64-linux-gnu \
                   --with-pmix \
                   --with-psm2 \
                   --with-slurm=no \
    && make -j$(getconf _NPROCESSORS_ONLN) install
RUN rm -Rf openmpi-${MPI_VERSION}*

# Silence warnings about this directory not existing.
RUN mkdir /etc/libibverbs.d

# OpenMPI expects this program to exist, even if it's not used. Default is
# "ssh : rsh", but that's not installed.
RUN echo 'plm_rsh_agent = false' >> /mnt/0/openmpi-mca-params.conf
