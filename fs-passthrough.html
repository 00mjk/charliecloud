

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Filesystem passthrough &mdash; Charliecloud 0.1.5 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Charliecloud 0.1.5 documentation" href="index.html"/>
        <link rel="next" title="5. Image configuration" href="image-setup.html"/>
        <link rel="prev" title="3. Networking" href="networking.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> Charliecloud
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing Charliecloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="install.html#installing-on-linux">1.1. Installing on Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="install.html#miscellaneous-supporting-software">1.1.1. Miscellaneous supporting software</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#charliecloud-itself">1.1.2. Charliecloud itself</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#kvm-hypervisor">1.1.3. KVM hypervisor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="install.html#cpu-support">1.1.3.1. CPU support</a></li>
<li class="toctree-l4"><a class="reference internal" href="install.html#bios-support">1.1.3.2. BIOS support</a></li>
<li class="toctree-l4"><a class="reference internal" href="install.html#dev-kvm-permissions">1.1.3.3. <code class="code docutils literal"><span class="pre">/dev/kvm</span></code> permissions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="install.html#qemu">1.1.4. QEMU</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#your-first-virtual-cluster">2.1. Your first virtual cluster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#getting-help">2.1.1. Getting help</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-the-virtual-network">2.1.2. Starting the virtual network</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-virtual-cluster">2.1.3. Starting a virtual cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#logging-in">2.1.4. Logging in</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#filesystems">2.1.5. Filesystems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#root-filesystem">2.1.5.1. Root filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-tmp">2.1.5.2. <code class="code docutils literal"><span class="pre">/ch/tmp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-meta">2.1.5.3. <code class="code docutils literal"><span class="pre">/ch/meta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#ch-opt">2.1.5.4. <code class="code docutils literal"><span class="pre">/ch/opt</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#contents-of-the-job-directory">2.1.6. Contents of the job directory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#meta">2.1.6.1. <code class="code docutils literal"><span class="pre">meta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#run">2.1.6.2. <code class="code docutils literal"><span class="pre">run</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#out">2.1.6.3. <code class="code docutils literal"><span class="pre">out</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#network-topology">2.1.7. Network topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#ssh">2.1.8. SSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#shut-the-cluster-down">2.1.9. Shut the cluster down</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#your-first-virtual-job">2.2. Your first virtual job</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-cluster-with-less-clutter">2.2.1. Starting a cluster with less clutter</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#users-groups-and-permissions-under-filesystem-passthrough">2.2.2. Users, groups, and permissions under filesystem passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#running-mpihello-in-interactive-mode">2.2.3. Running <code class="code docutils literal"><span class="pre">mpihello</span></code> in interactive mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#running-mpihello-in-batch-mode">2.2.4. Running <code class="code docutils literal"><span class="pre">mpihello</span></code> in batch mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#installing-your-own-software">2.3. Installing your own software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#starting-a-vm-with-persistent-root-filesystem">2.3.1. Starting a VM with persistent root filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#installing-software">2.3.2. Installing software</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">3. Networking</a><ul>
<li class="toctree-l2"><a class="reference internal" href="networking.html#network-addresses">3.1. Network addresses</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#ip-addresses">3.1.1. IP addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#mac-addresses">3.1.2. MAC addresses</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#topology">3.2. Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#workstation-mode">3.3. Workstation mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#requirements">3.3.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#topology-implementation">3.3.2. Topology implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#security">3.3.3. Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking.html#mac-and-ip-spoofing">3.3.3.1. MAC and IP spoofing</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#inbound-network-access">3.3.3.2. Inbound network access</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#risks">3.3.3.3. Risks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#cluster-mode">3.4. Cluster mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id1">3.4.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id2">3.4.2. Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#id3">3.4.3. Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking.html#id4">3.4.3.1. MAC and IP spoofing</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#guest-isolation">3.4.3.2. Guest isolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking.html#id5">3.4.3.3. Risks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking.html#cluster-mode-faq">3.4.4. Cluster mode FAQ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html#resources">3.5. Resources</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">4. Filesystem passthrough</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#uncoordinated-uids-and-gids">4.1. Uncoordinated UIDs and GIDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#potential-solutions">4.2. Potential solutions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#security-model-mapped">4.2.1. <code class="code docutils literal"><span class="pre">security_model=mapped</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-jobs-as-root">4.2.2. Run jobs as root</a></li>
<li class="toctree-l3"><a class="reference internal" href="#turn-off-guest-permission-checks-on-passthrough-filesystem">4.2.3. Turn off guest permission checks on passthrough filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mount-with-uid-foo-gid-bar">4.2.4. Mount with <code class="code docutils literal"><span class="pre">uid=foo</span></code>, <code class="code docutils literal"><span class="pre">gid=bar</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#bindfs">4.2.5. bindfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fsuid-and-fsgid">4.2.6. <code class="code docutils literal"><span class="pre">fsuid</span></code> and <code class="code docutils literal"><span class="pre">fsgid</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#import-users-and-groups-from-host">4.2.7. Import users and groups from host</a></li>
<li class="toctree-l3"><a class="reference internal" href="#change-uid-before-running-job">4.2.8. Change UID before running job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-host-groups-before-running-job">4.2.9. Add host groups before running job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#solution-implemented-in-charliecloud">4.3. Solution implemented in Charliecloud</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="image-setup.html">5. Image configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#booting-an-installer-overview">5.1. Booting an installer overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#during-install">5.2. During install</a></li>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#after-install">5.3. After install</a><ul>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#console-and-friends">5.3.1. Console and friends</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#filesystem">5.3.2. Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#network">5.3.3. Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#users-and-groups">5.3.4. Users and groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="image-setup.html#misc">5.3.5. Misc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="image-setup.html#notes-on-systemd-based-distros">5.4. Notes on <code class="code docutils literal"><span class="pre">systemd</span></code>-based distros</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">6. Testing Charliecloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="testing.html#non-interactive-testing">6.1. Non-interactive testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html#interactive-testing">6.2. Interactive testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="script-help.html">7. Script help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#newimage">7.1. newimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#oneguest">7.2. oneguest</a></li>
<li class="toctree-l2"><a class="reference internal" href="script-help.html#vcluster">7.3. vcluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">8. Frequently asked questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="faq.html#error-and-warning-messages">8.1. Error and warning messages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#p-could-not-find-request-transport-virtio">8.1.1. 9p: Could not find request transport: virtio</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#p-no-channels-available">8.1.2. 9p: no channels available</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#job-script-hard-link-failed-copying-instead">8.1.3. job script hard link failed, copying instead</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#mount-unknown-filesystem-type-9p">8.1.4. mount: unknown filesystem type &#8216;9p&#8217;</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#o-direct-unsupported">8.1.5. O_DIRECT unsupported</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#serial8250-too-much-work-for-irq4">8.1.6. serial8250: too much work for irq4</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vde-switch-could-not-remove-ctl-dir">8.1.7. vde_switch: Could not remove ctl dir</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vlan-0-is-not-connected-to-host-network">8.1.8. vlan 0 is not connected to host network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#something-doesn-t-work">8.2. Something doesn&#8217;t work</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#i-can-t-ping-the-outside-world-but-it-s-reachable-by-other-network-stuff">8.2.1. I can&#8217;t ping the outside world, but it&#8217;s reachable by other network stuff</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#intermittent-connectivity-problems-between-guests">8.2.2. Intermittent connectivity problems between guests</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#testing-failed-because-orted-is-listening-to-some-port">8.2.3. Testing failed because orted is listening to some port</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vga-console-won-t-relinquish-mouse-grab">8.2.4. VGA console won&#8217;t relinquish mouse grab</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#vga-console-does-not-show-the-whole-screen">8.2.5. VGA console does not show the whole screen</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#configuration">8.3. Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="faq.html#how-can-i-tell-if-i-m-using-the-faster-virtio-drivers">8.3.1. How can I tell if I&#8217;m using the faster virtio drivers?</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html#how-can-i-persist-the-root-filesystem-without-vcluster-commit">8.3.2. How can I persist the root filesystem without <code class="code docutils literal"><span class="pre">vcluster</span> <span class="pre">--commit</span></code>?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">9. API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#the-job-directory">9.1. The job directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#filesystems-provided-to-the-guest">9.2. Filesystems provided to the guest</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api.html#metadata">9.2.1. Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#charliecloud-resources">9.2.2. Charliecloud resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#persistent-storage">9.2.3. Persistent storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#temporary-storage">9.2.4. Temporary storage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="history.html">10. Version history</a><ul>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-5-2015-jun-16">10.1. v0.1.5, 2015-Jun-16</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-4-2015-jun-04">10.2. v0.1.4, 2015-Jun-04</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-3-2015-apr-30">10.3. v0.1.3, 2015-Apr-30</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-2-2015-feb-09">10.4. v0.1.2, 2015-Feb-09</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-1-2014-dec-01">10.5. v0.1.1, 2014-Dec-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#v0-1-0-2014-sep-30">10.6. v0.1.0, 2014-Sep-30</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Charliecloud</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>4. Filesystem passthrough</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="filesystem-passthrough">
<h1>4. Filesystem passthrough<a class="headerlink" href="#filesystem-passthrough" title="Permalink to this headline">¶</a></h1>
<p>QEMU offers a very nice feature of filesystem passthrough: selected
directories on the host can be mounted in the guest. Then, the unprivileged
QEMU process acts on behalf of the guest to perform the desired options.</p>
<p>This file contains a very detailed description of how filesystem passthrough
works in Charliecloud, along with reasoning for various choices. You probably
don&#8217;t need to read it if you just want to use Charliecloud.</p>
<p>Communication between the guest and QEMU uses the <a class="reference external" href="https://www.kernel.org/doc/Documentation/filesystems/9p.txt">9P protocol</a> over the
<code class="code docutils literal"><span class="pre">virtio</span></code> transport. There is an <a class="reference external" href="http://www.landley.net/kdocs/ols/2010/ols2010-pages-109-120.pdf">overview paper</a> which
describes the process as it stood in 2010.</p>
<p>Importantly, because the QEMU process runs as the user who invoked it, even
privileged users within the guest have the same access to host files as the
unprivileged invoking host user does. That is, root access to filesystems
applies only to filesystems wholly within the guest (e.g., a virtual block
device with a filesystem on it) and can&#8217;t leak out.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#uncoordinated-uids-and-gids" id="id1">Uncoordinated UIDs and GIDs</a></li>
<li><a class="reference internal" href="#potential-solutions" id="id2">Potential solutions</a><ul>
<li><a class="reference internal" href="#security-model-mapped" id="id3"><code class="code docutils literal"><span class="pre">security_model=mapped</span></code></a></li>
<li><a class="reference internal" href="#run-jobs-as-root" id="id4">Run jobs as root</a></li>
<li><a class="reference internal" href="#turn-off-guest-permission-checks-on-passthrough-filesystem" id="id5">Turn off guest permission checks on passthrough filesystem</a></li>
<li><a class="reference internal" href="#mount-with-uid-foo-gid-bar" id="id6">Mount with <code class="code docutils literal"><span class="pre">uid=foo</span></code>, <code class="code docutils literal"><span class="pre">gid=bar</span></code></a></li>
<li><a class="reference internal" href="#bindfs" id="id7">bindfs</a></li>
<li><a class="reference internal" href="#fsuid-and-fsgid" id="id8"><code class="code docutils literal"><span class="pre">fsuid</span></code> and <code class="code docutils literal"><span class="pre">fsgid</span></code></a></li>
<li><a class="reference internal" href="#import-users-and-groups-from-host" id="id9">Import users and groups from host</a></li>
<li><a class="reference internal" href="#change-uid-before-running-job" id="id10">Change UID before running job</a></li>
<li><a class="reference internal" href="#add-host-groups-before-running-job" id="id11">Add host groups before running job</a></li>
</ul>
</li>
<li><a class="reference internal" href="#solution-implemented-in-charliecloud" id="id12">Solution implemented in Charliecloud</a></li>
</ul>
</div>
<div class="section" id="uncoordinated-uids-and-gids">
<h2><a class="toc-backref" href="#id1">4.1. Uncoordinated UIDs and GIDs</a><a class="headerlink" href="#uncoordinated-uids-and-gids" title="Permalink to this headline">¶</a></h2>
<p>There is some black magic involved, however. Among other things, UIDs and GIDs
are not shared between host and guest, and the 9P driver does not re-map any
UIDs or GIDs. This leads to some strange behavior because both guest and host
are applying independent permissions checks. For example, a simple <code class="code docutils literal"><span class="pre">ls</span></code>
on the host:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> ls -n
<span class="go">-rw-rw---- 1 1001 1001 10 May 16 14:06 bar</span>
<span class="go">-rw-rw---- 1    0    0 10 May 16 14:06 foo</span>
<span class="gp">$</span> ls -l
<span class="go">-rw-rw---- 1 reidpr reidpr 10 May 16 14:06 bar</span>
<span class="go">-rw-rw---- 1 root   root   10 May 16 14:06 foo</span>
</pre></div>
</div>
<p>Guest, same directory:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> ls -n
<span class="go">-rw-rw---- 1 1001 1001 10 May 16 14:06 bar</span>
<span class="go">-rw-rw---- 1    0    0 10 May 16 14:06 foo</span>
<span class="gp">&gt;</span> ls -l
<span class="go">-rw-rw---- 1 1001 1001 10 May 16 14:06 bar</span>
<span class="go">-rw-rw---- 1 root root 10 May 16 14:06 foo</span>
</pre></div>
</div>
<p>The listings are the same with <code class="code docutils literal"><span class="pre">-n</span></code> (i.e., <code class="code docutils literal"><span class="pre">--numeric-uid-gid</span></code>),
but they differ with the more typical <code class="code docutils literal"><span class="pre">-l</span></code>. The file <code class="code docutils literal"><span class="pre">foo</span></code> shows
up as expected in the guest, because <code class="code docutils literal"><span class="pre">root:root</span></code> has the same UID (0)
and GID (0) in both host and guest. However, <code class="code docutils literal"><span class="pre">bar</span></code> is different. This is
because the file is owned by <code class="code docutils literal"><span class="pre">reidpr:reidpr</span></code> (UID 1001, GID 1001) on the
host, but in the guest we are running as the job user <code class="code docutils literal"><span class="pre">charlie</span></code>, UID
65530, and there is no guest user with UID 1001. Linux therefore displays the
UID because no user can be found.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Further confusion can occur if there is in fact a guest user with UID 1001;
in this case, the guest OS will think that user owns the files. We will not
explore this scenario more deeply, though it&#8217;s important to be aware of
it.</p>
</div>
<p>Let&#8217;s try to access those two files as unprivileged <code class="code docutils literal"><span class="pre">charlie</span></code> within
the guest:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> whoami
<span class="go">charlie</span>
<span class="gp">&gt;</span> cat foo
<span class="go">cat: foo: Permission denied</span>
<span class="gp">&gt;</span> cat bar
<span class="go">cat: bar: Permission denied</span>
</pre></div>
</div>
<p>The first result is expected; the host user <code class="code docutils literal"><span class="pre">reidpr</span></code> cannot read this
file. However, the second is surprising: <code class="code docutils literal"><span class="pre">reidpr</span></code> can read this file.
The problem is that the guest kernel interprets the permissions, sees
that the file is only readable by UID=1001 or GID=1001, neither of which
apply to <code class="code docutils literal"><span class="pre">charlie</span></code>, and so it denies access.</p>
<p>We can try the same as guest root:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> sudo cat foo
<span class="go">cat: foo: Permission denied</span>
<span class="gp">&gt;</span> sudo cat bar
<span class="go">hello bar</span>
</pre></div>
</div>
<p>In this case, it&#8217;s <code class="code docutils literal"><span class="pre">cat</span> <span class="pre">foo</span></code> that&#8217;s a little surprising. Going by the
output of <code class="code docutils literal"><span class="pre">ls</span></code>, we should be able to read this file. After all,
<code class="code docutils literal"><span class="pre">sudo</span></code> makes us root, so we should be able to read any file. However,
the read request is also filtered by the host OS, where it fails: in the host,
recall that the whole virtual machine is running as <code class="code docutils literal"><span class="pre">reidpr</span></code>, who is not
allowed to read <code class="code docutils literal"><span class="pre">foo</span></code>. However, he is allowed to read <code class="code docutils literal"><span class="pre">bar</span></code>, so
that call succeeds.</p>
<p>We&#8217;ll explore two more examples. First, let&#8217;s create a file within the guest,
again as unprivileged <code class="code docutils literal"><span class="pre">charlie</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> <span class="nb">echo </span>hello baz &gt; baz
<span class="go">-bash: baz: Permission denied</span>
<span class="gp">&gt;</span> ls -ld
<span class="go">drwxrwsr-x 2 1001 1001 4096 May 16 11:17 .</span>
</pre></div>
</div>
<p>This again fails because the guest kernel sees that the directory is not
writeable by user <code class="code docutils literal"><span class="pre">charlie</span></code>.</p>
<p>One workaround is to make the directory world-writable. In these cases, one
also typically sets the <a class="reference external" href="http://en.wikipedia.org/wiki/Sticky_bit">sticky bit</a> on the directory; this means that
users cannot remove files they don&#8217;t own, even if the directory is otherwise
writeable. For example:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> ls -ld
<span class="go">drwxrwxrwt 6 root root 160 May 16 14:22 .</span>
<span class="gp">&gt;</span> <span class="nb">echo </span>hello baz &gt; baz
<span class="gp">&gt;</span> cat baz
<span class="go">hello baz</span>
<span class="gp">&gt;</span> ls -l
<span class="go">-rw-r--r-- 1 1001 1001 10 May 16 14:22 baz</span>
</pre></div>
</div>
<p>So far so good. Let&#8217;s continue:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">&gt;</span> rm -f baz
<span class="go">rm: cannot remove `baz&#39;: Operation not permitted</span>
<span class="gp">&gt;</span> sudo chmod <span class="m">666</span> baz
<span class="gp">&gt;</span> rm -f baz
<span class="go">rm: cannot remove `baz&#39;: Operation not permitted</span>
</pre></div>
</div>
<p>Well, that&#8217;s awkward. We just created a file and can&#8217;t delete it, even though
the directory is world-writeable and we made the file world-writeable? This is
where the sticky bit comes in. Because the file is really created by QEMU on
the host, with owner 1001:1001 (i.e., <code class="code docutils literal"><span class="pre">reidpr:reidpr</span></code>), the guest OS
thinks we don&#8217;t own it and therefore can&#8217;t delete it despite the broad write
permissions, because of the sticky bit (denoted by the final <code class="code docutils literal"><span class="pre">t</span></code> in the
directory permissions).</p>
<p>Here&#8217;s another good one:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> touch qux
<span class="go">touch: setting times of `qux&#39;: Permission denied</span>
<span class="gp">$</span> ls -l
<span class="go">-rw-r--r-- 1 1001 1001 10 May 16 14:22 baz</span>
<span class="go">-rw-r--r-- 1 1001 1001  0 May 16 14:24 qux</span>
</pre></div>
</div>
<p>I bet you haven&#8217;t seen that error before. The file was created, but the
system call to set timestamps failed. Here&#8217;s why:</p>
<ol class="arabic simple">
<li>Create file; approved by both guest and host OS.</li>
<li>Because the file is really created by the QEMU process on the host, it gets
the default <code class="code docutils literal"><span class="pre">reidpr:reidpr</span></code> ownership, a.k.a. UID 1001, GID 1001.</li>
<li>Change file&#8217;s timestamp. This is rejected by the guest OS because we are
trying to change the time of a file we don&#8217;t own. (The host OS would
approve this; that is, the operation would work if we were root in the
guest.)</li>
</ol>
<p><strong>The bottom line is:</strong> We have two operating systems enforcing permissions
using uncoordinated UID and GID sets. This leads to undesirable results. We
want jobs to be able to run unprivileged in the guest with a minimum of hassle
and without bizarre side effects.</p>
</div>
<div class="section" id="potential-solutions">
<h2><a class="toc-backref" href="#id2">4.2. Potential solutions</a><a class="headerlink" href="#potential-solutions" title="Permalink to this headline">¶</a></h2>
<p>There are a wide variety of potential solutions to this problem. Our
goals are to:</p>
<ul class="simple">
<li>Focus changes on the host side, to simplify setting up guest images. (The
former happens once, while the latter may happen many times.)</li>
<li>Minimize the leakiness of the abstraction from the user&#8217;s perspective. It
should &#8220;just work&#8221;.</li>
<li>Maximize separation between host and guest, to allow greatest flexibility on
the guest side as well as reduce security exposure.</li>
<li>Don&#8217;t screw things up within the guest. (For example, the job user needs to
always have access to his/her home directory.)</li>
</ul>
<p>The following subsections list potential solutions in no particular order.</p>
<div class="section" id="security-model-mapped">
<h3><a class="toc-backref" href="#id3">4.2.1. <code class="code docutils literal"><span class="pre">security_model=mapped</span></code></a><a class="headerlink" href="#security-model-mapped" title="Permalink to this headline">¶</a></h3>
<p>QEMU has two &#8220;security models&#8221; where filesystem metadata operations are not
exported to the host but rather stored in a special place where only guests
can see them, either extended attributes (<code class="code docutils literal"><span class="pre">mapped-xattr</span></code>) or hidden
directories (<code class="code docutils literal"><span class="pre">mapped-file</span></code>).</p>
<p>This solves most of the problems above, but only for files and directories
created within the guest. If externally created files are important, as they
are for Charliecloud, then it doesn&#8217;t help much.</p>
<p>Attribute storage is also somewhat brittle, as extended attributes are ignored
by many tools, and the hidden directory attributes are by filename and thus
can be messed up by changes on the host side.</p>
<p>This also screws up symbolic links.</p>
</div>
<div class="section" id="run-jobs-as-root">
<h3><a class="toc-backref" href="#id4">4.2.2. Run jobs as root</a><a class="headerlink" href="#run-jobs-as-root" title="Permalink to this headline">¶</a></h3>
<p>This solves the clashing permission models problem, and it&#8217;s a reasonable
thing to do security-wise because privileges are sandboxed inside the guest,
but it&#8217;s bad hygiene in general and risks screwing up the guest.</p>
</div>
<div class="section" id="turn-off-guest-permission-checks-on-passthrough-filesystem">
<h3><a class="toc-backref" href="#id5">4.2.3. Turn off guest permission checks on passthrough filesystem</a><a class="headerlink" href="#turn-off-guest-permission-checks-on-passthrough-filesystem" title="Permalink to this headline">¶</a></h3>
<p>In principle, the guest kernel could be told to ignore permissions on the
passthrough filesystem. However, this does not appear to be currently possible
in practice.</p>
</div>
<div class="section" id="mount-with-uid-foo-gid-bar">
<h3><a class="toc-backref" href="#id6">4.2.4. Mount with <code class="code docutils literal"><span class="pre">uid=foo</span></code>, <code class="code docutils literal"><span class="pre">gid=bar</span></code></a><a class="headerlink" href="#mount-with-uid-foo-gid-bar" title="Permalink to this headline">¶</a></h3>
<p>Some filesystems can be mounted with remapped UID and GID specified as a mount
option. However, this seems to be only available for filesystems that don&#8217;t
have any inherent notion of ownership, such as VFAT.</p>
<p>This is likely a fairly straightforward patch to QEMU or the kernel.</p>
<p>If it were possible, there might be problems with managing groups from within
the guest.</p>
</div>
<div class="section" id="bindfs">
<h3><a class="toc-backref" href="#id7">4.2.5. bindfs</a><a class="headerlink" href="#bindfs" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal"><span class="pre">bindfs</span></code> is a FUSE driver which can re-mount a filesystem with various
manipulations including UID/GID remapping.</p>
<p>However, it has a major performance impact, on the order of 75% in <a class="reference external" href="http://www.redbottledesign.com/blog/mirroring-files-different-places-links-bind-mounts-and-bindfs">one test</a>.</p>
</div>
<div class="section" id="fsuid-and-fsgid">
<h3><a class="toc-backref" href="#id8">4.2.6. <code class="code docutils literal"><span class="pre">fsuid</span></code> and <code class="code docutils literal"><span class="pre">fsgid</span></code></a><a class="headerlink" href="#fsuid-and-fsgid" title="Permalink to this headline">¶</a></h3>
<p>Linux actually has a fourth set of active UID and GID for users, called
<code class="code docutils literal"><span class="pre">fsuid</span></code> and <code class="code docutils literal"><span class="pre">fsgid</span></code>, short for <em>filesystem user id</em> and <em>group
id</em>. These are used for filesystem interactions. Apparently they were used for
historic NFS implementations but not otherwise.</p>
<p>They are obscure and have weak userspace support. Setting them requires a
system call. We could do this with a short C wrapper for jobs.</p>
</div>
<div class="section" id="import-users-and-groups-from-host">
<h3><a class="toc-backref" href="#id9">4.2.7. Import users and groups from host</a><a class="headerlink" href="#import-users-and-groups-from-host" title="Permalink to this headline">¶</a></h3>
<p>This removes the problem by making the guest and hosts users and groups match.
Then, the two permissions checks will give the same result.</p>
<p>Problems:</p>
<ul class="simple">
<li>Guest users and groups must be kept up to date.</li>
<li>Must deal with system users and groups that shouldn&#8217;t be synced.</li>
<li>Some properties shouldn&#8217;t be synced.</li>
<li>Hosts vary. For example, LDAP is often consistent institution-wide, but
workstations aren&#8217;t always consistent between themselves or with LDAP.
Guests can be moved between the two zones.</li>
</ul>
</div>
<div class="section" id="change-uid-before-running-job">
<h3><a class="toc-backref" href="#id10">4.2.8. Change UID before running job</a><a class="headerlink" href="#change-uid-before-running-job" title="Permalink to this headline">¶</a></h3>
<p>A dynamic variation on the above. Change the job user&#8217;s UID to match the host
UID before running the job.</p>
<p>There are several drawbacks/risks:</p>
<ol class="arabic">
<li><p class="first">Screwing up the guest. The job user needs to retain access to its home
directory and any other owned files; changing the UID breaks that. It is
impractical to comprehensively <code class="code docutils literal"><span class="pre">chown</span></code> all files in the guest each
time a job is run.</p>
<p>One workaround is to have two users, say <code class="code docutils literal"><span class="pre">charlie</span></code> and
<code class="code docutils literal"><span class="pre">chextern</span></code>, one for general non-privileged use and one for running
jobs; the latter&#8217;s UID is the one that&#8217;s adjusted. It could even be
re-named to match the host username.</p>
<p>With some group finesse (e.g., placing the two users in one another&#8217;s <a class="reference external" href="https://wiki.debian.org/UserPrivateGroups">user
private groups</a>), the two can
probably access one another&#8217;s files with few problems.</p>
</li>
<li><p class="first">This does not help in the situation where access is granted by host group
rather than host user.</p>
</li>
<li><p class="first">The non-adjusted UID (i.e., <code class="code docutils literal"><span class="pre">charlie</span></code>) might coincidentally be the
same as the host UID. The probability of this happening can be reduced by
choosing a UID unlikely to be in use.</p>
</li>
<li><p class="first">Files created by <code class="code docutils literal"><span class="pre">charlie</span></code> on the passthrough filesystems will still
be owned by <code class="code docutils literal"><span class="pre">chextern</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="add-host-groups-before-running-job">
<h3><a class="toc-backref" href="#id11">4.2.9. Add host groups before running job</a><a class="headerlink" href="#add-host-groups-before-running-job" title="Permalink to this headline">¶</a></h3>
<p>Similarly, groups matching the host user&#8217;s groups could be added, and the job
user added to those groups, before the job runs.</p>
<p>The job user should not be added to any system groups. For example, on my
workstation, I&#8217;m in group <code class="code docutils literal"><span class="pre">libvirtd</span></code> (gid=133), which shouldn&#8217;t be
imported (recall, however, that any privilege escalation within the guest is
limited by the VM sandbox). This can be mitigated by excluding system groups.</p>
<p>As this augments rather than replaces existing guest configuration, the risk
of screwing up the guest is minimal.</p>
</div>
</div>
<div class="section" id="solution-implemented-in-charliecloud">
<h2><a class="toc-backref" href="#id12">4.3. Solution implemented in Charliecloud</a><a class="headerlink" href="#solution-implemented-in-charliecloud" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is a design document and is not necessarily kept up to date. Refer to
the Charliecloud source code for what is actually done now.</p>
</div>
<ol class="arabic simple">
<li>Guests have a secondary job user whose UID is adjusted on each boot to
match the invoking host user. (The username is not adjusted so that it can
be referred to.) Thus, at least for files owned by the invoking host user,
ownership will appear correct.</li>
<li>The secondary job user&#8217;s primary group is similarly adjusted to match the
GID and name of the invoking user&#8217;s primary group. The primary job user
<code class="code docutils literal"><span class="pre">charlie</span></code> is a member of this group.</li>
<li>Other groups the host user is in are added and adjusted as described above.
Both the primary and secondary job users are added to these groups.</li>
</ol>
<p>The result is that owner and group will appear correct inside the guest
for files owned by the invoking host user and whose group is a group
this user is in, respectively.</p>
<p>The bottom line is, users should log into the guests as <code class="code docutils literal"><span class="pre">charlie</span></code>, and
jobs run as <code class="code docutils literal"><span class="pre">charlie</span></code>. If users set up group access properly on the host
side &#8212; group permissions equal to user permissions, which doesn&#8217;t
necessarily reduce security since file groups can be the user-private group
&#8212; then <code class="code docutils literal"><span class="pre">charlie</span></code> will be able to do everything necessary to run jobs.
Some situations (e.g., <code class="code docutils literal"><span class="pre">chmod</span></code>) require <code class="code docutils literal"><span class="pre">su</span></code>’ing to
<code class="code docutils literal"><span class="pre">chextern</span></code>.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="image-setup.html" class="btn btn-neutral float-right" title="5. Image configuration" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="networking.html" class="btn btn-neutral" title="3. Networking" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014–2015, Los Alamos National Security, LLC.
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>